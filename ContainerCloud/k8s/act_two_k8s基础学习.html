<!doctype html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.12" />
    <meta name="theme" content="VuePress Theme Hope 2.0.0-rc.47" />
    <style>
      html {
        background: var(--bg-color, #fff);
      }

      html[data-theme="dark"] {
        background: var(--bg-color, #1d1e1f);
      }

      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <meta property="og:url" content="https://www.bugcode.online/ContainerCloud/k8s/act_two_k8s%E5%9F%BA%E7%A1%80%E5%AD%A6%E4%B9%A0.html"><meta property="og:site_name" content="bugcode 的架构之路"><meta property="og:title" content="3、K8S基础学习"><meta property="og:description" content="3、K8S基础学习 1.1 kubernetes组件 一个kubernetes集群主要是由控制节点(master)、**工作节点(node)**构成，每个节点上都会安装不同的组件。 master：集群的控制平面，负责集群的决策 ( 管理 ) ApiServer : 资源操作的唯一入口，接收用户输入的命令，提供认证、授权、API注册和发现等机制 Sche..."><meta property="og:type" content="article"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2024-08-13T07:13:35.000Z"><meta property="article:author" content="bugcode"><meta property="article:tag" content="DOCKER"><meta property="article:tag" content="云原生"><meta property="article:tag" content="K8S"><meta property="article:published_time" content="2020-01-01T00:00:00.000Z"><meta property="article:modified_time" content="2024-08-13T07:13:35.000Z"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"3、K8S基础学习","image":[""],"datePublished":"2020-01-01T00:00:00.000Z","dateModified":"2024-08-13T07:13:35.000Z","author":[{"@type":"Person","name":"bugcode"}]}</script><meta name="robots" content="all"><meta name="author" content="bugcode"><meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"><meta http-equiv="Pragma" content="no-cache"><meta http-equiv="Expires" content="0"><meta name="keywords" content="Java, Java基础, 并发编程, JVM, 虚拟机, 数据库, MySQL, Spring, Redis, MyBatis, SpringBoot, IDEA, 求职面试, 面渣逆袭, 学习路线"><meta name="apple-mobile-web-app-capable" content="yes"><script>
        var _hmt = _hmt || [];
        (function() {
          var hm = document.createElement("script");
          hm.src = "https://hm.baidu.com/hm.js?5230ac143650bf5eb3c14f3fb9b1d3ec";
          var s = document.getElementsByTagName("script")[0]; 
          s.parentNode.insertBefore(hm, s);
        })();
      </script><link rel="stylesheet" href="//at.alicdn.com/t/c/font_4570931_i3acfllzyt.css"><link rel="manifest" href="/manifest.webmanifest" crossorigin="use-credentials"><meta name="theme-color" content="#46bd87"><title>3、K8S基础学习 | bugcode 的架构之路</title><meta name="description" content="3、K8S基础学习 1.1 kubernetes组件 一个kubernetes集群主要是由控制节点(master)、**工作节点(node)**构成，每个节点上都会安装不同的组件。 master：集群的控制平面，负责集群的决策 ( 管理 ) ApiServer : 资源操作的唯一入口，接收用户输入的命令，提供认证、授权、API注册和发现等机制 Sche...">
    <link rel="stylesheet" href="/assets/css/styles.6b04e72b.css">
    <link rel="preload" href="/assets/js/runtime~app.21e21f5e.js" as="script"><link rel="preload" href="/assets/css/styles.6b04e72b.css" as="style"><link rel="preload" href="/assets/js/9547.c8ff98a9.js" as="script"><link rel="preload" href="/assets/js/app.40c417f0.js" as="script">
    
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="vp-skip-link sr-only">跳至主要內容</a><!--]--><div class="theme-container external-link-icon has-toc"><!--[--><header id="navbar" class="vp-navbar"><div class="vp-navbar-start"><button type="button" class="vp-toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!----><!--[--><a class="route-link vp-brand" href="/"><img class="vp-nav-logo" src="https://vscodepic.oss-cn-beijing.aliyuncs.com/blog/log.jpg" alt><!----><span class="vp-site-name hide-in-pad">bugcode 的架构之路</span></a><!--]--><!----></div><div class="vp-navbar-center"><!----><!--[--><nav class="vp-nav-links"><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/" aria-label="主页"><!--[--><span class="font-icon icon iconfont icon-home" style=""></span><!--]-->主页<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/introduction/introducted.html" aria-label="导读"><!--[--><span class="font-icon icon iconfont icon-book" style=""></span><!--]-->导读<!----></a></div><div class="vp-nav-item hide-in-mobile"><div class="vp-dropdown-wrapper"><button type="button" class="vp-dropdown-title" aria-label="算法"><!--[--><span class="font-icon icon iconfont icon-pen-to-square" style=""></span>算法<!--]--><span class="arrow"></span><ul class="vp-dropdown"><li class="vp-dropdown-item"><a class="route-link auto-link" href="/algorithm/algor/" aria-label="算法专题"><!--[--><span class="font-icon icon iconfont icon-pen-to-square" style=""></span><!--]-->算法专题<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/algorithm/dataStructure/" aria-label="数据结构专题"><!--[--><span class="font-icon icon iconfont icon-pen-to-square" style=""></span><!--]-->数据结构专题<!----></a></li></ul></button></div></div><div class="vp-nav-item hide-in-mobile"><div class="vp-dropdown-wrapper"><button type="button" class="vp-dropdown-title" aria-label="设计模式"><!--[--><span class="font-icon icon iconfont icon-pen-to-square" style=""></span>设计模式<!--]--><span class="arrow"></span><ul class="vp-dropdown"><li class="vp-dropdown-item"><a class="route-link auto-link" href="/designpattern/designPrinciple/" aria-label="设计原则"><!--[--><span class="font-icon icon iconfont icon-pen-to-square" style=""></span><!--]-->设计原则<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/designpattern/creational/" aria-label="创建型"><!--[--><span class="font-icon icon iconfont icon-pen-to-square" style=""></span><!--]-->创建型<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/designpattern/Behavior/" aria-label="行为型"><!--[--><span class="font-icon icon iconfont icon-pen-to-square" style=""></span><!--]-->行为型<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/designpattern/structural/" aria-label="结构型"><!--[--><span class="font-icon icon iconfont icon-pen-to-square" style=""></span><!--]-->结构型<!----></a></li></ul></button></div></div><div class="vp-nav-item hide-in-mobile"><div class="vp-dropdown-wrapper"><button type="button" class="vp-dropdown-title" aria-label="源码"><!--[--><span class="font-icon icon iconfont icon-pen-to-square" style=""></span>源码<!--]--><span class="arrow"></span><ul class="vp-dropdown"><li class="vp-dropdown-item"><a class="route-link auto-link" href="/frameDesignAndSourceCode/springSourceCode/" aria-label="Spring源码实现"><!--[--><span class="font-icon icon iconfont icon-pen-to-square" style=""></span><!--]-->Spring源码实现<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/frameDesignAndSourceCode/mybatisSourceCode/" aria-label="Mybatis框架实现"><!--[--><span class="font-icon icon iconfont icon-pen-to-square" style=""></span><!--]-->Mybatis框架实现<!----></a></li></ul></button></div></div><div class="vp-nav-item hide-in-mobile"><div class="vp-dropdown-wrapper"><button type="button" class="vp-dropdown-title" aria-label="架构专题"><!--[--><span class="font-icon icon iconfont icon-pen-to-square" style=""></span>架构专题<!--]--><span class="arrow"></span><ul class="vp-dropdown"><li class="vp-dropdown-item"><a class="route-link auto-link" href="/engineeringArchitectureDesign/" aria-label="MVC和DDD"><!--[--><span class="font-icon icon iconfont icon-pen-to-square" style=""></span><!--]-->MVC和DDD<!----></a></li></ul></button></div></div><div class="vp-nav-item hide-in-mobile"><div class="vp-dropdown-wrapper"><button type="button" class="vp-dropdown-title" aria-label="精选博文"><!--[--><span class="font-icon icon iconfont icon-pen-to-square" style=""></span>精选博文<!--]--><span class="arrow"></span><ul class="vp-dropdown"><li class="vp-dropdown-item"><h4 class="vp-dropdown-subtitle">业务知识</h4><ul class="vp-dropdown-subitems"><li class="vp-dropdown-subitem"><a class="route-link auto-link" href="/excellentBook/business/" aria-label="金融业务"><!--[--><span class="font-icon icon iconfont icon-pen-to-square" style=""></span><!--]-->金融业务<!----></a></li></ul></li><li class="vp-dropdown-item"><h4 class="vp-dropdown-subtitle">项目经验</h4><ul class="vp-dropdown-subitems"><li class="vp-dropdown-subitem"><a class="route-link auto-link" href="/excellentBook/project/" aria-label="K8S部署项目"><!--[--><span class="font-icon icon iconfont icon-pen-to-square" style=""></span><!--]-->K8S部署项目<!----></a></li></ul></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/excellentBook/" aria-label="通用数据设计"><!--[--><span class="font-icon icon iconfont icon-pen-to-square" style=""></span><!--]-->通用数据设计<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/excellentBook/scence.html" aria-label="业务场景设计"><!--[--><span class="font-icon icon iconfont icon-pen-to-square" style=""></span><!--]-->业务场景设计<!----></a></li></ul></button></div></div><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/home.html" aria-label="基础归档"><!--[--><span class="font-icon icon iconfont icon-gaishu" style=""></span><!--]-->基础归档<!----></a></div><div class="vp-nav-item hide-in-mobile"><div class="vp-dropdown-wrapper"><button type="button" class="vp-dropdown-title" aria-label="面试篇"><!--[--><span class="font-icon icon iconfont icon-gaishu" style=""></span>面试篇<!--]--><span class="arrow"></span><ul class="vp-dropdown"><li class="vp-dropdown-item"><a class="route-link auto-link" href="/interview/TechnicalInterview/" aria-label="技术面经"><!--[--><span class="font-icon icon iconfont icon-pen-to-square" style=""></span><!--]-->技术面经<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/interview/Scenequestion/" aria-label="场景题"><!--[--><span class="font-icon icon iconfont icon-pen-to-square" style=""></span><!--]-->场景题<!----></a></li></ul></button></div></div><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/KnowledgePlanet/" aria-label="知识星球"><!--[--><span class="font-icon icon iconfont icon-gaishu" style=""></span><!--]-->知识星球<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/video/" aria-label="B站"><!--[--><span class="font-icon icon iconfont icon-gaishu" style=""></span><!--]-->B站<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/about/" aria-label="关于我"><!--[--><span class="font-icon icon iconfont icon-book" style=""></span><!--]-->关于我<!----></a></div></nav><!--]--><!----></div><div class="vp-navbar-end"><!----><!--[--><!----><div class="vp-nav-item vp-action"><a class="vp-action-link" href="https://github.com/justdoitMr/" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="github icon" name="github" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><div class="vp-nav-item hide-in-mobile"><button type="button" class="vp-outlook-button" tabindex="-1" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" class="icon outlook-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="outlook icon" name="outlook"><path d="M224 800c0 9.6 3.2 44.8 6.4 54.4 6.4 48-48 76.8-48 76.8s80 41.6 147.2 0 134.4-134.4 38.4-195.2c-22.4-12.8-41.6-19.2-57.6-19.2C259.2 716.8 227.2 761.6 224 800zM560 675.2l-32 51.2c-51.2 51.2-83.2 32-83.2 32 25.6 67.2 0 112-12.8 128 25.6 6.4 51.2 9.6 80 9.6 54.4 0 102.4-9.6 150.4-32l0 0c3.2 0 3.2-3.2 3.2-3.2 22.4-16 12.8-35.2 6.4-44.8-9.6-12.8-12.8-25.6-12.8-41.6 0-54.4 60.8-99.2 137.6-99.2 6.4 0 12.8 0 22.4 0 12.8 0 38.4 9.6 48-25.6 0-3.2 0-3.2 3.2-6.4 0-3.2 3.2-6.4 3.2-6.4 6.4-16 6.4-16 6.4-19.2 9.6-35.2 16-73.6 16-115.2 0-105.6-41.6-198.4-108.8-268.8C704 396.8 560 675.2 560 675.2zM224 419.2c0-28.8 22.4-51.2 51.2-51.2 28.8 0 51.2 22.4 51.2 51.2 0 28.8-22.4 51.2-51.2 51.2C246.4 470.4 224 448 224 419.2zM320 284.8c0-22.4 19.2-41.6 41.6-41.6 22.4 0 41.6 19.2 41.6 41.6 0 22.4-19.2 41.6-41.6 41.6C339.2 326.4 320 307.2 320 284.8zM457.6 208c0-12.8 12.8-25.6 25.6-25.6 12.8 0 25.6 12.8 25.6 25.6 0 12.8-12.8 25.6-25.6 25.6C470.4 233.6 457.6 220.8 457.6 208zM128 505.6C128 592 153.6 672 201.6 736c28.8-60.8 112-60.8 124.8-60.8-16-51.2 16-99.2 16-99.2l316.8-422.4c-48-19.2-99.2-32-150.4-32C297.6 118.4 128 291.2 128 505.6zM764.8 86.4c-22.4 19.2-390.4 518.4-390.4 518.4-22.4 28.8-12.8 76.8 22.4 99.2l9.6 6.4c35.2 22.4 80 12.8 99.2-25.6 0 0 6.4-12.8 9.6-19.2 54.4-105.6 275.2-524.8 288-553.6 6.4-19.2-3.2-32-19.2-32C777.6 76.8 771.2 80 764.8 86.4z"></path></svg><div class="vp-outlook-dropdown"><!----></div></button></div><!----><!--]--><!----><button type="button" class="vp-toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span><span class="vp-top"></span><span class="vp-middle"></span><span class="vp-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside id="sidebar" class="vp-sidebar"><!----><ul class="vp-sidebar-links"><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">一、导读</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">二、java核心</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">三、Spring篇</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">四、大数据篇</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable active" type="button"><!----><span class="vp-sidebar-title">五、云原生</span><span class="vp-arrow down"></span></button><ul class="vp-sidebar-links"><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">1、Docker</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable active" type="button"><!----><span class="vp-sidebar-title">2、K8S</span><span class="vp-arrow down"></span></button><ul class="vp-sidebar-links"><li><a class="route-link auto-link vp-sidebar-link vp-sidebar-page" href="/ContainerCloud/k8s/act_one_k8s%E4%B8%AD%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E5%8E%9F%E7%90%86.md.html" aria-label="1、K8s中负载均衡原理"><!--[--><span class="font-icon icon iconfont icon-file" style=""></span><!--]-->1、K8s中负载均衡原理<!----></a></li><li><a class="route-link auto-link vp-sidebar-link vp-sidebar-page" href="/ContainerCloud/k8s/act_none_pod%E5%BC%82%E5%B8%B8%E7%8A%B6%E6%80%81%E6%8E%92%E6%9F%A5.html" aria-label="2、Pod异常状态排错"><!--[--><span class="font-icon icon iconfont icon-file" style=""></span><!--]-->2、Pod异常状态排错<!----></a></li><li><a class="route-link route-link-active auto-link vp-sidebar-link vp-sidebar-page active" href="/ContainerCloud/k8s/act_two_k8s%E5%9F%BA%E7%A1%80%E5%AD%A6%E4%B9%A0.html" aria-label="3、K8S基础学习"><!--[--><span class="font-icon icon iconfont icon-file" style=""></span><!--]-->3、K8S基础学习<!----></a></li></ul></section></li></ul></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">五、前端篇</span><span class="vp-arrow end"></span></button><!----></section></li></ul><!----></aside><!--[--><main id="main-content" class="vp-page"><!--[--><!----><!----><nav class="vp-breadcrumb disable"></nav><div class="vp-page-title"><h1><span class="font-icon icon iconfont icon-file" style=""></span>3、K8S基础学习</h1><div class="page-info"><span class="page-author-info" aria-label="作者🖊" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon" name="author"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><span class="page-author-item">bugcode</span></span><span property="author" content="bugcode"></span></span><!----><span class="page-date-info" aria-label="写作日期📅" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon" name="calendar"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span><!----></span><meta property="datePublished" content="2020-01-01T00:00:00.000Z"></span><!----><span class="page-reading-time-info" aria-label="阅读时间⌛" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon" name="timer"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>大约 93 分钟</span><meta property="timeRequired" content="PT93M"></span><span class="page-category-info" aria-label="分类🌈" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon category-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="category icon" name="category"><path d="M148.41 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H148.41c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.311-40.31zM147.556 553.478H429.73c22.263 0 40.311 18.048 40.311 40.31v282.176c0 22.263-18.048 40.312-40.31 40.312H147.555c-22.263 0-40.311-18.049-40.311-40.312V593.79c0-22.263 18.048-40.311 40.31-40.311zM593.927 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H593.927c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.31-40.31zM730.22 920.502H623.926c-40.925 0-74.22-33.388-74.22-74.425V623.992c0-41.038 33.387-74.424 74.425-74.424h222.085c41.038 0 74.424 33.226 74.424 74.067v114.233c0 10.244-8.304 18.548-18.547 18.548s-18.548-8.304-18.548-18.548V623.635c0-20.388-16.746-36.974-37.33-36.974H624.13c-20.585 0-37.331 16.747-37.331 37.33v222.086c0 20.585 16.654 37.331 37.126 37.331H730.22c10.243 0 18.547 8.304 18.547 18.547 0 10.244-8.304 18.547-18.547 18.547z"></path></svg><!--[--><span class="page-category-item color0 clickable" role="navigation">K8S</span><span class="page-category-item color2 clickable" role="navigation">DOCKER</span><span class="page-category-item color5 clickable" role="navigation">JAVA</span><!--]--><meta property="articleSection" content="K8S,DOCKER,JAVA"></span><span class="page-tag-info" aria-label="标签🏷" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon tag-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="tag icon" name="tag"><path d="M939.902 458.563L910.17 144.567c-1.507-16.272-14.465-29.13-30.737-30.737L565.438 84.098h-.402c-3.215 0-5.726 1.005-7.634 2.913l-470.39 470.39a10.004 10.004 0 000 14.164l365.423 365.424c1.909 1.908 4.42 2.913 7.132 2.913s5.223-1.005 7.132-2.913l470.39-470.39c2.01-2.11 3.014-5.023 2.813-8.036zm-240.067-72.121c-35.458 0-64.286-28.828-64.286-64.286s28.828-64.285 64.286-64.285 64.286 28.828 64.286 64.285-28.829 64.286-64.286 64.286z"></path></svg><!--[--><span class="page-tag-item color2 clickable" role="navigation">DOCKER</span><span class="page-tag-item color5 clickable" role="navigation">云原生</span><span class="page-tag-item color0 clickable" role="navigation">K8S</span><!--]--><meta property="keywords" content="DOCKER,云原生,K8S"></span></div><hr></div><div class="vp-toc-placeholder"><aside id="toc"><!----><div class="vp-toc-header">此页内容<button type="button" class="print-button" title="打印"><svg xmlns="http://www.w3.org/2000/svg" class="icon print-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="print icon" name="print"><path d="M819.2 364.8h-44.8V128c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v236.8h-44.8C145.067 364.8 96 413.867 96 473.6v192c0 59.733 49.067 108.8 108.8 108.8h44.8V896c0 17.067 14.933 32 32 32h460.8c17.067 0 32-14.933 32-32V774.4h44.8c59.733 0 108.8-49.067 108.8-108.8v-192c0-59.733-49.067-108.8-108.8-108.8zM313.6 160h396.8v204.8H313.6V160zm396.8 704H313.6V620.8h396.8V864zM864 665.6c0 25.6-19.2 44.8-44.8 44.8h-44.8V588.8c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v121.6h-44.8c-25.6 0-44.8-19.2-44.8-44.8v-192c0-25.6 19.2-44.8 44.8-44.8h614.4c25.6 0 44.8 19.2 44.8 44.8v192z"></path></svg></button><div class="arrow end"></div></div><div class="vp-toc-wrapper"><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#_1-1-kubernetes组件">1.1 kubernetes组件</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#_1-2-kubernetes概念">1.2 kubernetes概念</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#_3-1-资源管理介绍">3.1 资源管理介绍</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#_3-2-yaml语言介绍">3.2 YAML语言介绍</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#_3-3-资源管理方式">3.3 资源管理方式</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_3-3-1-命令式对象管理">3.3.1 命令式对象管理</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_3-3-3-声明式对象配置">3.3.3 声明式对象配置</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#_4-1-namespace">4.1 Namespace</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#_4-2-pod">4.2 Pod</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#_4-3-label">4.3 Label</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#_4-4-deployment">4.4 Deployment</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#_4-5-service">4.5 Service</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#_5-1-pod介绍">5.1 Pod介绍</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_5-1-1-pod结构">5.1.1 Pod结构</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_5-1-2-pod定义">5.1.2 Pod定义</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#_5-2-pod配置">5.2 Pod配置</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_5-2-1-基本配置">5.2.1 基本配置</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_5-2-2-镜像拉取">5.2.2 镜像拉取</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_5-2-3-启动命令">5.2.3 启动命令</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_5-2-4-环境变量">5.2.4 环境变量</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_5-2-5-端口设置">5.2.5 端口设置</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_5-2-6-资源配额">5.2.6 资源配额</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#_5-3-pod生命周期">5.3 Pod生命周期</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_5-3-1-创建和终止">5.3.1 创建和终止</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_5-3-2-初始化容器">5.3.2 初始化容器</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_5-3-3-钩子函数">5.3.3 钩子函数</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_5-3-4-容器探测">5.3.4 容器探测</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_5-3-5-重启策略">5.3.5 重启策略</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#_5-4-pod调度">5.4 Pod调度</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_5-4-1-定向调度【强制策略】">5.4.1 定向调度【强制策略】</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_5-4-2-亲和性调度">5.4.2 亲和性调度</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_5-4-3-污点和容忍">5.4.3 污点和容忍</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#_6-1-pod控制器介绍">6.1 Pod控制器介绍</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#_6-2-replicaset-rs">6.2 ReplicaSet(RS)</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#replicaset-demo">ReplicaSet Demo</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#扩缩容">扩缩容</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#镜像升级">镜像升级</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#删除replicaset">删除ReplicaSet</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#_6-3-deployment-deploy">6.3 Deployment(Deploy)</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#扩缩容-1">扩缩容</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#镜像更新">镜像更新</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#版本回退">版本回退</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#_6-4-horizontal-pod-autoscaler-hpa">6.4 Horizontal Pod Autoscaler(HPA)</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#_6-5-daemonset-ds">6.5 DaemonSet(DS)</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#_6-6-job">6.6 Job</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#_6-7-cronjob-cj">6.7 CronJob(CJ)</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#_7-1-service介绍">7.1 Service介绍</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#userspace-模式">userspace 模式</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#iptables-模式">iptables 模式</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#ipvs-模式">ipvs 模式</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#_7-2-service类型">7.2 Service类型</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#_7-3-service使用">7.3 Service使用</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_7-3-1-实验环境准备">7.3.1 实验环境准备</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_7-3-2-clusterip类型的service">7.3.2 ClusterIP类型的Service</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_7-3-3-headliness类型的service">7.3.3 HeadLiness类型的Service</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_7-3-4-nodeport类型的service">7.3.4 NodePort类型的Service</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_7-3-5-loadbalancer类型的service">7.3.5 LoadBalancer类型的Service</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_7-3-6-externalname类型的service">7.3.6 ExternalName类型的Service</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#_7-4-ingress介绍">7.4 Ingress介绍</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#_7-5-ingress使用">7.5 Ingress使用</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_7-5-1-环境准备">7.5.1 环境准备</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_7-5-2-http代理">7.5.2 Http代理</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_7-5-3-https代理">7.5.3 Https代理</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#_8-1-基本存储">8.1 基本存储</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_8-1-1-emptydir">8.1.1 EmptyDir</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_8-1-2-hostpath">8.1.2 HostPath</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_8-1-3-nfs">8.1.3 NFS</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#_8-2-高级存储">8.2 高级存储</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_8-2-1-pv">8.2.1 PV</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_8-2-2-pvc">8.2.2 PVC</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_8-2-3-生命周期">8.2.3 生命周期</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#_8-3-配置存储">8.3 配置存储</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_8-3-1-configmap">8.3.1 ConfigMap</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_8-3-2-secret">8.3.2 Secret</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#_9-1-访问控制概述">9.1 访问控制概述</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#_9-2-证管理">9.2 证管理</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#_9-3-授权管理">9.3 授权管理</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#_9-4-准入控制">9.4 准入控制</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#_10-1-部署dashboard">10.1 部署Dashboard</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#_10-2-使用dashboard">10.2 使用DashBoard</a></li><!----><!--]--></ul><div class="vp-toc-marker" style="top:-1.7rem;"></div></div><!----></aside></div><!----><div class="theme-hope-content"><h1 id="_3、k8s基础学习" tabindex="-1"><a class="header-anchor" href="#_3、k8s基础学习"><span>3、K8S基础学习</span></a></h1><h2 id="_1-1-kubernetes组件" tabindex="-1"><a class="header-anchor" href="#_1-1-kubernetes组件"><span>1.1 kubernetes组件</span></a></h2><p>一个kubernetes集群主要是由<strong>控制节点(master)</strong>、**工作节点(node)**构成，每个节点上都会安装不同的组件。<br><strong>master：集群的控制平面，负责集群的决策 ( 管理 )</strong></p><ul><li><strong>ApiServer</strong> : 资源操作的唯一入口，接收用户输入的命令，提供认证、授权、API注册和发现等机制</li><li><strong>Scheduler</strong> : 负责集群资源调度，按照预定的调度策略将Pod调度到相应的node节点上</li><li><strong>ControllerManager</strong> : 负责维护集群的状态，比如程序部署安排、故障检测、自动扩展、滚动更新等</li><li><strong>Etcd</strong> ：负责存储集群中各种资源对象的信息</li></ul><p><strong>node：集群的数据平面，负责为容器提供运行环境 ( 干活 )</strong></p><ul><li><strong>Kubelet</strong> : 负责维护容器的生命周期，即通过控制docker，来创建、更新、销毁容器</li><li><strong>KubeProxy</strong> : 负责提供集群内部的服务发现和负载均衡</li><li><strong>Docker</strong> : 负责节点上容器的各种操作</li></ul><h2 id="_1-2-kubernetes概念" tabindex="-1"><a class="header-anchor" href="#_1-2-kubernetes概念"><span>1.2 kubernetes概念</span></a></h2><p><strong>Pod</strong>：kubernetes的最小控制单元，容器都是运行在pod中的，一个pod中可以有1个或者多个容器<br><strong>Controller</strong>：控制器，通过它来实现对pod的管理，比如启动pod、停止pod、伸缩pod的数量等等<br><strong>Service</strong>：pod对外服务的统一入口，下面可以维护者同一类的多个pod<br><strong>Label</strong>：标签，用于对pod进行分类，同一类pod会拥有相同的标签<br><strong>NameSpace</strong>：命名空间，用来隔离pod的运行环境</p><h1 id="_2-部署" tabindex="-1"><a class="header-anchor" href="#_2-部署"><span>2. 部署</span></a></h1><p>见 <a href="http://xn--Linux-vm4i563njxto39a.md" target="_blank" rel="noopener noreferrer">Linux环境部署.md</a></p><h1 id="_3-资源管理" tabindex="-1"><a class="header-anchor" href="#_3-资源管理"><span>3. 资源管理</span></a></h1><h2 id="_3-1-资源管理介绍" tabindex="-1"><a class="header-anchor" href="#_3-1-资源管理介绍"><span>3.1 资源管理介绍</span></a></h2><p>在kubernetes中，所有的内容都抽象为资源，用户需要通过操作资源来管理kubernetes。<br> kubernetes的本质上就是一个集群系统，用户可以在集群中部署各种服务，所谓的部署服务，其实就是在kubernetes集群中运行一个个的容器，并将指定的程序跑在容器中。<br> kubernetes的最小管理单元是pod而不是容器，所以只能将容器放在Pod中，而kubernetes一般也不会直接管理Pod，而是通过Pod控制器来管理Pod的。<br> Pod可以提供服务之后，就要考虑如何访问Pod中服务，kubernetes提供了Service资源实现这个功能。<br> 当然，如果Pod中程序的数据需要持久化，kubernetes还提供了各种存储系统。<br> 学习kubernetes的核心，就是学习如何对集群上的Pod、Pod控制器、Service、存储等各种资源进行操作</p><h2 id="_3-2-yaml语言介绍" tabindex="-1"><a class="header-anchor" href="#_3-2-yaml语言介绍"><span>3.2 YAML语言介绍</span></a></h2><p>基本变量</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span># 纯量, 就是指的一个简单的值，字符串、布尔值、整数、浮点数、Null、时间、日期</span></span>
<span class="line"><span># 1 布尔类型</span></span>
<span class="line"><span>c1: true (或者True)</span></span>
<span class="line"><span># 2 整型</span></span>
<span class="line"><span>c2: 234</span></span>
<span class="line"><span># 3 浮点型</span></span>
<span class="line"><span>c3: 3.14</span></span>
<span class="line"><span># 4 null类型 </span></span>
<span class="line"><span>c4: ~  </span></span>
<span class="line"><span># 5 日期类型</span></span>
<span class="line"><span>c5: 2018-02-17    # 日期必须使用ISO 8601格式，即yyyy-MM-dd</span></span>
<span class="line"><span># 6 时间类型</span></span>
<span class="line"><span>c6: 2018-02-17T15:02:31+08:00  # 时间使用ISO 8601格式，时间和日期之间使用T连接，最后使用+代表时区</span></span>
<span class="line"><span># 7 字符串类型</span></span>
<span class="line"><span>c7: heima     # 简单写法，直接写值 , 如果字符串中间有特殊字符，必须使用双引号或者单引号包裹 </span></span>
<span class="line"><span>c8: line1</span></span>
<span class="line"><span>    line2     # 字符串过多的情况可以拆成多行，每一行会被转化成一个空格</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>对象</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span># 对象</span></span>
<span class="line"><span># 形式一(推荐):</span></span>
<span class="line"><span>heima:</span></span>
<span class="line"><span>  age: 15</span></span>
<span class="line"><span>  address: Beijing</span></span>
<span class="line"><span># 形式二(了解):</span></span>
<span class="line"><span>heima: {age: 15,address: Beijing}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>数组</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span># 数组</span></span>
<span class="line"><span># 形式一(推荐):</span></span>
<span class="line"><span>address:</span></span>
<span class="line"><span>  - 顺义</span></span>
<span class="line"><span>  - 昌平  </span></span>
<span class="line"><span># 形式二(了解):</span></span>
<span class="line"><span>address: [顺义,昌平]</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_3-3-资源管理方式" tabindex="-1"><a class="header-anchor" href="#_3-3-资源管理方式"><span>3.3 资源管理方式</span></a></h2><p>命令式对象管理：直接使用命令去操作kubernetes资源<br><strong>kubectl run nginx-pod --image=nginx:1.17.1 --port=80</strong></p><ul><li>命令式对象配置：通过命令配置和配置文件去操作kubernetes资源<strong>kubectl create/patch -f nginx-pod.yaml</strong></li><li>声明式对象配置：通过apply命令和配置文件去操作kubernetes资源<strong>kubectl apply -f nginx-pod.yaml</strong></li></ul><table><thead><tr><th>类型</th><th>操作对象</th><th>适用环境</th><th>优点</th><th>缺点</th></tr></thead><tbody><tr><td>命令式对象管理</td><td>对象</td><td>测试</td><td>简单</td><td>只能操作活动对象，无法审计、跟踪</td></tr><tr><td>命令式对象配置</td><td>文件</td><td>开发</td><td>可以审计、跟踪</td><td>项目大时，配置文件多，操作麻烦</td></tr><tr><td>声明式对象配置</td><td>目录</td><td>开发</td><td>支持目录操作</td><td>意外情况下难以调试</td></tr></tbody></table><h3 id="_3-3-1-命令式对象管理" tabindex="-1"><a class="header-anchor" href="#_3-3-1-命令式对象管理"><span>3.3.1 命令式对象管理</span></a></h3><p><strong>kubectl命令</strong><br> kubectl是kubernetes集群的命令行工具，通过它能够对集群本身进行管理，并能够在集群上进行容器化应用的安装部署。kubectl命令的语法如下：</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>kubectl [command] [type] [name] [flags]</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><strong>comand</strong>：指定要对资源执行的操作，例如create、get、delete<br><strong>type</strong>：指定资源类型，比如deployment、pod、service<br><strong>name</strong>：指定资源的名称，名称大小写敏感<br><strong>flags</strong>：指定额外的可选参数</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span># 查看所有pod</span></span>
<span class="line"><span>kubectl get pod --kubecongig config -n namespace</span></span>
<span class="line"><span># 查看某个pod</span></span>
<span class="line"><span>kubectl get pod pod_name --kubecongig config -n namespace</span></span>
<span class="line"><span># 查看某个pod,以yaml格式展示结果</span></span>
<span class="line"><span>kubectl get pod pod_name -o yaml --kubecongig config -n namespace</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>资源类型</strong><br> kubernetes中所有的内容都抽象为资源，可以通过下面的命令进行查看:</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>kubectl api-resources</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>经常使用的资源有下面这些：</p><table><thead><tr><th>资源分类</th><th>资源名称</th><th>缩写</th><th>资源作用</th></tr></thead><tbody><tr><td>集群级别资源</td><td>nodes</td><td>no</td><td>集群组成部分</td></tr><tr><td>namespaces</td><td>ns</td><td>隔离Pod</td><td></td></tr><tr><td>pod资源</td><td>pods</td><td>po</td><td>装载容器</td></tr><tr><td>pod资源控制器</td><td>replicationcontrollers</td><td>rc</td><td>控制pod资源</td></tr><tr><td></td><td>replicasets</td><td>rs</td><td>控制pod资源</td></tr><tr><td></td><td>deployments</td><td>deploy</td><td>控制pod资源</td></tr><tr><td></td><td>daemonsets</td><td>ds</td><td>控制pod资源</td></tr><tr><td></td><td>jobs</td><td></td><td>控制pod资源</td></tr><tr><td></td><td>cronjobs</td><td>cj</td><td>控制pod资源</td></tr><tr><td></td><td>horizontalpodautoscalers</td><td>hpa</td><td>控制pod资源</td></tr><tr><td></td><td>statefulsets</td><td>sts</td><td>控制pod资源</td></tr><tr><td>服务发现资源</td><td>services</td><td>svc</td><td>统一pod对外接口</td></tr><tr><td></td><td>ingress</td><td>ing</td><td>统一pod对外接口</td></tr><tr><td>存储资源</td><td>volumeattachments</td><td></td><td>存储</td></tr><tr><td></td><td>persistentvolumes</td><td>pv</td><td>存储</td></tr><tr><td>配置资源</td><td>configmaps</td><td>cm</td><td>配置</td></tr><tr><td></td><td>secrets</td><td></td><td>配置</td></tr></tbody></table><p><strong>操作</strong><br> kubernetes允许对资源进行多种操作，可以通过--help查看详细的操作命令</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>kubectl --help</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>经常使用的操作有下面这些：</p><table><thead><tr><th>命令分类</th><th>命令</th><th>翻译</th><th>命令作用</th></tr></thead><tbody><tr><td>基本命令</td><td>create</td><td>创建</td><td>创建一个资源</td></tr><tr><td></td><td>edit</td><td>编辑</td><td>编辑一个资源</td></tr><tr><td></td><td>get</td><td>获取</td><td>获取一个资源</td></tr><tr><td></td><td>patch</td><td>更新</td><td>更新一个资源</td></tr><tr><td></td><td>delete</td><td>删除</td><td>删除一个资源</td></tr><tr><td></td><td>explain</td><td>解释</td><td>展示资源文档</td></tr><tr><td>运行和调试</td><td>run</td><td>运行</td><td>在集群中运行一个指定的镜像</td></tr><tr><td></td><td>expose</td><td>暴露</td><td>暴露资源为Service</td></tr><tr><td></td><td><strong>describe</strong></td><td>描述</td><td>显示资源内部信息</td></tr><tr><td></td><td>logs</td><td>日志输出容器在 pod 中的日志</td><td>输出容器在 pod 中的日志</td></tr><tr><td></td><td>attach</td><td>缠绕进入运行中的容器</td><td>进入运行中的容器</td></tr><tr><td></td><td>exec</td><td>执行容器中的一个命令</td><td>执行容器中的一个命令</td></tr><tr><td></td><td>cp</td><td>复制</td><td>在Pod内外复制文件</td></tr><tr><td></td><td>rollout</td><td>首次展示</td><td>管理资源的发布</td></tr><tr><td></td><td>scale</td><td>规模</td><td>扩(缩)容Pod的数量</td></tr><tr><td></td><td>autoscale</td><td>自动调整</td><td>自动调整Pod的数量</td></tr><tr><td>高级命令</td><td>apply</td><td>rc</td><td>通过文件对资源进行配置</td></tr><tr><td></td><td>label</td><td>标签</td><td>更新资源上的标签</td></tr><tr><td>其他命令</td><td>cluster-info</td><td>集群信息</td><td>显示集群信息</td></tr><tr><td></td><td>version</td><td>版本</td><td>显示当前Server和Client的版本</td></tr></tbody></table><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span># 下面以一个namespace / pod的创建和删除简单演示下命令的使用：</span></span>
<span class="line"><span># 创建一个namespace</span></span>
<span class="line"><span>[root@master ~]# kubectl create namespace dev</span></span>
<span class="line"><span>namespace/dev created</span></span>
<span class="line"><span></span></span>
<span class="line"><span># 获取namespace</span></span>
<span class="line"><span>[root@master ~]# kubectl get ns</span></span>
<span class="line"><span>NAME              STATUS   AGE</span></span>
<span class="line"><span>default           Active   21h</span></span>
<span class="line"><span>dev               Active   21s</span></span>
<span class="line"><span>kube-node-lease   Active   21h</span></span>
<span class="line"><span>kube-public       Active   21h</span></span>
<span class="line"><span>kube-system       Active   21h</span></span>
<span class="line"><span></span></span>
<span class="line"><span># 在此namespace下创建并运行一个nginx的Pod</span></span>
<span class="line"><span>[root@master ~]# kubectl run pod --image=nginx:latest -n dev</span></span>
<span class="line"><span>kubectl run --generator=deployment/apps.v1 is DEPRECATED and will be removed in a future version. Use kubectl run --generator=run-pod/v1 or kubectl create instead.</span></span>
<span class="line"><span>deployment.apps/pod created</span></span>
<span class="line"><span></span></span>
<span class="line"><span># 查看新创建的pod</span></span>
<span class="line"><span>[root@master ~]# kubectl get pod -n dev</span></span>
<span class="line"><span>NAME  READY   STATUS    RESTARTS   AGE</span></span>
<span class="line"><span>pod   1/1     Running   0          21s</span></span>
<span class="line"><span></span></span>
<span class="line"><span># 删除指定的pod</span></span>
<span class="line"><span>[root@master ~]# kubectl delete pod pod-864f9875b9-pcw7x</span></span>
<span class="line"><span>pod &quot;pod&quot; deleted</span></span>
<span class="line"><span></span></span>
<span class="line"><span># 删除指定的namespace</span></span>
<span class="line"><span>[root@master ~]# kubectl delete ns dev</span></span>
<span class="line"><span>namespace &quot;dev&quot; deleted</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-3-3-声明式对象配置" tabindex="-1"><a class="header-anchor" href="#_3-3-3-声明式对象配置"><span>3.3.3 声明式对象配置</span></a></h3><p>如果资源不存在，就<strong>创建</strong>，相当于 kubectl create<br> 如果资源已存在，就<strong>更新</strong>，相当于 kubectl patch<br> 扩展：kubectl可以在node节点上运行吗 ?<br> kubectl的运行是需要进行配置的，它的配置文件是$HOME/.kube，如果想要在node节点运行此命令，需要将master上的.kube文件复制到node节点上，即在master节点上执行下面操作：</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span># 主节点执行</span></span>
<span class="line"><span>scp  -r  ~/.kube   k8s.node2:~/</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h1 id="_4-实战入门" tabindex="-1"><a class="header-anchor" href="#_4-实战入门"><span>4. 实战入门</span></a></h1><h2 id="_4-1-namespace" tabindex="-1"><a class="header-anchor" href="#_4-1-namespace"><span>4.1 Namespace</span></a></h2><p>Namespace是kubernetes系统中的一种非常重要资源，它的主要作用是用来实现<strong>多套环境的资源隔离</strong>或者<strong>多租户的资源隔离</strong>。</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span># 默认创建的namespace</span></span>
<span class="line"><span>NAME              STATUS   AGE</span></span>
<span class="line"><span>default           Active   45h     #  所有未指定Namespace的对象都会被分配在default命名空间</span></span>
<span class="line"><span>kube-node-lease   Active   45h     #  集群节点之间的心跳维护，v1.13开始引入</span></span>
<span class="line"><span>kube-public       Active   45h     #  此命名空间下的资源可以被所有人访问（包括未认证用户）</span></span>
<span class="line"><span>kube-system       Active   45h     #  所有由Kubernetes系统创建的资源都处于这个命名空间</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>查看</strong></p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span># 1 查看所有的ns  命令：kubectl get ns</span></span>
<span class="line"><span>kubectl get ns</span></span>
<span class="line"><span># 2 查看指定的ns   命令：kubectl get ns ns名称</span></span>
<span class="line"><span>kubectl get ns default</span></span>
<span class="line"><span># 3 指定输出格式  命令：kubectl get ns ns名称  -o 格式参数</span></span>
<span class="line"><span># kubernetes支持的格式有很多，比较常见的是wide、json、yaml</span></span>
<span class="line"><span>kubectl get ns default -o yaml  </span></span>
<span class="line"><span># 4 查看ns详情  命令：kubectl describe ns ns名称</span></span>
<span class="line"><span>sudo kubectl describe ns default</span></span>
<span class="line"><span># 5 创建&amp;删除</span></span>
<span class="line"><span>kubectl create ns dev</span></span>
<span class="line"><span>kubectl delete ns dev</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>YAML语法</strong></p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span># ns-dev.yaml</span></span>
<span class="line"><span>apiVersion: v1</span></span>
<span class="line"><span>kind: Namespace</span></span>
<span class="line"><span>metadata:</span></span>
<span class="line"><span>  name: dev</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_4-2-pod" tabindex="-1"><a class="header-anchor" href="#_4-2-pod"><span>4.2 Pod</span></a></h2><p>Pod是kubernetes集群进行管理的最小单元，程序要运行必须部署在容器中，而容器必须存在于Pod中。<br> Pod可以认为是容器的封装，一个Pod中可以存在一个或者多个容器。<br><strong>Pod相关命令</strong><br> kubernetes没有提供单独运行Pod的命令，都是通过Pod控制器来实现的</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span># 查看指定名称空间</span></span>
<span class="line"><span>kubectl get pod -n kube-system</span></span>
<span class="line"><span># 创建并运行【这种方式创建了控制器，想要删除还需要删除deployment】</span></span>
<span class="line"><span>kubectl run nginx --image=nginx:latest --port=80 --namespace dev </span></span>
<span class="line"><span># 查看Pod基本信息</span></span>
<span class="line"><span>kubectl get pods -n dev</span></span>
<span class="line"><span># 查看Pod的详细信息 describe  最后的events较为重要，用于拍错</span></span>
<span class="line"><span>kubectl describe pod nginx -n dev</span></span>
<span class="line"><span># 获取podIP</span></span>
<span class="line"><span>kubectl get pods -n dev -o wide</span></span>
<span class="line"><span>#访问POD</span></span>
<span class="line"><span>curl http://10.244.37.201</span></span>
<span class="line"><span># 删除指定Pod</span></span>
<span class="line"><span>kubectl delete pod nginx -n dev</span></span>
<span class="line"><span># 查询一下当前namespace下的Pod控制器</span></span>
<span class="line"><span>kubectl get deploy -n  dev</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>YAML配置</strong></p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>apiVersion: v1</span></span>
<span class="line"><span>kind: Pod</span></span>
<span class="line"><span>metadata:</span></span>
<span class="line"><span>  name: nginx</span></span>
<span class="line"><span>  namespace: dev</span></span>
<span class="line"><span>spec:</span></span>
<span class="line"><span>  containers:</span></span>
<span class="line"><span>  - image: nginx:latest</span></span>
<span class="line"><span>    name: pod</span></span>
<span class="line"><span>    ports:</span></span>
<span class="line"><span>    - name: nginx-port</span></span>
<span class="line"><span>      containerPort: 80</span></span>
<span class="line"><span>      protocol: TCP</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_4-3-label" tabindex="-1"><a class="header-anchor" href="#_4-3-label"><span>4.3 Label</span></a></h2><p>一些常用的Label 示例如下：</p><ul><li>版本标签：&quot;version&quot;:&quot;release&quot;, &quot;version&quot;:&quot;stable&quot;......</li><li>环境标签：&quot;environment&quot;:&quot;dev&quot;，&quot;environment&quot;:&quot;test&quot;，&quot;environment&quot;:&quot;pro&quot;</li><li>架构标签：&quot;tier&quot;:&quot;frontend&quot;，&quot;tier&quot;:&quot;backend&quot;</li></ul><p>当前有两种Label Selector：</p><ul><li><strong>基于等式的Label Selector</strong><br> name = slave 选择所有包含Label中key=&quot;name&quot;且value=&quot;slave&quot;的对象env != production选择所有包括Label中的key=&quot;env&quot;且value不等于&quot;production&quot;的对象</li><li><strong>基于集合的Label Selector</strong>name in (master, slave) 选择所有包含Label中的key=&quot;name&quot;且value=&quot;master&quot;或&quot;slave&quot;的对象name not in (frontend) 选择所有包含Label中的key=&quot;name&quot;且value不等于&quot;frontend&quot;的对象</li></ul><p>标签的选择条件可以使用多个，此时将多个Label Selector进行组合，使用逗号&quot;,&quot;进行分隔即可。例如：<br> name=slave,env!=production<br> name not in (frontend),env!=production<br><strong>Label相关命令</strong></p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span># 为pod资源打标签</span></span>
<span class="line"><span>kubectl label pod nginx-pod version=1.0 -n dev</span></span>
<span class="line"><span># 为pod资源更新标签</span></span>
<span class="line"><span>kubectl label pod nginx-pod version=2.0 -n dev --overwrite</span></span>
<span class="line"><span># 查看标签</span></span>
<span class="line"><span>kubectl get pod nginx-pod  -n dev --show-labels</span></span>
<span class="line"><span># 筛选标签</span></span>
<span class="line"><span>kubectl get pod -n dev -l version=2.0  --show-labels</span></span>
<span class="line"><span>kubectl get pod -n dev -l version!=2.0 --show-labels</span></span>
<span class="line"><span>#删除标签</span></span>
<span class="line"><span>kubectl label pod nginx-pod version- -n dev</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>YAML配置</strong></p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>apiVersion: v1</span></span>
<span class="line"><span>kind: Pod</span></span>
<span class="line"><span>metadata:</span></span>
<span class="line"><span>  name: nginx</span></span>
<span class="line"><span>  namespace: dev</span></span>
<span class="line"><span>  labels:</span></span>
<span class="line"><span>    version: &quot;3.0&quot; </span></span>
<span class="line"><span>    env: &quot;test&quot;</span></span>
<span class="line"><span>spec:</span></span>
<span class="line"><span>  containers:</span></span>
<span class="line"><span>  - image: nginx:latest</span></span>
<span class="line"><span>    name: pod</span></span>
<span class="line"><span>    ports:</span></span>
<span class="line"><span>    - name: nginx-port</span></span>
<span class="line"><span>      containerPort: 80</span></span>
<span class="line"><span>      protocol: TCP</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_4-4-deployment" tabindex="-1"><a class="header-anchor" href="#_4-4-deployment"><span>4.4 Deployment</span></a></h2><p>在kubernetes中，Pod是最小的控制单元，但是kubernetes很少直接控制Pod，一般都是通过Pod控制器来完成的。Pod控制器用于pod的管理，确保pod资源符合预期的状态，当pod的资源出现故障时，会尝试进行重启或重建pod。</p><p>Pod控制器其中的一种是 Deployment</p><p><strong>命令操作</strong></p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span># 命令格式: kubectl create deployment 名称  [参数] </span></span>
<span class="line"><span># --image  指定pod的镜像</span></span>
<span class="line"><span># --port   指定端口</span></span>
<span class="line"><span># --replicas  指定创建pod数量</span></span>
<span class="line"><span># --namespace  指定namespace</span></span>
<span class="line"><span>kubectl create deploy nginx --image=nginx:latest --port=80 --replicas=3 -n dev</span></span>
<span class="line"><span># 查看创建的Pod</span></span>
<span class="line"><span>kubectl get pods -n dev</span></span>
<span class="line"><span># 查看deployment的信息</span></span>
<span class="line"><span># UP-TO-DATE：成功升级的副本数量</span></span>
<span class="line"><span># AVAILABLE：可用副本的数量</span></span>
<span class="line"><span>kubectl get deploy -n dev -o wide</span></span>
<span class="line"><span># 查看deployment的详细信息</span></span>
<span class="line"><span>kubectl describe deploy nginx -n dev</span></span>
<span class="line"><span># 删除 </span></span>
<span class="line"><span>kubectl delete deploy nginx -n dev</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>配置操作</strong></p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span># deploy-nginx.yaml</span></span>
<span class="line"><span>apiVersion: apps/v1</span></span>
<span class="line"><span>kind: Deployment</span></span>
<span class="line"><span>metadata:</span></span>
<span class="line"><span>  name: nginx</span></span>
<span class="line"><span>  namespace: dev</span></span>
<span class="line"><span>  </span></span>
<span class="line"><span>spec:</span></span>
<span class="line"><span>  replicas: 3</span></span>
<span class="line"><span>  selector:</span></span>
<span class="line"><span>    matchLabels:</span></span>
<span class="line"><span>      run: nginx</span></span>
<span class="line"><span>      </span></span>
<span class="line"><span>  template:</span></span>
<span class="line"><span>    metadata:</span></span>
<span class="line"><span>      labels:</span></span>
<span class="line"><span>        run: nginx</span></span>
<span class="line"><span>    spec:</span></span>
<span class="line"><span>      containers:</span></span>
<span class="line"><span>      - image: nginx:latest</span></span>
<span class="line"><span>        name: nginx</span></span>
<span class="line"><span>        ports:</span></span>
<span class="line"><span>        - containerPort: 80</span></span>
<span class="line"><span>          protocol: TCP</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_4-5-service" tabindex="-1"><a class="header-anchor" href="#_4-5-service"><span>4.5 Service</span></a></h2><p>Service可以看作是一组同类Pod<strong>对外的访问接口</strong>。借助Service，应用可以方便地实现服务发现和负载均衡。</p><p><strong>操作一：创建集群内部可访问的Service</strong></p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span># 暴露Service</span></span>
<span class="line"><span>kubectl expose deploy nginx --name=svc-nginx1 --type=ClusterIP --port=80 --target-port=80 -n dev</span></span>
<span class="line"><span># 查看service</span></span>
<span class="line"><span>kubectl get svc  -n dev -o wide</span></span>
<span class="line"><span># 这里产生了一个CLUSTER-IP，这就是service的IP，在Service的生命周期中，这个地址是不会变动的</span></span>
<span class="line"><span># 可以通过这个IP访问当前service对应的POD</span></span>
<span class="line"><span>curl 10.109.179.231:80</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>操作二：创建集群外部也可访问的Service</strong></p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span># 上面创建的Service的type类型为ClusterIP，这个ip地址只用集群内部可访问</span></span>
<span class="line"><span># 如果需要创建外部也可以访问的Service，需要修改type为NodePort</span></span>
<span class="line"><span>kubectl expose deploy nginx --name=svc-nginx2 --type=NodePort --port=80 --target-port=80 -n dev</span></span>
<span class="line"><span># 此时查看，会发现出现了NodePort类型的Service，而且有一对Port（80:31928/TC）</span></span>
<span class="line"><span>kubectl get svc  svc-nginx2  -n dev -o wide</span></span>
<span class="line"><span># 接下来就可以通过集群外的主机访问 节点IP:31928访问服务了</span></span>
<span class="line"><span># 例如在的电脑主机上通过浏览器访问下面的地址</span></span>
<span class="line"><span>http://192.168.5.4:31928/</span></span>
<span class="line"><span>#删除Service</span></span>
<span class="line"><span>kubectl delete svc svc-nginx1 -n dev</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>配置方式</strong></p><p>创建一个svc-nginx.yaml，内容如下：</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>apiVersion: v1</span></span>
<span class="line"><span>kind: Service</span></span>
<span class="line"><span>metadata:</span></span>
<span class="line"><span>  name: svc-nginx</span></span>
<span class="line"><span>  namespace: dev</span></span>
<span class="line"><span>spec:</span></span>
<span class="line"><span>  clusterIP: 10.109.179.231 #固定svc的内网ip</span></span>
<span class="line"><span>  ports:</span></span>
<span class="line"><span>  - port: 80</span></span>
<span class="line"><span>    protocol: TCP</span></span>
<span class="line"><span>    targetPort: 80</span></span>
<span class="line"><span>  selector:</span></span>
<span class="line"><span>    run: nginx</span></span>
<span class="line"><span>  type: ClusterIP</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h1 id="_5-pod详解" tabindex="-1"><a class="header-anchor" href="#_5-pod详解"><span>5. Pod详解</span></a></h1><h2 id="_5-1-pod介绍" tabindex="-1"><a class="header-anchor" href="#_5-1-pod介绍"><span>5.1 Pod介绍</span></a></h2><h3 id="_5-1-1-pod结构" tabindex="-1"><a class="header-anchor" href="#_5-1-1-pod结构"><span>5.1.1 Pod结构</span></a></h3><p>每个Pod中都可以包含一个或者多个容器，这些容器可以分为两类：</p><ul><li><p>用户程序所在的容器，数量可多可少</p></li><li><p>Pause容器，这是每个Pod都会有的一个<strong>根容器</strong>，它的作用有两个：</p><ul><li><p>可以以它为依据，评估整个Pod的健康状态</p></li><li><p>可以在根容器上设置Ip地址，其它容器都此Ip（Pod IP），以实现Pod内部的网路通信</p></li></ul></li></ul><h3 id="_5-1-2-pod定义" tabindex="-1"><a class="header-anchor" href="#_5-1-2-pod定义"><span>5.1.2 Pod定义</span></a></h3><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>apiVersion: v1     #必选，版本号，例如v1</span></span>
<span class="line"><span>kind: Pod       　 #必选，资源类型，例如 Pod</span></span>
<span class="line"><span>metadata:       　 #必选，元数据</span></span>
<span class="line"><span>  name: string     #必选，Pod名称</span></span>
<span class="line"><span>  namespace: string  #Pod所属的命名空间,默认为&quot;default&quot;</span></span>
<span class="line"><span>  labels:       　　  #自定义标签列表</span></span>
<span class="line"><span>    - name: string      　          </span></span>
<span class="line"><span>spec:  #必选，Pod中容器的详细定义</span></span>
<span class="line"><span>  containers:  #必选，Pod中容器列表</span></span>
<span class="line"><span>  - name: string   #必选，容器名称</span></span>
<span class="line"><span>    image: string  #必选，容器的镜像名称</span></span>
<span class="line"><span>    imagePullPolicy: [ Always|Never|IfNotPresent ]  #获取镜像的策略 </span></span>
<span class="line"><span>    command: [string]   #容器的启动命令列表，如不指定，使用打包时使用的启动命令</span></span>
<span class="line"><span>    args: [string]      #容器的启动命令参数列表</span></span>
<span class="line"><span>    workingDir: string  #容器的工作目录</span></span>
<span class="line"><span>    volumeMounts:       #挂载到容器内部的存储卷配置</span></span>
<span class="line"><span>    - name: string      #引用pod定义的共享存储卷的名称，需用volumes[]部分定义的的卷名</span></span>
<span class="line"><span>      mountPath: string #存储卷在容器内mount的绝对路径，应少于512字符</span></span>
<span class="line"><span>      readOnly: boolean #是否为只读模式</span></span>
<span class="line"><span>    ports: #需要暴露的端口库号列表</span></span>
<span class="line"><span>    - name: string        #端口的名称</span></span>
<span class="line"><span>      containerPort: int  #容器需要监听的端口号</span></span>
<span class="line"><span>      hostPort: int       #容器所在主机需要监听的端口号，默认与Container相同</span></span>
<span class="line"><span>      protocol: string    #端口协议，支持TCP和UDP，默认TCP</span></span>
<span class="line"><span>    env:   #容器运行前需设置的环境变量列表</span></span>
<span class="line"><span>    - name: string  #环境变量名称</span></span>
<span class="line"><span>      value: string #环境变量的值</span></span>
<span class="line"><span>    resources: #资源限制和请求的设置</span></span>
<span class="line"><span>      limits:  #资源限制的设置</span></span>
<span class="line"><span>        cpu: string     #Cpu的限制，单位为core数，将用于docker run --cpu-shares参数</span></span>
<span class="line"><span>        memory: string  #内存限制，单位可以为Mib/Gib，将用于docker run --memory参数</span></span>
<span class="line"><span>      requests: #资源请求的设置</span></span>
<span class="line"><span>        cpu: string    #Cpu请求，容器启动的初始可用数量</span></span>
<span class="line"><span>        memory: string #内存请求,容器启动的初始可用数量</span></span>
<span class="line"><span>    lifecycle: #生命周期钩子</span></span>
<span class="line"><span>        postStart: #容器启动后立即执行此钩子,如果执行失败,会根据重启策略进行重启</span></span>
<span class="line"><span>        preStop: #容器终止前执行此钩子,无论结果如何,容器都会终止</span></span>
<span class="line"><span>    livenessProbe:  #对Pod内各容器健康检查的设置，当探测无响应几次后将自动重启该容器</span></span>
<span class="line"><span>      exec:       　 #对Pod容器内检查方式设置为exec方式</span></span>
<span class="line"><span>        command: [string]  #exec方式需要制定的命令或脚本</span></span>
<span class="line"><span>      httpGet:       #对Pod内个容器健康检查方法设置为HttpGet，需要制定Path、port</span></span>
<span class="line"><span>        path: string</span></span>
<span class="line"><span>        port: number</span></span>
<span class="line"><span>        host: string</span></span>
<span class="line"><span>        scheme: string</span></span>
<span class="line"><span>        HttpHeaders:</span></span>
<span class="line"><span>        - name: string</span></span>
<span class="line"><span>          value: string</span></span>
<span class="line"><span>      tcpSocket:     #对Pod内个容器健康检查方式设置为tcpSocket方式</span></span>
<span class="line"><span>         port: number</span></span>
<span class="line"><span>       initialDelaySeconds: 0       #容器启动完成后首次探测的时间，单位为秒</span></span>
<span class="line"><span>       timeoutSeconds: 0    　　    #对容器健康检查探测等待响应的超时时间，单位秒，默认1秒</span></span>
<span class="line"><span>       periodSeconds: 0     　　    #对容器监控检查的定期探测时间设置，单位秒，默认10秒一次</span></span>
<span class="line"><span>       successThreshold: 0</span></span>
<span class="line"><span>       failureThreshold: 0</span></span>
<span class="line"><span>       securityContext:</span></span>
<span class="line"><span>         privileged: false</span></span>
<span class="line"><span>  restartPolicy: [Always | Never | OnFailure]  #Pod的重启策略</span></span>
<span class="line"><span>  nodeName: &lt;string&gt; #设置NodeName表示将该Pod调度到指定到名称的node节点上</span></span>
<span class="line"><span>  nodeSelector: obeject #设置NodeSelector表示将该Pod调度到包含这个label的node上</span></span>
<span class="line"><span>  imagePullSecrets: #Pull镜像时使用的secret名称，以key：secretkey格式指定</span></span>
<span class="line"><span>  - name: string</span></span>
<span class="line"><span>  hostNetwork: false   #是否使用主机网络模式，默认为false，如果设置为true，表示使用宿主机网络</span></span>
<span class="line"><span>  volumes:   #在该pod上定义共享存储卷列表</span></span>
<span class="line"><span>  - name: string    #共享存储卷名称 （volumes类型有很多种）</span></span>
<span class="line"><span>    emptyDir: {}       #类型为emtyDir的存储卷，与Pod同生命周期的一个临时目录。为空值</span></span>
<span class="line"><span>    hostPath: string   #类型为hostPath的存储卷，表示挂载Pod所在宿主机的目录</span></span>
<span class="line"><span>      path: string      　　        #Pod所在宿主机的目录，将被用于同期中mount的目录</span></span>
<span class="line"><span>    secret:       　　　#类型为secret的存储卷，挂载集群与定义的secret对象到容器内部</span></span>
<span class="line"><span>      scretname: string  </span></span>
<span class="line"><span>      items:     </span></span>
<span class="line"><span>      - key: string</span></span>
<span class="line"><span>        path: string</span></span>
<span class="line"><span>    configMap:         #类型为configMap的存储卷，挂载预定义的configMap对象到容器内部</span></span>
<span class="line"><span>      name: string</span></span>
<span class="line"><span>      items:</span></span>
<span class="line"><span>      - key: string</span></span>
<span class="line"><span>        path: string</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>#小提示：</span></span>
<span class="line"><span>#   在这里，可通过一个命令来查看每种资源的可配置项</span></span>
<span class="line"><span>#   kubectl explain 资源类型         查看某种资源可以配置的一级属性</span></span>
<span class="line"><span>#   kubectl explain 资源类型.属性     查看属性的子属性</span></span>
<span class="line"><span>kubectl explain pod</span></span>
<span class="line"><span>#   apiVersion   &lt;string&gt;</span></span>
<span class="line"><span>#   kind &lt;string&gt;</span></span>
<span class="line"><span>#   metadata     &lt;Object&gt;</span></span>
<span class="line"><span>#   spec &lt;Object&gt;</span></span>
<span class="line"><span>#   status       &lt;Object&gt;</span></span>
<span class="line"><span>kubectl explain pod.metadata</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在kubernetes中基本所有资源的一级属性都是一样的，主要包含5部分：</p><ul><li>apiVersion 版本，由kubernetes内部定义，版本号可以用 kubectl api-versions 查询到</li><li>kind 类型，由kubernetes内部定义，版本号可以用 kubectl api-resources 查询到</li><li>metadata 元数据，主要是资源标识和说明，常用的有name、namespace、labels等</li><li>status 状态信息，里面的内容不需要定义，由kubernetes自动生成</li><li><strong>spec</strong> 描述，这是配置中最重要的一部分，里面是对各种资源配置的详细描述</li></ul><p>在上面的属性中，<strong>spec</strong>是接下来研究的重点，常见子属性：</p><ul><li>containers &lt;[]Object&gt; 容器列表，用于定义容器的详细信息</li><li>nodeName 根据nodeName的值将pod调度到指定的Node节点上</li><li>nodeSelector &lt;map[]&gt; 根据NodeSelector中定义的信息选择将该Pod调度到包含这些label的Node 上</li><li>hostNetwork 是否使用主机网络模式，默认为false，如果设置为true，表示使用宿主机网络</li><li>volumes &lt;[]Object&gt; 存储卷，用于定义Pod上面挂在的存储信息</li><li>restartPolicy 重启策略，表示Pod在遇到故障的时候的处理策略</li></ul><h2 id="_5-2-pod配置" tabindex="-1"><a class="header-anchor" href="#_5-2-pod配置"><span>5.2 Pod配置</span></a></h2><p>主要来研究pod.spec.containers属性</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>kubectl explain pod.spec.containers</span></span>
<span class="line"><span># KIND:     Pod</span></span>
<span class="line"><span># VERSION:  v1</span></span>
<span class="line"><span># RESOURCE: containers &lt;[]Object&gt;   # 数组，代表可以有多个容器</span></span>
<span class="line"><span># FIELDS:</span></span>
<span class="line"><span>#    name  &lt;string&gt;     # 容器名称</span></span>
<span class="line"><span>#    image &lt;string&gt;     # 容器需要的镜像地址</span></span>
<span class="line"><span>#    imagePullPolicy  &lt;string&gt; # 镜像拉取策略 </span></span>
<span class="line"><span>#    command  &lt;[]string&gt; # 容器的启动命令列表，如不指定，使用打包时使用的启动命令</span></span>
<span class="line"><span>#    args     &lt;[]string&gt; # 容器的启动命令需要的参数列表</span></span>
<span class="line"><span>#    env      &lt;[]Object&gt; # 容器环境变量的配置</span></span>
<span class="line"><span>#    ports    &lt;[]Object&gt;     # 容器需要暴露的端口号列表</span></span>
<span class="line"><span>#    resources &lt;Object&gt;      # 资源限制和资源请求的设置</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-2-1-基本配置" tabindex="-1"><a class="header-anchor" href="#_5-2-1-基本配置"><span>5.2.1 基本配置</span></a></h3><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span># pod-base.yaml</span></span>
<span class="line"><span>apiVersion: v1</span></span>
<span class="line"><span>kind: Pod</span></span>
<span class="line"><span>metadata:</span></span>
<span class="line"><span>  name: pod-base</span></span>
<span class="line"><span>  namespace: dev</span></span>
<span class="line"><span>  labels:</span></span>
<span class="line"><span>    user: heima</span></span>
<span class="line"><span>spec:</span></span>
<span class="line"><span>  containers:</span></span>
<span class="line"><span>  - name: nginx</span></span>
<span class="line"><span>    image: nginx:1.17.1 # 用1.17.1版本的nginx镜像创建，（nginx是一个轻量级web容器）</span></span>
<span class="line"><span>  - name: busybox</span></span>
<span class="line"><span>    image: busybox:1.30 # 用1.30版本的busybox镜像创建，（busybox是一个小巧的linux命令集合）</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span># 创建Pod</span></span>
<span class="line"><span>kubectl apply -f pod-base.yaml</span></span>
<span class="line"><span>kubectl get pod -n dev</span></span>
<span class="line"><span># 可以通过describe查看内部的详情</span></span>
<span class="line"><span># 此时已经运行起来了一个基本的Pod，虽然它暂时有问题</span></span>
<span class="line"><span>kubectl describe pod pod-base -n dev</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-2-2-镜像拉取" tabindex="-1"><a class="header-anchor" href="#_5-2-2-镜像拉取"><span>5.2.2 镜像拉取</span></a></h3><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span># pod-imagepullpolicy.yaml</span></span>
<span class="line"><span>apiVersion: v1</span></span>
<span class="line"><span>kind: Pod</span></span>
<span class="line"><span>metadata:</span></span>
<span class="line"><span>  name: pod-imagepullpolicy</span></span>
<span class="line"><span>  namespace: dev</span></span>
<span class="line"><span>spec:</span></span>
<span class="line"><span>  containers:</span></span>
<span class="line"><span>  - name: nginx</span></span>
<span class="line"><span>    image: nginx:1.17.1</span></span>
<span class="line"><span>    imagePullPolicy: Never # 用于设置镜像拉取策略</span></span>
<span class="line"><span>  - name: busybox</span></span>
<span class="line"><span>    image: busybox:1.30</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>imagePullPolicy</strong>，用于设置镜像拉取策略，kubernetes支持配置三种拉取策略：</p><ul><li><p><strong>Always</strong>：只使用远程</p></li><li><p><strong>IfNotPresent</strong>：本地有则使用本地镜像，本地没有则从远程仓库拉取镜像【默认】</p></li><li><p><strong>Never</strong>：只使用本地</p></li></ul><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span># 创建Pod</span></span>
<span class="line"><span>kubectl create -f pod-imagepullpolicy.yaml</span></span>
<span class="line"><span># 查看Pod详情</span></span>
<span class="line"><span># 此时明显可以看到nginx镜像有一步Pulling image &quot;nginx:1.17.1&quot;的过程</span></span>
<span class="line"><span>kubectl describe pod pod-imagepullpolicy -n dev</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-2-3-启动命令" tabindex="-1"><a class="header-anchor" href="#_5-2-3-启动命令"><span>5.2.3 启动命令</span></a></h3><p><strong>在前面的案例中：busybox并不是一个程序，而是类似于一个工具类的集合，kubernetes集群启动管理后，它会自动关闭。解决方法就是让其一直在运行，这就用到了command配置。command，用于在pod中的容器初始化完毕之后运行一个命令。</strong></p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span># pod-command.yaml</span></span>
<span class="line"><span>apiVersion: v1</span></span>
<span class="line"><span>kind: Pod</span></span>
<span class="line"><span>metadata:</span></span>
<span class="line"><span>  name: pod-command</span></span>
<span class="line"><span>  namespace: dev</span></span>
<span class="line"><span>spec:</span></span>
<span class="line"><span>  containers:</span></span>
<span class="line"><span>  - name: nginx</span></span>
<span class="line"><span>    image: nginx:1.17.1</span></span>
<span class="line"><span>  - name: busybox</span></span>
<span class="line"><span>    image: busybox:1.30</span></span>
<span class="line"><span>    command: [&quot;/bin/sh&quot;,&quot;-c&quot;,&quot;touch /tmp/hello.txt;while true;do /bin/echo $(date +%T) &gt;&gt; /tmp/hello.txt; sleep 3; done;&quot;]</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>每隔3秒向文件中写入当前时间</p><p>&quot;/bin/sh&quot;,&quot;-c&quot;, 使用sh执行命令</p><p>touch /tmp/hello.txt; 创建一个/tmp/hello.txt 文件</p><p>while true;do /bin/echo $(date +%T) &gt;&gt; /tmp/hello.txt; sleep 3; done;</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span># 重试</span></span>
<span class="line"><span>kubectl create  -f pod-command.yaml</span></span>
<span class="line"><span>kubectl get pods pod-command -n dev</span></span>
<span class="line"><span></span></span>
<span class="line"><span># 进入pod中的busybox容器，查看文件内容</span></span>
<span class="line"><span># 补充一个命令: kubectl exec  pod名称 -n 命名空间 -it -c 容器名称 /bin/sh  在容器内部执行命令</span></span>
<span class="line"><span># 使用这个命令就可以进入某个容器的内部，然后进行相关操作了</span></span>
<span class="line"><span># 比如，可以查看txt文件的内容</span></span>
<span class="line"><span>kubectl exec pod-command -n dev -it -c busybox /bin/sh</span></span>
<span class="line"><span>/ # tail -f /tmp/hello.txt</span></span>
<span class="line"><span>14:44:19</span></span>
<span class="line"><span>14:44:22</span></span>
<span class="line"><span>14:44:25</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>特别说明：</span></span>
<span class="line"><span>    通过上面发现command已经可以完成启动命令和传递参数的功能，为什么这里还要提供一个args选项，用于传递参数呢?这其实跟docker有点关系，kubernetes中的command、args两项其实是实现覆盖Dockerfile中ENTRYPOINT的功能。</span></span>
<span class="line"><span> 1 如果command和args均没有写，那么用Dockerfile的配置。</span></span>
<span class="line"><span> 2 如果command写了，但args没有写，那么Dockerfile默认的配置会被忽略，执行输入的command</span></span>
<span class="line"><span> 3 如果command没写，但args写了，那么Dockerfile中配置的ENTRYPOINT的命令会被执行，使用当前args的参数</span></span>
<span class="line"><span> 4 如果command和args都写了，那么Dockerfile的配置被忽略，执行command并追加上args参数</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-2-4-环境变量" tabindex="-1"><a class="header-anchor" href="#_5-2-4-环境变量"><span>5.2.4 环境变量</span></a></h3><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span># pod-env.yaml</span></span>
<span class="line"><span>apiVersion: v1</span></span>
<span class="line"><span>kind: Pod</span></span>
<span class="line"><span>metadata:</span></span>
<span class="line"><span>  name: pod-env</span></span>
<span class="line"><span>  namespace: dev</span></span>
<span class="line"><span>spec:</span></span>
<span class="line"><span>  containers:</span></span>
<span class="line"><span>  - name: busybox</span></span>
<span class="line"><span>    image: busybox:1.30</span></span>
<span class="line"><span>    command: [&quot;/bin/sh&quot;,&quot;-c&quot;,&quot;while true;do /bin/echo $(date +%T);sleep 60; done;&quot;]</span></span>
<span class="line"><span>    env: # 设置环境变量列表</span></span>
<span class="line"><span>    - name: &quot;username&quot;</span></span>
<span class="line"><span>      value: &quot;admin&quot;</span></span>
<span class="line"><span>    - name: &quot;password&quot;</span></span>
<span class="line"><span>      value: &quot;123456&quot;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>env，环境变量，用于在pod中的容器设置环境变量。</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span># 创建Pod</span></span>
<span class="line"><span>kubectl create -f pod-env.yaml</span></span>
<span class="line"><span># 进入容器，输出环境变量</span></span>
<span class="line"><span>kubectl exec pod-env -n dev -c busybox -it /bin/sh</span></span>
<span class="line"><span>/ # echo $username</span></span>
<span class="line"><span>admin</span></span>
<span class="line"><span>/ # echo $password</span></span>
<span class="line"><span>123456</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这种方式不是很推荐，推荐将这些配置单独存储在配置文件中</p><h3 id="_5-2-5-端口设置" tabindex="-1"><a class="header-anchor" href="#_5-2-5-端口设置"><span>5.2.5 端口设置</span></a></h3><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>kubectl explain pod.spec.containers.ports</span></span>
<span class="line"><span>#KIND:     Pod</span></span>
<span class="line"><span>#VERSION:  v1</span></span>
<span class="line"><span>#RESOURCE: ports &lt;[]Object&gt;</span></span>
<span class="line"><span>#FIELDS:</span></span>
<span class="line"><span>#   name         &lt;string&gt;  # 端口名称，如果指定，必须保证name在pod中是唯一的		</span></span>
<span class="line"><span>#   containerPort&lt;integer&gt; # 容器要监听的端口(0&lt;x&lt;65536)</span></span>
<span class="line"><span>#   hostPort     &lt;integer&gt; # 容器要在主机上公开的端口，如果设置，主机上只能运行容器的一个副本(一般省略) </span></span>
<span class="line"><span>#   hostIP       &lt;string&gt;  # 要将外部端口绑定到的主机IP(一般省略)</span></span>
<span class="line"><span>#   protocol     &lt;string&gt;  # 端口协议。必须是UDP、TCP或SCTP。默认为“TCP”。</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span># pod-ports.yaml</span></span>
<span class="line"><span>apiVersion: v1</span></span>
<span class="line"><span>kind: Pod</span></span>
<span class="line"><span>metadata:</span></span>
<span class="line"><span>  name: pod-ports</span></span>
<span class="line"><span>  namespace: dev</span></span>
<span class="line"><span>spec:</span></span>
<span class="line"><span>  containers:</span></span>
<span class="line"><span>  - name: nginx</span></span>
<span class="line"><span>    image: nginx:1.17.1</span></span>
<span class="line"><span>    ports: # 设置容器暴露的端口列表</span></span>
<span class="line"><span>    - name: nginx-port</span></span>
<span class="line"><span>      containerPort: 80</span></span>
<span class="line"><span>      protocol: TCP</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span># 创建Pod</span></span>
<span class="line"><span>kubectl create -f pod-ports.yaml</span></span>
<span class="line"><span># 查看pod</span></span>
<span class="line"><span>kubectl get pod pod-ports -n dev -o yaml</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-2-6-资源配额" tabindex="-1"><a class="header-anchor" href="#_5-2-6-资源配额"><span>5.2.6 资源配额</span></a></h3><ul><li><p><strong>limits</strong>：用于限制运行时容器的最大占用资源，当容器占用资源超过limits时会被终止，并进行重启</p></li><li><p><strong>requests</strong> ：用于设置容器需要的最小资源，如果环境资源不够，容器将无法启动</p></li></ul><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span># pod-resources.yaml</span></span>
<span class="line"><span>apiVersion: v1</span></span>
<span class="line"><span>kind: Pod</span></span>
<span class="line"><span>metadata:</span></span>
<span class="line"><span>  name: pod-resources</span></span>
<span class="line"><span>  namespace: dev</span></span>
<span class="line"><span>spec:</span></span>
<span class="line"><span>  containers:</span></span>
<span class="line"><span>  - name: nginx</span></span>
<span class="line"><span>    image: nginx:1.17.1</span></span>
<span class="line"><span>    resources: # 资源配额</span></span>
<span class="line"><span>      limits:  # 限制资源（上限）</span></span>
<span class="line"><span>        cpu: &quot;2&quot; # CPU限制，单位是core数【整数||小数】</span></span>
<span class="line"><span>        memory: &quot;10Gi&quot; # 内存限制【Gi、Mi、G、M】</span></span>
<span class="line"><span>      requests: # 请求资源（下限）</span></span>
<span class="line"><span>        cpu: &quot;1&quot;  # CPU限制，单位是core数【整数||小数】</span></span>
<span class="line"><span>        memory: &quot;10Mi&quot;  # 内存限制【Gi、Mi、G、M】</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_5-3-pod生命周期" tabindex="-1"><a class="header-anchor" href="#_5-3-pod生命周期"><span>5.3 Pod生命周期</span></a></h2><p>我们一般将pod对象从创建至终的这段时间范围称为pod的生命周期，它主要包含下面的过程：</p><ul><li><p>pod创建过程</p></li><li><p>运行初始化容器（init container）过程</p></li><li><p>运行主容器（main container）</p><ul><li><p>容器启动后钩子（post start）、容器终止前钩子（pre stop）</p></li><li><p>容器的存活性探测（liveness probe）、就绪性探测（readiness probe）</p></li></ul></li><li><p>pod终止过程</p></li></ul><p>在整个生命周期中，Pod会出现5种<strong>状态</strong>（<strong>相位</strong>），分别如下：</p><ul><li><p>挂起（Pending）：apiserver已经创建了pod资源对象，但它尚未被调度完成或者仍处于下载镜像的过程中</p></li><li><p>运行中（Running）：pod已经被调度至某节点，并且所有容器都已经被kubelet创建完成</p></li><li><p>成功（Succeeded）：pod中的所有容器都已经成功终止并且不会被重启</p></li><li><p>失败（Failed）：所有容器都已经终止，但至少有一个容器终止失败，即容器返回了非0值的退出状态</p></li><li><p>未知（Unknown）：apiserver无法正常获取到pod对象的状态信息，通常由网络通信失败所导致</p></li></ul><h3 id="_5-3-1-创建和终止" tabindex="-1"><a class="header-anchor" href="#_5-3-1-创建和终止"><span>5.3.1 创建和终止</span></a></h3><p><strong>pod的创建过程</strong></p><ol><li><p>用户通过kubectl或其他api客户端提交需要创建的pod信息给apiServer</p></li><li><p>apiServer开始生成pod对象的信息，并将信息存入etcd，然后返回确认信息至客户端</p></li><li><p>apiServer开始反映etcd中的pod对象的变化，其它组件使用<strong>watch</strong>机制来跟踪检查apiServer上的变动</p></li><li><p>scheduler发现有新的pod对象要创建，开始为Pod分配主机并将结果信息更新至apiServer</p></li><li><p>node节点上的kubelet发现有pod调度过来，尝试调用docker启动容器，并将结果回送至apiServer</p></li><li><p>apiServer将接收到的pod状态信息存入etcd中</p></li></ol><p><strong>pod的终止过程</strong></p><ol><li><p>用户向apiServer发送删除pod对象的命令</p></li><li><p>apiServcer中的pod对象信息会随着时间的推移而更新，在宽限期内（默认30s），pod被视为dead</p></li><li><p>将pod标记为terminating状态</p></li><li><p>kubelet在监控到pod对象转为terminating状态的同时启动pod关闭过程</p></li><li><p>端点控制器监控到pod对象的关闭行为时将其从所有匹配到此端点的service资源的端点列表中移除</p></li><li><p>如果当前pod对象定义了preStop钩子处理器，则在其标记为terminating后即会以同步的方式启动执行</p></li><li><p>pod对象中的容器进程收到停止信号</p></li><li><p>宽限期结束后，若pod中还存在仍在运行的进程，那么pod对象会收到立即终止的信号</p></li><li><p>kubelet请求apiServer将此pod资源的宽限期设置为0从而完成删除操作，此时pod对于用户已不可见</p></li></ol><h3 id="_5-3-2-初始化容器" tabindex="-1"><a class="header-anchor" href="#_5-3-2-初始化容器"><span>5.3.2 初始化容器</span></a></h3><p>初始化容器是在pod的主容器启动之前要运行的容器，主要是做一些主容器的前置工作，它具有两大特征：</p><ol><li><p>初始化容器必须运行完成直至结束，若某初始化容器运行失败，那么kubernetes需要重启它直到成功完成</p></li><li><p>初始化容器必须按照定义的顺序执行，当且仅当前一个成功之后，后面的一个才能运行</p></li></ol><p>初始化容器有很多的应用场景，下面列出的是最常见的几个：</p><ul><li><p>提供主容器镜像中不具备的工具程序或自定义代码</p></li><li><p>初始化容器要先于应用容器串行启动并运行完成，因此可用于延后应用容器的启动直至其依赖的条件得到满足</p></li></ul><p>接下来做一个案例，模拟下面这个需求：</p><p>假设要以主容器来运行nginx，但是要求在运行nginx之前先要能够连接上mysql和redis所在服务器</p><p>为了简化测试，事先规定好mysql(192.168.5.4)和redis(192.168.5.5)服务器的地址</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span># pod-initcontainer.yaml</span></span>
<span class="line"><span>apiVersion: v1</span></span>
<span class="line"><span>kind: Pod</span></span>
<span class="line"><span>metadata:</span></span>
<span class="line"><span>  name: pod-initcontainer</span></span>
<span class="line"><span>  namespace: dev</span></span>
<span class="line"><span>spec:</span></span>
<span class="line"><span>  containers:</span></span>
<span class="line"><span>  - name: main-container</span></span>
<span class="line"><span>    image: nginx:1.17.1</span></span>
<span class="line"><span>    ports: </span></span>
<span class="line"><span>    - name: nginx-port</span></span>
<span class="line"><span>      containerPort: 80</span></span>
<span class="line"><span>  initContainers:</span></span>
<span class="line"><span>  - name: test-mysql</span></span>
<span class="line"><span>    image: busybox:1.30</span></span>
<span class="line"><span>    command: [&#39;sh&#39;, &#39;-c&#39;, &#39;until ping 192.168.5.14 -c 1 ; do echo waiting for mysql...; sleep 2; done;&#39;]</span></span>
<span class="line"><span>  - name: test-redis</span></span>
<span class="line"><span>    image: busybox:1.30</span></span>
<span class="line"><span>    command: [&#39;sh&#39;, &#39;-c&#39;, &#39;until ping 192.168.5.15 -c 1 ; do echo waiting for reids...; sleep 2; done;&#39;]</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span># 创建pod</span></span>
<span class="line"><span>kubectl create -f pod-initcontainer.yaml</span></span>
<span class="line"><span># 查看pod状态</span></span>
<span class="line"><span># 发现pod卡在启动第一个初始化容器过程中，后面的容器不会运行</span></span>
<span class="line"><span>kubectl describe pod  pod-initcontainer -n dev</span></span>
<span class="line"><span># 动态查看pod</span></span>
<span class="line"><span>kubectl get pods pod-initcontainer -n dev -w</span></span>
<span class="line"><span># 接下来新开一个shell，为当前服务器新增两个ip，观察pod的变化</span></span>
<span class="line"><span>ifconfig ens33:1 192.168.5.14 netmask 255.255.255.0 up</span></span>
<span class="line"><span>ifconfig ens33:2 192.168.5.15 netmask 255.255.255.0 up</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-3-3-钩子函数" tabindex="-1"><a class="header-anchor" href="#_5-3-3-钩子函数"><span>5.3.3 钩子函数</span></a></h3><ul><li><p>post start：容器创建之后执行，如果失败了会重启容器</p></li><li><p>pre stop ：容器终止之前执行，执行完成之后容器将成功终止，在其完成之前会阻塞删除容器的操作</p></li></ul><p>钩子处理器支持使用下面三种方式定义动作：</p><ul><li><strong>Exec命令</strong>：在容器内执行一次命令</li></ul><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>……</span></span>
<span class="line"><span>  lifecycle:</span></span>
<span class="line"><span>    postStart: </span></span>
<span class="line"><span>      exec:</span></span>
<span class="line"><span>        command:</span></span>
<span class="line"><span>        - cat</span></span>
<span class="line"><span>        - /tmp/healthy</span></span>
<span class="line"><span>……</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>TCPSocket</strong>：在当前容器尝试访问指定的socket</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>……      </span></span>
<span class="line"><span>  lifecycle:</span></span>
<span class="line"><span>    postStart:</span></span>
<span class="line"><span>      tcpSocket:</span></span>
<span class="line"><span>        port: 8080</span></span>
<span class="line"><span>……</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>HTTPGet：在当前容器中向某url发起http请求</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>……</span></span>
<span class="line"><span>  lifecycle:</span></span>
<span class="line"><span>    postStart:</span></span>
<span class="line"><span>      httpGet:</span></span>
<span class="line"><span>        path: / #URI地址</span></span>
<span class="line"><span>        port: 80 #端口号</span></span>
<span class="line"><span>        host: 192.168.5.3 #主机地址</span></span>
<span class="line"><span>        scheme: HTTP #支持的协议，http或者https</span></span>
<span class="line"><span>……</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span># pod-hook-exec.yaml</span></span>
<span class="line"><span>apiVersion: v1</span></span>
<span class="line"><span>kind: Pod</span></span>
<span class="line"><span>metadata:</span></span>
<span class="line"><span>  name: pod-hook-exec</span></span>
<span class="line"><span>  namespace: dev</span></span>
<span class="line"><span>spec:</span></span>
<span class="line"><span>  containers:</span></span>
<span class="line"><span>  - name: main-container</span></span>
<span class="line"><span>    image: nginx:1.17.1</span></span>
<span class="line"><span>    ports:</span></span>
<span class="line"><span>    - name: nginx-port</span></span>
<span class="line"><span>      containerPort: 80</span></span>
<span class="line"><span>    lifecycle:</span></span>
<span class="line"><span>      postStart: </span></span>
<span class="line"><span>        exec: # 在容器启动的时候执行一个命令，修改掉nginx的默认首页内容</span></span>
<span class="line"><span>          command: [&quot;/bin/sh&quot;, &quot;-c&quot;, &quot;echo postStart... &gt; /usr/share/nginx/html/index.html&quot;]</span></span>
<span class="line"><span>      preStop:</span></span>
<span class="line"><span>        exec: # 在容器停止之前停止nginx服务</span></span>
<span class="line"><span>          command: [&quot;/usr/sbin/nginx&quot;,&quot;-s&quot;,&quot;quit&quot;]</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span># 创建pod</span></span>
<span class="line"><span>kubectl create -f pod-hook-exec.yaml</span></span>
<span class="line"><span># 查看pod</span></span>
<span class="line"><span>kubectl get pods  pod-hook-exec -n dev -o wide</span></span>
<span class="line"><span># 访问pod</span></span>
<span class="line"><span>curl 10.244.2.48</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-3-4-容器探测" tabindex="-1"><a class="header-anchor" href="#_5-3-4-容器探测"><span>5.3.4 容器探测</span></a></h3><p>容器探测用于检测容器中的应用实例是否正常工作，是保障业务可用性的一种传统机制。如果经过探测，实例的状态不符合预期，那么kubernetes就会把该问题实例&quot; 摘除 &quot;，不承担业务流量。kubernetes提供了两种探针来实现容器探测，分别是：</p><ul><li><p><strong>liveness probes</strong>：存活性探针，用于检测应用实例当前是否处于正常运行状态，如果不是，k8s会重启容器</p></li><li><p><strong>readiness probes</strong>：就绪性探针，用于检测应用实例当前是否可以接收请求，如果不能，k8s不会转发流量</p></li></ul><p>livenessProbe 决定是否重启容器，readinessProbe 决定是否将请求转发给容器。</p><p>上面两种探针目前均支持三种探测方式：</p><ul><li>Exec命令：在容器内执行一次命令，如果命令执行的退出码为0，则认为程序正常，否则不正常</li></ul><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>……</span></span>
<span class="line"><span>  livenessProbe:</span></span>
<span class="line"><span>    exec:</span></span>
<span class="line"><span>      command:</span></span>
<span class="line"><span>      - cat</span></span>
<span class="line"><span>      - /tmp/healthy</span></span>
<span class="line"><span>……</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>TCPSocket：将会尝试访问一个用户容器的端口，如果能够建立这条连接，则认为程序正常，否则不正常</li></ul><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>……      </span></span>
<span class="line"><span>  livenessProbe:</span></span>
<span class="line"><span>    tcpSocket:</span></span>
<span class="line"><span>      port: 8080</span></span>
<span class="line"><span>……</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>HTTPGet：调用容器内Web应用的URL，如果返回的状态码在200和399之间，则认为程序正常，否则不正常</li></ul><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>……</span></span>
<span class="line"><span>  livenessProbe:</span></span>
<span class="line"><span>    httpGet:</span></span>
<span class="line"><span>      path: / #URI地址</span></span>
<span class="line"><span>      port: 80 #端口号</span></span>
<span class="line"><span>      host: 127.0.0.1 #主机地址</span></span>
<span class="line"><span>      scheme: HTTP #支持的协议，http或者https</span></span>
<span class="line"><span>……</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>方式一：Exec</strong></p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span># pod-liveness-exec.yaml</span></span>
<span class="line"><span>apiVersion: v1</span></span>
<span class="line"><span>kind: Pod</span></span>
<span class="line"><span>metadata:</span></span>
<span class="line"><span>  name: pod-liveness-exec</span></span>
<span class="line"><span>  namespace: dev</span></span>
<span class="line"><span>spec:</span></span>
<span class="line"><span>  containers:</span></span>
<span class="line"><span>  - name: nginx</span></span>
<span class="line"><span>    image: nginx:1.17.1</span></span>
<span class="line"><span>    ports: </span></span>
<span class="line"><span>    - name: nginx-port</span></span>
<span class="line"><span>      containerPort: 80</span></span>
<span class="line"><span>    livenessProbe:</span></span>
<span class="line"><span>      exec:</span></span>
<span class="line"><span>        command: [&quot;/bin/cat&quot;,&quot;/tmp/hello.txt&quot;] # 执行一个查看文件的命令</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span># 创建Pod</span></span>
<span class="line"><span>kubectl create -f pod-liveness-exec.yaml</span></span>
<span class="line"><span># 查看Pod详情</span></span>
<span class="line"><span>kubectl describe pods pod-liveness-exec -n dev</span></span>
<span class="line"><span># 观察上面的信息就会发现nginx容器启动之后就进行了健康检查</span></span>
<span class="line"><span># 检查失败之后，容器被kill掉，然后尝试进行重启（这是重启策略的作用，后面讲解）</span></span>
<span class="line"><span># 稍等一会之后，再观察pod信息，就可以看到RESTARTS不再是0，而是一直增长</span></span>
<span class="line"><span>kubectl get pods pod-liveness-exec -n dev</span></span>
<span class="line"><span># 当然接下来，可以修改成一个存在的文件，比如/tmp/hello.txt，再试，结果就正常了......</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>方式二：TCPSocket</strong></p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span># pod-liveness-tcpsocket.yaml</span></span>
<span class="line"><span>apiVersion: v1</span></span>
<span class="line"><span>kind: Pod</span></span>
<span class="line"><span>metadata:</span></span>
<span class="line"><span>  name: pod-liveness-tcpsocket</span></span>
<span class="line"><span>  namespace: dev</span></span>
<span class="line"><span>spec:</span></span>
<span class="line"><span>  containers:</span></span>
<span class="line"><span>  - name: nginx</span></span>
<span class="line"><span>    image: nginx:1.17.1</span></span>
<span class="line"><span>    ports: </span></span>
<span class="line"><span>    - name: nginx-port</span></span>
<span class="line"><span>      containerPort: 80</span></span>
<span class="line"><span>    livenessProbe:</span></span>
<span class="line"><span>      tcpSocket:</span></span>
<span class="line"><span>        port: 8080 # 尝试访问8080端口</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span># 创建Pod</span></span>
<span class="line"><span>kubectl create -f pod-liveness-tcpsocket.yaml</span></span>
<span class="line"><span># 查看Pod详情</span></span>
<span class="line"><span>kubectl describe pods pod-liveness-tcpsocket -n dev</span></span>
<span class="line"><span># 观察上面的信息，发现尝试访问8080端口,但是失败了</span></span>
<span class="line"><span># 稍等一会之后，再观察pod信息，就可以看到RESTARTS不再是0，而是一直增长</span></span>
<span class="line"><span>kubectl get pods pod-liveness-tcpsocket  -n dev</span></span>
<span class="line"><span># 当然接下来，可以修改成一个可以访问的端口，比如80，再试，结果就正常了......</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>方式三：HTTPGet</strong></p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span># pod-liveness-httpget.yaml</span></span>
<span class="line"><span>apiVersion: v1</span></span>
<span class="line"><span>kind: Pod</span></span>
<span class="line"><span>metadata:</span></span>
<span class="line"><span>  name: pod-liveness-httpget</span></span>
<span class="line"><span>  namespace: dev</span></span>
<span class="line"><span>spec:</span></span>
<span class="line"><span>  containers:</span></span>
<span class="line"><span>  - name: nginx</span></span>
<span class="line"><span>    image: nginx:1.17.1</span></span>
<span class="line"><span>    ports:</span></span>
<span class="line"><span>    - name: nginx-port</span></span>
<span class="line"><span>      containerPort: 80</span></span>
<span class="line"><span>    livenessProbe:</span></span>
<span class="line"><span>      httpGet:  # 其实就是访问http://127.0.0.1:80/hello  </span></span>
<span class="line"><span>        scheme: HTTP #支持的协议，http或者https</span></span>
<span class="line"><span>        port: 80 #端口号</span></span>
<span class="line"><span>        path: /hello #URI地址</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span># 创建Pod</span></span>
<span class="line"><span>kubectl create -f pod-liveness-httpget.yaml</span></span>
<span class="line"><span># 查看Pod详情</span></span>
<span class="line"><span>kubectl describe pod pod-liveness-httpget -n dev</span></span>
<span class="line"><span># 观察上面信息，尝试访问路径，但是未找到,出现404错误</span></span>
<span class="line"><span># 稍等一会之后，再观察pod信息，就可以看到RESTARTS不再是0，而是一直增长</span></span>
<span class="line"><span>kubectl get pod pod-liveness-httpget -n dev</span></span>
<span class="line"><span># 当然接下来，可以修改成一个可以访问的路径path，比如/，再试，结果就正常了......</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span># livenessProbe子属性</span></span>
<span class="line"><span>kubectl explain pod.spec.containers.livenessProbe</span></span>
<span class="line"><span>FIELDS:</span></span>
<span class="line"><span>   exec &lt;Object&gt;  </span></span>
<span class="line"><span>   tcpSocket    &lt;Object&gt;</span></span>
<span class="line"><span>   httpGet      &lt;Object&gt;</span></span>
<span class="line"><span>   initialDelaySeconds  &lt;integer&gt;  # 容器启动后等待多少秒执行第一次探测</span></span>
<span class="line"><span>   timeoutSeconds       &lt;integer&gt;  # 探测超时时间。默认1秒，最小1秒</span></span>
<span class="line"><span>   periodSeconds        &lt;integer&gt;  # 执行探测的频率。默认是10秒，最小1秒</span></span>
<span class="line"><span>   failureThreshold     &lt;integer&gt;  # 连续探测失败多少次才被认定为失败。默认是3。最小值是1</span></span>
<span class="line"><span>   successThreshold     &lt;integer&gt;  # 连续探测成功多少次才被认定为成功。默认是1</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-3-5-重启策略" tabindex="-1"><a class="header-anchor" href="#_5-3-5-重启策略"><span>5.3.5 重启策略</span></a></h3><ul><li><p><strong>Always</strong> ：容器失效时，自动重启该容器，这也是默认值。</p></li><li><p><strong>OnFailure</strong> ： 容器终止运行且退出码不为0时重启</p></li><li><p><strong>Never</strong> ： 不论状态为何，都不重启该容器</p></li></ul><p>重启策略适用于pod对象中的所有容器，首次需要重启的容器，将在其需要时立即进行重启，随后再次需要重启的操作将由kubelet延迟一段时间后进行，且反复的重启操作的延迟时长以此为10s、20s、40s、80s、160s和300s，300s是最大延迟时长。</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span># pod-restartpolicy.yaml</span></span>
<span class="line"><span>apiVersion: v1</span></span>
<span class="line"><span>kind: Pod</span></span>
<span class="line"><span>metadata:</span></span>
<span class="line"><span>  name: pod-restartpolicy</span></span>
<span class="line"><span>  namespace: dev</span></span>
<span class="line"><span>spec:</span></span>
<span class="line"><span>  containers:</span></span>
<span class="line"><span>  - name: nginx</span></span>
<span class="line"><span>    image: nginx:1.17.1</span></span>
<span class="line"><span>    ports:</span></span>
<span class="line"><span>    - name: nginx-port</span></span>
<span class="line"><span>      containerPort: 80</span></span>
<span class="line"><span>    livenessProbe:</span></span>
<span class="line"><span>      httpGet:</span></span>
<span class="line"><span>        scheme: HTTP</span></span>
<span class="line"><span>        port: 80</span></span>
<span class="line"><span>        path: /hello</span></span>
<span class="line"><span>  restartPolicy: Never # 设置重启策略为Never</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span># 创建Pod</span></span>
<span class="line"><span>kubectl create -f pod-restartpolicy.yaml</span></span>
<span class="line"><span># 查看Pod详情，发现nginx容器失败</span></span>
<span class="line"><span>kubectl  describe pods pod-restartpolicy  -n dev</span></span>
<span class="line"><span># 多等一会，再观察pod的重启次数，发现一直是0，并未重启   </span></span>
<span class="line"><span>kubectl  get pods pod-restartpolicy -n dev</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_5-4-pod调度" tabindex="-1"><a class="header-anchor" href="#_5-4-pod调度"><span>5.4 Pod调度</span></a></h2><p>在默认情况下，一个Pod在哪个Node节点上运行，是由Scheduler组件采用相应的算法计算出来的，这个过程是不受人工控制的。但是在实际使用中，这并不满足的需求，因为很多情况下，我们想控制某些Pod到达某些节点上，那么应该怎么做呢？这就要求了解kubernetes对Pod的调度规则，kubernetes提供了四大类调度方式：</p><ul><li><p>自动调度：运行在哪个节点上完全由Scheduler经过一系列的算法计算得出</p></li><li><p>定向调度：NodeName、NodeSelector</p></li><li><p>亲和性调度：NodeAffinity、PodAffinity、PodAntiAffinity</p></li><li><p>污点（容忍）调度：Taints、Toleration</p></li></ul><h3 id="_5-4-1-定向调度【强制策略】" tabindex="-1"><a class="header-anchor" href="#_5-4-1-定向调度【强制策略】"><span>5.4.1 定向调度【强制策略】</span></a></h3><h4 id="nodename" tabindex="-1"><a class="header-anchor" href="#nodename"><span><strong>NodeName</strong></span></a></h4><p>这种方式，其实是直接跳过Scheduler的调度逻辑，直接将Pod调度到指定名称的节点。</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span># pod-nodename.yaml</span></span>
<span class="line"><span>apiVersion: v1</span></span>
<span class="line"><span>kind: Pod</span></span>
<span class="line"><span>metadata:</span></span>
<span class="line"><span>  name: pod-nodename</span></span>
<span class="line"><span>  namespace: dev</span></span>
<span class="line"><span>spec:</span></span>
<span class="line"><span>  containers:</span></span>
<span class="line"><span>  - name: nginx</span></span>
<span class="line"><span>    image: nginx:1.17.1</span></span>
<span class="line"><span>  nodeName: node1 # 指定调度到node1节点上</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="nodeselector" tabindex="-1"><a class="header-anchor" href="#nodeselector"><span><strong>NodeSelector</strong></span></a></h4><p>NodeSelector用于将pod调度到添加了指定标签的node节点上。</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>kubectl label nodes node1 nodeenv=pro</span></span>
<span class="line"><span>ubectl label nodes node2 nodeenv=test</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span># pod-nodeselector.yaml</span></span>
<span class="line"><span>apiVersion: v1</span></span>
<span class="line"><span>kind: Pod</span></span>
<span class="line"><span>metadata:</span></span>
<span class="line"><span>  name: pod-nodeselector</span></span>
<span class="line"><span>  namespace: dev</span></span>
<span class="line"><span>spec:</span></span>
<span class="line"><span>  containers:</span></span>
<span class="line"><span>  - name: nginx</span></span>
<span class="line"><span>    image: nginx:1.17.1</span></span>
<span class="line"><span>  nodeSelector: </span></span>
<span class="line"><span>    nodeenv: pro # 指定调度到具有nodeenv=pro标签的节点上</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-4-2-亲和性调度" tabindex="-1"><a class="header-anchor" href="#_5-4-2-亲和性调度"><span>5.4.2 亲和性调度</span></a></h3><p>上一节，介绍了两种定向调度的方式，使用起来非常方便，但是也有一定的问题，那就是如果没有满足条件的Node，那么Pod将不会被运行，即使在集群中还有可用Node列表也不行，这就限制了它的使用场景。</p><p>基于上面的问题，kubernetes还提供了一种亲和性调度（Affinity）。它在NodeSelector的基础之上的进行了扩展，可以通过配置的形式，实现优先选择满足条件的Node进行调度，如果没有，也可以调度到不满足条件的节点上，使调度更加灵活。</p><p>Affinity主要分为三类：</p><ul><li><p><strong>nodeAffinity(node亲和性）</strong>: 以node为目标，解决pod可以调度到哪些node的问题</p></li><li><p><strong>podAffinity(pod亲和性)</strong> : 以pod为目标，解决pod可以和哪些已存在的pod部署在同一个拓扑域中的问题</p></li><li><p><strong>podAntiAffinity(pod反亲和性)</strong> : 以pod为目标，解决pod不能和哪些已存在pod部署在同一个拓扑域中的问题</p></li></ul><p>关于亲和性(反亲和性)使用场景的说明：</p><p><strong>亲和性</strong>：如果两个应用频繁交互，那就有必要利用亲和性让两个应用的尽可能的靠近，这样可以减少因网络通信而带来的性能损耗。</p><p><strong>反亲和性</strong>：当应用的采用多副本部署时，有必要采用反亲和性让各个应用实例打散分布在各个node上，这样可以提高服务的高可用性。</p><h4 id="nodeaffinity" tabindex="-1"><a class="header-anchor" href="#nodeaffinity"><span><strong>NodeAffinity</strong></span></a></h4><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span># 首先来看一下`NodeAffinity`的可配置项：</span></span>
<span class="line"><span>pod.spec.affinity.nodeAffinity</span></span>
<span class="line"><span>  requiredDuringSchedulingIgnoredDuringExecution  #Node节点必须满足指定的所有规则才可以，相当于硬限制</span></span>
<span class="line"><span>    nodeSelectorTerms  #节点选择列表</span></span>
<span class="line"><span>      matchFields   #按节点字段列出的节点选择器要求列表</span></span>
<span class="line"><span>      matchExpressions   #按节点标签列出的节点选择器要求列表(推荐)</span></span>
<span class="line"><span>        key    #键</span></span>
<span class="line"><span>        values #值</span></span>
<span class="line"><span>        operator #关系符 支持Exists, DoesNotExist, In, NotIn, Gt, Lt</span></span>
<span class="line"><span>  preferredDuringSchedulingIgnoredDuringExecution #优先调度到满足指定的规则的Node，相当于软限制 (倾向)</span></span>
<span class="line"><span>    preference   #一个节点选择器项，与相应的权重相关联</span></span>
<span class="line"><span>      matchFields   #按节点字段列出的节点选择器要求列表</span></span>
<span class="line"><span>      matchExpressions   #按节点标签列出的节点选择器要求列表(推荐)</span></span>
<span class="line"><span>        key    #键</span></span>
<span class="line"><span>        values #值</span></span>
<span class="line"><span>        operator #关系符 支持In, NotIn, Exists, DoesNotExist, Gt, Lt</span></span>
<span class="line"><span>	weight #倾向权重，在范围1-100。</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>#关系符的使用说明:</span></span>
<span class="line"><span>- matchExpressions:</span></span>
<span class="line"><span>  - key: nodeenv              # 匹配存在标签的key为nodeenv的节点</span></span>
<span class="line"><span>    operator: Exists</span></span>
<span class="line"><span>  - key: nodeenv              # 匹配标签的key为nodeenv,且value是&quot;xxx&quot;或&quot;yyy&quot;的节点</span></span>
<span class="line"><span>    operator: In</span></span>
<span class="line"><span>    values: [&quot;xxx&quot;,&quot;yyy&quot;]</span></span>
<span class="line"><span>  - key: nodeenv              # 匹配标签的key为nodeenv,且value大于&quot;xxx&quot;的节点</span></span>
<span class="line"><span>    operator: Gt</span></span>
<span class="line"><span>    values: &quot;xxx&quot;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span># requiredDuringSchedulingIgnoredDuringExecution</span></span>
<span class="line"><span># pod-nodeaffinity-required.yaml</span></span>
<span class="line"><span>apiVersion: v1</span></span>
<span class="line"><span>kind: Pod</span></span>
<span class="line"><span>metadata:</span></span>
<span class="line"><span>  name: pod-nodeaffinity-required</span></span>
<span class="line"><span>  namespace: dev</span></span>
<span class="line"><span>spec:</span></span>
<span class="line"><span>  containers:</span></span>
<span class="line"><span>  - name: nginx</span></span>
<span class="line"><span>    image: nginx:1.17.1</span></span>
<span class="line"><span>  affinity:  #亲和性设置</span></span>
<span class="line"><span>    nodeAffinity: #设置node亲和性</span></span>
<span class="line"><span>      requiredDuringSchedulingIgnoredDuringExecution: # 硬限制，需要满足以下的至少一个</span></span>
<span class="line"><span>        nodeSelectorTerms:</span></span>
<span class="line"><span>        - matchExpressions: # 匹配env的值在[&quot;xxx&quot;,&quot;yyy&quot;]中的标签</span></span>
<span class="line"><span>          - key: nodeenv</span></span>
<span class="line"><span>            operator: In</span></span>
<span class="line"><span>            values: [&quot;xxx&quot;,&quot;yyy&quot;]</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span># requiredDuringSchedulingIgnoredDuringExecution</span></span>
<span class="line"><span># pod-nodeaffinity-preferred.yaml</span></span>
<span class="line"><span>apiVersion: v1</span></span>
<span class="line"><span>kind: Pod</span></span>
<span class="line"><span>metadata:</span></span>
<span class="line"><span>  name: pod-nodeaffinity-preferred</span></span>
<span class="line"><span>  namespace: dev</span></span>
<span class="line"><span>spec:</span></span>
<span class="line"><span>  containers:</span></span>
<span class="line"><span>  - name: nginx</span></span>
<span class="line"><span>    image: nginx:1.17.1</span></span>
<span class="line"><span>  affinity:  #亲和性设置</span></span>
<span class="line"><span>    nodeAffinity: #设置node亲和性</span></span>
<span class="line"><span>      preferredDuringSchedulingIgnoredDuringExecution: # 软限制</span></span>
<span class="line"><span>      - weight: 1</span></span>
<span class="line"><span>        preference:</span></span>
<span class="line"><span>          matchExpressions: # 匹配env的值在[&quot;xxx&quot;,&quot;yyy&quot;]中的标签(当前环境没有)</span></span>
<span class="line"><span>          - key: nodeenv</span></span>
<span class="line"><span>            operator: In</span></span>
<span class="line"><span>            values: [&quot;xxx&quot;,&quot;yyy&quot;]</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>NodeAffinity规则设置的注意事项：</strong></p><ol><li><p>如果同时定义了nodeSelector和nodeAffinity，那么必须两个条件都得到满足，Pod才能运行在指定的Node上</p></li><li><p>如果nodeAffinity指定了多个nodeSelectorTerms，那么只需要其中一个能够匹配成功即可</p></li><li><p>如果一个nodeSelectorTerms中有多个matchExpressions ，则一个节点必须满足所有的才能匹配成功</p></li><li><p>如果一个pod所在的Node在Pod运行期间其标签发生了改变，不再符合该Pod的节点亲和性需求，则<strong>系统将忽略此变化</strong></p></li></ol><h4 id="podaffinity" tabindex="-1"><a class="header-anchor" href="#podaffinity"><span><strong>PodAffinity</strong></span></a></h4><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span># 首先来看一下`PodAffinity`的可配置项：</span></span>
<span class="line"><span>pod.spec.affinity.podAffinity</span></span>
<span class="line"><span>  requiredDuringSchedulingIgnoredDuringExecution  硬限制</span></span>
<span class="line"><span>    namespaces       # 指定参照pod的namespace</span></span>
<span class="line"><span>    topologyKey      # 指定调度作用域</span></span>
<span class="line"><span>    labelSelector    # 标签选择器</span></span>
<span class="line"><span>      matchExpressions  # 按节点标签列出的节点选择器要求列表(推荐)</span></span>
<span class="line"><span>        key    # 键</span></span>
<span class="line"><span>        values # 值</span></span>
<span class="line"><span>        operator # 关系符 支持In, NotIn, Exists, DoesNotExist.</span></span>
<span class="line"><span>      matchLabels    # 指多个matchExpressions映射的内容</span></span>
<span class="line"><span>  preferredDuringSchedulingIgnoredDuringExecution # 软限制</span></span>
<span class="line"><span>    podAffinityTerm  # 选项</span></span>
<span class="line"><span>      namespaces      </span></span>
<span class="line"><span>      topologyKey</span></span>
<span class="line"><span>      labelSelector</span></span>
<span class="line"><span>        matchExpressions  </span></span>
<span class="line"><span>          key    # 键</span></span>
<span class="line"><span>          values # 值</span></span>
<span class="line"><span>          operator</span></span>
<span class="line"><span>        matchLabels </span></span>
<span class="line"><span>    weight # 倾向权重，在范围1-100</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>topologyKey 用于指定调度时作用域,例如:</span></span>
<span class="line"><span>    如果指定为kubernetes.io/hostname，那就是以Node节点为区分范围</span></span>
<span class="line"><span>	  如果指定为beta.kubernetes.io/os,则以Node节点的操作系统类型来区分</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span># pod-podaffinity-required.yaml</span></span>
<span class="line"><span>apiVersion: v1</span></span>
<span class="line"><span>kind: Pod</span></span>
<span class="line"><span>metadata:</span></span>
<span class="line"><span>  name: pod-podaffinity-required</span></span>
<span class="line"><span>  namespace: dev</span></span>
<span class="line"><span>spec:</span></span>
<span class="line"><span>  containers:</span></span>
<span class="line"><span>  - name: nginx</span></span>
<span class="line"><span>    image: nginx:1.17.1</span></span>
<span class="line"><span>  affinity:  #亲和性设置</span></span>
<span class="line"><span>    podAffinity: #设置pod亲和性</span></span>
<span class="line"><span>      requiredDuringSchedulingIgnoredDuringExecution: # 硬限制</span></span>
<span class="line"><span>      - labelSelector:</span></span>
<span class="line"><span>          matchExpressions: # 匹配env的值在[&quot;xxx&quot;,&quot;yyy&quot;]中的标签</span></span>
<span class="line"><span>          - key: podenv</span></span>
<span class="line"><span>            operator: In</span></span>
<span class="line"><span>            values: [&quot;xxx&quot;,&quot;yyy&quot;]</span></span>
<span class="line"><span>        topologyKey: kubernetes.io/hostname</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="podantiaffinity" tabindex="-1"><a class="header-anchor" href="#podantiaffinity"><span><strong>PodAntiAffinity</strong></span></a></h4><p>PodAntiAffinity主要实现以运行的Pod为参照，新创建的Pod跟参照pod不在一个区域中的功能。与上面的PodAffinity是一种相反策略</p><h3 id="_5-4-3-污点和容忍" tabindex="-1"><a class="header-anchor" href="#_5-4-3-污点和容忍"><span>5.4.3 污点和容忍</span></a></h3><p><strong>污点（Taints）</strong><br> 前面的调度方式都是站在Pod的角度上，通过在Pod上添加属性，来确定Pod是否要调度到指定的Node上，其实我们也可以站在Node的角度上，通过在Node上添加<strong>污点</strong>属性，来决定是否允许Pod调度过来。<br><strong>Node被设置上污点之后就和Pod之间存在了一种相斥的关系，进而拒绝Pod调度进来，甚至可以将已经存在的Pod驱逐出去。</strong><br> 污点的格式为：key=value:effect, key和value是污点的标签，effect描述污点的作用，支持如下三个选项：</p><ul><li><strong>PreferNoSchedule</strong>：kubernetes将尽量避免把Pod调度到具有该污点的Node上，除非没有其他节点可调度</li><li><strong>NoSchedule</strong>：kubernetes将不会把Pod调度到具有该污点的Node上，但不会影响当前Node上已存在的Pod</li><li><strong>NoExecute</strong>：kubernetes将不会把Pod调度到具有该污点的Node上，同时也会将Node上已存在的Pod驱离</li></ul><h4 id="污点api" tabindex="-1"><a class="header-anchor" href="#污点api"><span>污点API</span></a></h4><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span># 设置污点</span></span>
<span class="line"><span>kubectl taint nodes k8s.node1 key=value:policy</span></span>
<span class="line"><span># 去除污点</span></span>
<span class="line"><span>kubectl taint nodes k8s.node2 key:policy-</span></span>
<span class="line"><span># 去除所有污点</span></span>
<span class="line"><span>kubectl taint nodes k8s.node2 key-</span></span>
<span class="line"><span># 查看污点</span></span>
<span class="line"><span>kubectl describe node k8s.node1 | grep Taints</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>注意：使用kubeadm搭建的集群，默认就会给master节点添加一个污点标记,所以pod就不会调度到master节点上.</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><strong>容忍（Toleration）</strong></p><p>污点就是拒绝，容忍就是忽略，Node通过污点拒绝pod调度上去，Pod通过容忍忽略拒绝</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span># pod-toleration.yaml</span></span>
<span class="line"><span>apiVersion: v1</span></span>
<span class="line"><span>kind: Pod</span></span>
<span class="line"><span>metadata:</span></span>
<span class="line"><span>  name: pod-toleration</span></span>
<span class="line"><span>  namespace: dev</span></span>
<span class="line"><span>spec:</span></span>
<span class="line"><span>  containers:</span></span>
<span class="line"><span>  - name: nginx</span></span>
<span class="line"><span>    image: nginx:1.17.1</span></span>
<span class="line"><span>  tolerations:      # 添加容忍</span></span>
<span class="line"><span>  - key: &quot;tag&quot;        # 要容忍的污点的key  </span></span>
<span class="line"><span>    operator: &quot;Equal&quot; # 操作符  EqualExists（默认）</span></span>
<span class="line"><span>    value: &quot;heima&quot;    # 容忍的污点的value</span></span>
<span class="line"><span>    effect: &quot;NoExecute&quot;   # 添加容忍的规则，这里必须和标记的污点规则相同</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>kubectl explain pod.spec.tolerations</span></span>
<span class="line"><span>......</span></span>
<span class="line"><span>FIELDS:</span></span>
<span class="line"><span>   key       # 对应着要容忍的污点的键，空意味着匹配所有的键</span></span>
<span class="line"><span>   value     # 对应着要容忍的污点的值</span></span>
<span class="line"><span>   operator  # key-value的运算符，支持Equal和Exists（默认）</span></span>
<span class="line"><span>   effect    # 对应污点的effect，空意味着匹配所有影响</span></span>
<span class="line"><span>   tolerationSeconds   # 容忍时间, 当effect为NoExecute时生效，表示pod在Node上的停留时间</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h1 id="_6-pod控制器详解" tabindex="-1"><a class="header-anchor" href="#_6-pod控制器详解"><span>6. Pod控制器详解</span></a></h1><h2 id="_6-1-pod控制器介绍" tabindex="-1"><a class="header-anchor" href="#_6-1-pod控制器介绍"><span>6.1 Pod控制器介绍</span></a></h2><p>Pod是kubernetes的最小管理单元，在kubernetes中，按照pod的创建方式可以将其分为两类：</p><ul><li><p>自主式pod：kubernetes直接创建出来的Pod，这种pod删除后就没有了，也不会重建</p></li><li><p>控制器创建的pod：kubernetes通过控制器创建的pod，这种pod删除了之后还会自动重建</p></li></ul><p><strong>什么是Pod控制器</strong><br> Pod控制器是管理pod的中间层，使用Pod控制器之后，只需要告诉Pod控制器，想要多少个什么样的Pod就可以了，它会创建出满足条件的Pod并确保每一个Pod资源处于用户期望的目标状态。如果Pod资源在运行中出现故障，它会基于指定策略重新编排Pod。<br> 在kubernetes中，有很多类型的pod控制器，每种都有自己的适合的场景，常见的有下面这些：</p><ul><li>ReplicationController：比较原始的pod控制器，已经被废弃，由ReplicaSet替代</li><li>ReplicaSet：保证副本数量一直维持在期望值，并支持pod数量扩缩容，镜像版本升级</li><li><strong>Deployment</strong>：通过控制ReplicaSet来控制Pod，并支持滚动升级、回退版本</li><li>Horizontal Pod Autoscaler：可以根据集群负载自动水平调整Pod的数量，实现削峰填谷</li><li>DaemonSet：在集群中的指定Node上运行且仅运行一个副本，一般用于守护进程类的任务</li><li>Job：它创建出来的pod只要完成任务就立即退出，不需要重启或重建，用于执行一次性任务</li><li>Cronjob：它创建的Pod负责周期性任务控制，不需要持续后台运行</li><li>StatefulSet：管理有状态应用</li></ul><h2 id="_6-2-replicaset-rs" tabindex="-1"><a class="header-anchor" href="#_6-2-replicaset-rs"><span>6.2 ReplicaSet(RS)</span></a></h2><p>ReplicaSet的主要作用是<strong>保证一定数量的pod正常运行</strong>，它会持续监听这些Pod的运行状态，一旦Pod发生故障，就会重启或重建。同时它还支持对pod数量的扩缩容和镜像版本的升降级。</p><p>ReplicaSet的资源清单文件：</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>apiVersion: apps/v1 # 版本号</span></span>
<span class="line"><span>kind: ReplicaSet # 类型       </span></span>
<span class="line"><span>metadata: # 元数据</span></span>
<span class="line"><span>  name: # rs名称 </span></span>
<span class="line"><span>  namespace: # 所属命名空间 </span></span>
<span class="line"><span>  labels: #标签</span></span>
<span class="line"><span>    controller: rs</span></span>
<span class="line"><span>spec: # 详情描述</span></span>
<span class="line"><span>  replicas: 3 # 副本数量</span></span>
<span class="line"><span>  selector: # 选择器，通过它指定该控制器管理哪些pod</span></span>
<span class="line"><span>    matchLabels:      # Labels匹配规则</span></span>
<span class="line"><span>      app: nginx-pod</span></span>
<span class="line"><span>    matchExpressions: # Expressions匹配规则</span></span>
<span class="line"><span>      - {key: app, operator: In, values: [nginx-pod]}</span></span>
<span class="line"><span>  template: # 模板，当副本数量不足时，会根据下面的模板创建pod副本</span></span>
<span class="line"><span>    metadata:</span></span>
<span class="line"><span>      labels:</span></span>
<span class="line"><span>        app: nginx-pod</span></span>
<span class="line"><span>    spec:</span></span>
<span class="line"><span>      containers:</span></span>
<span class="line"><span>      - name: nginx</span></span>
<span class="line"><span>        image: nginx:1.17.1</span></span>
<span class="line"><span>        ports:</span></span>
<span class="line"><span>        - containerPort: 80</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在这里面，需要新了解的配置项就是spec下面几个选项：</p><ul><li>replicas：指定副本数量，其实就是当前rs创建出来的pod的数量，默认为1</li><li>selector：选择器，它的作用是建立pod控制器和pod之间的关联关系，采用的Label Selector机制在pod模板上定义label，在控制器上定义选择器，就可以表明当前控制器能管理哪些pod了</li><li>template：模板，就是当前控制器创建pod所使用的模板板，里面其实就是前一章学过的pod的定义</li></ul><h3 id="replicaset-demo" tabindex="-1"><a class="header-anchor" href="#replicaset-demo"><span><strong>ReplicaSet Demo</strong></span></a></h3><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span># pc-replicaset.yaml</span></span>
<span class="line"><span>apiVersion: apps/v1</span></span>
<span class="line"><span>kind: ReplicaSet   </span></span>
<span class="line"><span>metadata:</span></span>
<span class="line"><span>  name: pc-replicaset</span></span>
<span class="line"><span>  namespace: dev</span></span>
<span class="line"><span>spec:</span></span>
<span class="line"><span>  replicas: 3</span></span>
<span class="line"><span>  selector: </span></span>
<span class="line"><span>    matchLabels:</span></span>
<span class="line"><span>      app: nginx-pod</span></span>
<span class="line"><span>  template:</span></span>
<span class="line"><span>    metadata:</span></span>
<span class="line"><span>      labels:</span></span>
<span class="line"><span>        app: nginx-pod</span></span>
<span class="line"><span>    spec:</span></span>
<span class="line"><span>      containers:</span></span>
<span class="line"><span>      - name: nginx</span></span>
<span class="line"><span>        image: nginx:1.17.1</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span># 创建rs</span></span>
<span class="line"><span>kubectl create -f pc-replicaset.yaml</span></span>
<span class="line"><span># 查看rs</span></span>
<span class="line"><span># DESIRED:期望副本数量  </span></span>
<span class="line"><span># CURRENT:当前副本数量  </span></span>
<span class="line"><span># READY:已经准备好提供服务的副本数量</span></span>
<span class="line"><span>kubectl get rs pc-replicaset -n dev -o wide</span></span>
<span class="line"><span># 查看当前控制器创建出来的pod</span></span>
<span class="line"><span># 这里发现控制器创建出来的pod的名称是在控制器名称后面拼接了-xxxxx随机码</span></span>
<span class="line"><span>kubectl get pod -n dev</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="扩缩容" tabindex="-1"><a class="header-anchor" href="#扩缩容"><span><strong>扩缩容</strong></span></a></h3><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span># 编辑rs的副本数量，修改spec:replicas: 6即可</span></span>
<span class="line"><span>kubectl edit rs pc-replicaset -n dev</span></span>
<span class="line"><span># 查看pod</span></span>
<span class="line"><span>kubectl get pods -n dev</span></span>
<span class="line"><span># 当然也可以直接使用命令实现</span></span>
<span class="line"><span># 使用scale命令实现扩缩容， 后面--replicas=n直接指定目标数量即可</span></span>
<span class="line"><span>kubectl scale rs pc-replicaset --replicas=2 -n dev</span></span>
<span class="line"><span># 命令运行完毕，立即查看，发现已经有4个开始准备退出了</span></span>
<span class="line"><span>kubectl get pods -n dev</span></span>
<span class="line"><span>#稍等片刻，就只剩下2个了</span></span>
<span class="line"><span>kubectl get pods -n dev</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="镜像升级" tabindex="-1"><a class="header-anchor" href="#镜像升级"><span><strong>镜像升级</strong></span></a></h3><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span># 编辑rs的容器镜像 - image: nginx:1.17.2</span></span>
<span class="line"><span>kubectl edit rs pc-replicaset -n dev</span></span>
<span class="line"><span># 再次查看，发现镜像版本已经变更了</span></span>
<span class="line"><span>kubectl get rs -n dev -o wide</span></span>
<span class="line"><span># 同样的道理，也可以使用命令完成这个工作</span></span>
<span class="line"><span># kubectl set image rs rs名称 容器=镜像版本 -n namespace</span></span>
<span class="line"><span>kubectl set image rs pc-replicaset nginx=nginx:1.17.1  -n dev</span></span>
<span class="line"><span># 再次查看，发现镜像版本已经变更了</span></span>
<span class="line"><span>kubectl get rs -n dev -o wide</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="删除replicaset" tabindex="-1"><a class="header-anchor" href="#删除replicaset"><span><strong>删除ReplicaSet</strong></span></a></h3><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span># 使用kubectl delete命令会删除此RS以及它管理的Pod</span></span>
<span class="line"><span># 在kubernetes删除RS前，会将RS的replicasclear调整为0，等待所有的Pod被删除后，在执行RS对象的删除</span></span>
<span class="line"><span>kubectl delete rs pc-replicaset -n dev</span></span>
<span class="line"><span>kubectl get pod -n dev -o wide</span></span>
<span class="line"><span># 如果希望仅仅删除RS对象（保留Pod），可以使用kubectl delete命令时添加--cascade=false选项（不推荐）。</span></span>
<span class="line"><span>kubectl delete rs pc-replicaset -n dev --cascade=false</span></span>
<span class="line"><span>kubectl get pods -n dev</span></span>
<span class="line"><span># 也可以使用yaml直接删除(推荐)</span></span>
<span class="line"><span>kubectl delete -f pc-replicaset.yaml</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_6-3-deployment-deploy" tabindex="-1"><a class="header-anchor" href="#_6-3-deployment-deploy"><span>6.3 Deployment(Deploy)</span></a></h2><p>为了更好的解决服务编排的问题，kubernetes在V1.2版本开始，引入了Deployment控制器。值得一提的是，这种控制器并不直接管理pod，而是通过管理ReplicaSet来简介管理Pod，即：Deployment管理ReplicaSet，ReplicaSet管理Pod。所以Deployment比ReplicaSet功能更加强大。</p><p>Deployment主要功能有下面几个：</p><ul><li><p>支持ReplicaSet的所有功能</p></li><li><p>支持发布的停止、继续</p></li><li><p>支持滚动升级和回滚版本</p></li></ul><p>Deployment的资源清单文件：</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>apiVersion: apps/v1 # 版本号</span></span>
<span class="line"><span>kind: Deployment # 类型       </span></span>
<span class="line"><span>metadata: # 元数据</span></span>
<span class="line"><span>  name: # rs名称 </span></span>
<span class="line"><span>  namespace: # 所属命名空间 </span></span>
<span class="line"><span>  labels: #标签</span></span>
<span class="line"><span>    controller: deploy</span></span>
<span class="line"><span>spec: # 详情描述</span></span>
<span class="line"><span>  replicas: 3 # 副本数量</span></span>
<span class="line"><span>  revisionHistoryLimit: 3 # 保留历史版本，版本回退时用的</span></span>
<span class="line"><span>  paused: false # 暂停部署，默认是false  deployment -&gt; pod 部署 是否立即执行</span></span>
<span class="line"><span>  progressDeadlineSeconds: 600 # 部署超时时间（s），默认是600</span></span>
<span class="line"><span>  strategy: # 策略</span></span>
<span class="line"><span>    type: RollingUpdate # 滚动更新策略</span></span>
<span class="line"><span>    rollingUpdate: # 滚动更新</span></span>
<span class="line"><span>      maxSurge: 30% # 最大额外可以存在的副本数，可以为百分比，也可以为整数</span></span>
<span class="line"><span>      maxUnavailable: 30% # 最大不可用状态的 Pod 的最大值，可以为百分比，也可以为整数</span></span>
<span class="line"><span>  selector: # 选择器，通过它指定该控制器管理哪些pod</span></span>
<span class="line"><span>    matchLabels:      # Labels匹配规则</span></span>
<span class="line"><span>      app: nginx-pod</span></span>
<span class="line"><span>    matchExpressions: # Expressions匹配规则</span></span>
<span class="line"><span>      - {key: app, operator: In, values: [nginx-pod]}</span></span>
<span class="line"><span>  template: # 模板，当副本数量不足时，会根据下面的模板创建pod副本</span></span>
<span class="line"><span>    metadata:</span></span>
<span class="line"><span>      labels:</span></span>
<span class="line"><span>        app: nginx-pod</span></span>
<span class="line"><span>    spec:</span></span>
<span class="line"><span>      containers:</span></span>
<span class="line"><span>      - name: nginx</span></span>
<span class="line"><span>        image: nginx:1.17.1</span></span>
<span class="line"><span>        ports:</span></span>
<span class="line"><span>        - containerPort: 80</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>Deployment Demo</strong></p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span># pc-deployment.yaml</span></span>
<span class="line"><span>apiVersion: apps/v1</span></span>
<span class="line"><span>kind: Deployment      </span></span>
<span class="line"><span>metadata:</span></span>
<span class="line"><span>  name: pc-deployment</span></span>
<span class="line"><span>  namespace: dev</span></span>
<span class="line"><span>spec: </span></span>
<span class="line"><span>  replicas: 3</span></span>
<span class="line"><span>  selector:</span></span>
<span class="line"><span>    matchLabels:</span></span>
<span class="line"><span>      app: nginx-pod</span></span>
<span class="line"><span>  template:</span></span>
<span class="line"><span>    metadata:</span></span>
<span class="line"><span>      labels:</span></span>
<span class="line"><span>        app: nginx-pod</span></span>
<span class="line"><span>    spec:</span></span>
<span class="line"><span>      containers:</span></span>
<span class="line"><span>      - name: nginx</span></span>
<span class="line"><span>        image: nginx:1.17.1</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span># 创建deployment</span></span>
<span class="line"><span>[root@k8s-master01 ~]# kubectl create -f pc-deployment.yaml --record=true</span></span>
<span class="line"><span>deployment.apps/pc-deployment created</span></span>
<span class="line"><span></span></span>
<span class="line"><span># 查看deployment</span></span>
<span class="line"><span># UP-TO-DATE 最新版本的pod的数量</span></span>
<span class="line"><span># AVAILABLE  当前可用的pod的数量</span></span>
<span class="line"><span>[root@k8s-master01 ~]# kubectl get deploy pc-deployment -n dev</span></span>
<span class="line"><span>NAME            READY   UP-TO-DATE   AVAILABLE   AGE</span></span>
<span class="line"><span>pc-deployment   3/3     3            3           15s</span></span>
<span class="line"><span></span></span>
<span class="line"><span># 查看rs</span></span>
<span class="line"><span># 发现rs的名称是在原来deployment的名字后面添加了一个10位数的随机串</span></span>
<span class="line"><span>[root@k8s-master01 ~]# kubectl get rs -n dev</span></span>
<span class="line"><span>NAME                       DESIRED   CURRENT   READY   AGE</span></span>
<span class="line"><span>pc-deployment-6696798b78   3         3         3       23s</span></span>
<span class="line"><span></span></span>
<span class="line"><span># 查看pod</span></span>
<span class="line"><span>[root@k8s-master01 ~]# kubectl get pods -n dev</span></span>
<span class="line"><span>NAME                             READY   STATUS    RESTARTS   AGE</span></span>
<span class="line"><span>pc-deployment-6696798b78-d2c8n   1/1     Running   0          107s</span></span>
<span class="line"><span>pc-deployment-6696798b78-smpvp   1/1     Running   0          107s</span></span>
<span class="line"><span>pc-deployment-6696798b78-wvjd8   1/1     Running   0          107s</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="扩缩容-1" tabindex="-1"><a class="header-anchor" href="#扩缩容-1"><span><strong>扩缩容</strong></span></a></h3><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span># 变更副本数量为5个</span></span>
<span class="line"><span>kubectl scale deploy pc-deployment --replicas=5  -n dev</span></span>
<span class="line"><span># 查看deployment</span></span>
<span class="line"><span>kubectl get deploy pc-deployment -n dev</span></span>
<span class="line"><span># 查看pod</span></span>
<span class="line"><span>kubectl get pods -n dev</span></span>
<span class="line"><span># 编辑deployment的副本数量，修改spec:replicas: 4即可</span></span>
<span class="line"><span>kubectl edit deploy pc-deployment -n dev</span></span>
<span class="line"><span># 查看pod</span></span>
<span class="line"><span>kubectl get pods -n dev</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="镜像更新" tabindex="-1"><a class="header-anchor" href="#镜像更新"><span><strong>镜像更新</strong></span></a></h3><p>deployment支持两种更新策略:重建更新和滚动更新,可以通过strategy指定策略类型,支持两个属性:</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>strategy：指定新的Pod替换旧的Pod的策略， 支持两个属性：</span></span>
<span class="line"><span>  type：指定策略类型，支持两种策略</span></span>
<span class="line"><span>    Recreate：在创建出新的Pod之前会先杀掉所有已存在的Pod</span></span>
<span class="line"><span>    RollingUpdate：滚动更新，就是杀死一部分，就启动一部分，在更新过程中，存在两个版本Pod</span></span>
<span class="line"><span>  rollingUpdate：当type为RollingUpdate时生效，用于为RollingUpdate设置参数，支持两个属性：</span></span>
<span class="line"><span>    maxUnavailable：用来指定在升级过程中不可用Pod的最大数量，默认为25%。</span></span>
<span class="line"><span>    maxSurge： 用来指定在升级过程中可以超过期望的Pod的最大数量，默认为25%。</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="重建更新" tabindex="-1"><a class="header-anchor" href="#重建更新"><span>重建更新</span></a></h4><ol><li>编辑pc-deployment.yaml,在spec节点下添加更新策略</li></ol><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>spec:</span></span>
<span class="line"><span>  strategy: # 策略</span></span>
<span class="line"><span>    type: Recreate # 重建更新</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol><li>创建deploy进行验证</li></ol><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span># 变更镜像</span></span>
<span class="line"><span>kubectl set image deployment pc-deployment nginx=nginx:1.17.2 -n dev</span></span>
<span class="line"><span># 观察升级过程</span></span>
<span class="line"><span>[root@k8s-master01 ~]#  kubectl get pods -n dev -w</span></span>
<span class="line"><span>NAME                             READY   STATUS    RESTARTS   AGE</span></span>
<span class="line"><span>pc-deployment-5d89bdfbf9-65qcw   1/1     Running   0          31s</span></span>
<span class="line"><span>pc-deployment-5d89bdfbf9-w5nzv   1/1     Running   0          31s</span></span>
<span class="line"><span>pc-deployment-5d89bdfbf9-xpt7w   1/1     Running   0          31s</span></span>
<span class="line"><span></span></span>
<span class="line"><span>pc-deployment-5d89bdfbf9-xpt7w   1/1     Terminating   0          41s</span></span>
<span class="line"><span>pc-deployment-5d89bdfbf9-65qcw   1/1     Terminating   0          41s</span></span>
<span class="line"><span>pc-deployment-5d89bdfbf9-w5nzv   1/1     Terminating   0          41s</span></span>
<span class="line"><span></span></span>
<span class="line"><span>pc-deployment-675d469f8b-grn8z   0/1     Pending       0          0s</span></span>
<span class="line"><span>pc-deployment-675d469f8b-hbl4v   0/1     Pending       0          0s</span></span>
<span class="line"><span>pc-deployment-675d469f8b-67nz2   0/1     Pending       0          0s</span></span>
<span class="line"><span></span></span>
<span class="line"><span>pc-deployment-675d469f8b-grn8z   0/1     ContainerCreating   0          0s</span></span>
<span class="line"><span>pc-deployment-675d469f8b-hbl4v   0/1     ContainerCreating   0          0s</span></span>
<span class="line"><span>pc-deployment-675d469f8b-67nz2   0/1     ContainerCreating   0          0s</span></span>
<span class="line"><span></span></span>
<span class="line"><span>pc-deployment-675d469f8b-grn8z   1/1     Running             0          1s</span></span>
<span class="line"><span>pc-deployment-675d469f8b-67nz2   1/1     Running             0          1s</span></span>
<span class="line"><span>pc-deployment-675d469f8b-hbl4v   1/1     Running             0          2s</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="滚动更新" tabindex="-1"><a class="header-anchor" href="#滚动更新"><span>滚动更新</span></a></h4><ol><li>编辑pc-deployment.yaml,在spec节点下添加更新策略</li></ol><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span># pc-deployment.yaml</span></span>
<span class="line"><span>apiVersion: apps/v1</span></span>
<span class="line"><span>kind: Deployment      </span></span>
<span class="line"><span>metadata:</span></span>
<span class="line"><span>  name: pc-deployment</span></span>
<span class="line"><span>  namespace: dev</span></span>
<span class="line"><span>spec: </span></span>
<span class="line"><span>  replicas: 3</span></span>
<span class="line"><span>  selector:</span></span>
<span class="line"><span>    matchLabels:</span></span>
<span class="line"><span>      app: nginx-pod</span></span>
<span class="line"><span>  strategy: # 策略</span></span>
<span class="line"><span>    type: RollingUpdate # 滚动更新策略</span></span>
<span class="line"><span>    rollingUpdate:</span></span>
<span class="line"><span>      maxSurge: 25% </span></span>
<span class="line"><span>      maxUnavailable: 25%</span></span>
<span class="line"><span>  template:</span></span>
<span class="line"><span>    metadata:</span></span>
<span class="line"><span>      labels:</span></span>
<span class="line"><span>        app: nginx-pod</span></span>
<span class="line"><span>    spec:</span></span>
<span class="line"><span>      containers:</span></span>
<span class="line"><span>      - name: nginx</span></span>
<span class="line"><span>        image: nginx:1.17.1</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol><li>创建deploy进行验证</li></ol><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span># 变更镜像</span></span>
<span class="line"><span>kubectl set image deployment pc-deployment nginx=nginx:1.17.3 -n dev </span></span>
<span class="line"><span># 观察升级过程</span></span>
<span class="line"><span>[root@k8s-master01 ~]# kubectl get pods -n dev -w</span></span>
<span class="line"><span>NAME                           READY   STATUS    RESTARTS   AGE</span></span>
<span class="line"><span>pc-deployment-c848d767-8rbzt   1/1     Running   0          31m</span></span>
<span class="line"><span>pc-deployment-c848d767-h4p68   1/1     Running   0          31m</span></span>
<span class="line"><span>pc-deployment-c848d767-hlmz4   1/1     Running   0          31m</span></span>
<span class="line"><span>pc-deployment-c848d767-rrqcn   1/1     Running   0          31m</span></span>
<span class="line"><span></span></span>
<span class="line"><span>pc-deployment-966bf7f44-226rx   0/1     Pending             0          0s</span></span>
<span class="line"><span>pc-deployment-966bf7f44-226rx   0/1     ContainerCreating   0          0s</span></span>
<span class="line"><span>pc-deployment-966bf7f44-226rx   1/1     Running             0          1s</span></span>
<span class="line"><span>pc-deployment-c848d767-h4p68    0/1     Terminating         0          34m</span></span>
<span class="line"><span></span></span>
<span class="line"><span>pc-deployment-966bf7f44-cnd44   0/1     Pending             0          0s</span></span>
<span class="line"><span>pc-deployment-966bf7f44-cnd44   0/1     ContainerCreating   0          0s</span></span>
<span class="line"><span>pc-deployment-966bf7f44-cnd44   1/1     Running             0          2s</span></span>
<span class="line"><span>pc-deployment-c848d767-hlmz4    0/1     Terminating         0          34m</span></span>
<span class="line"><span></span></span>
<span class="line"><span>pc-deployment-966bf7f44-px48p   0/1     Pending             0          0s</span></span>
<span class="line"><span>pc-deployment-966bf7f44-px48p   0/1     ContainerCreating   0          0s</span></span>
<span class="line"><span>pc-deployment-966bf7f44-px48p   1/1     Running             0          0s</span></span>
<span class="line"><span>pc-deployment-c848d767-8rbzt    0/1     Terminating         0          34m</span></span>
<span class="line"><span></span></span>
<span class="line"><span>pc-deployment-966bf7f44-dkmqp   0/1     Pending             0          0s</span></span>
<span class="line"><span>pc-deployment-966bf7f44-dkmqp   0/1     ContainerCreating   0          0s</span></span>
<span class="line"><span>pc-deployment-966bf7f44-dkmqp   1/1     Running             0          2s</span></span>
<span class="line"><span>pc-deployment-c848d767-rrqcn    0/1     Terminating         0          34m</span></span>
<span class="line"><span></span></span>
<span class="line"><span># 至此，新版本的pod创建完毕，就版本的pod销毁完毕</span></span>
<span class="line"><span># 中间过程是滚动进行的，也就是边销毁边创建</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>滚动更新的过程：</p><p>镜像更新中rs的变化</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span># 查看rs,发现原来的rs的依旧存在，只是pod数量变为了0，而后又新产生了一个rs，pod数量为4</span></span>
<span class="line"><span># 其实这就是deployment能够进行版本回退的奥妙所在，后面会详细解释</span></span>
<span class="line"><span>[root@k8s-master01 ~]# kubectl get rs -n dev</span></span>
<span class="line"><span>NAME                       DESIRED   CURRENT   READY   AGE</span></span>
<span class="line"><span>pc-deployment-6696798b78   0         0         0       7m37s</span></span>
<span class="line"><span>pc-deployment-6696798b11   0         0         0       5m37s</span></span>
<span class="line"><span>pc-deployment-c848d76789   4         4         4       72s</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="版本回退" tabindex="-1"><a class="header-anchor" href="#版本回退"><span><strong>版本回退</strong></span></a></h3><p>deployment支持版本升级过程中的暂停、继续功能以及版本回退等诸多功能。</p><p>kubectl rollout： 版本升级相关功能，支持下面的选项：</p><ul><li>status 显示当前升级状态</li><li>history 显示 升级历史记录</li><li>pause 暂停版本升级过程</li><li>resume 继续已经暂停的版本升级过程</li><li>restart 重启版本升级过程</li><li>undo 回滚到上一级版本（可以使用--to-revision回滚到指定版本）</li></ul><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span># 查看当前升级版本的状态</span></span>
<span class="line"><span>[root@k8s-master01 ~]# kubectl rollout status deploy pc-deployment -n dev</span></span>
<span class="line"><span>deployment &quot;pc-deployment&quot; successfully rolled out</span></span>
<span class="line"><span># 查看升级历史记录</span></span>
<span class="line"><span>[root@k8s-master01 ~]# kubectl rollout history deploy pc-deployment -n dev</span></span>
<span class="line"><span>deployment.apps/pc-deployment</span></span>
<span class="line"><span>REVISION  CHANGE-CAUSE</span></span>
<span class="line"><span>1         kubectl create --filename=pc-deployment.yaml --record=true</span></span>
<span class="line"><span>2         kubectl create --filename=pc-deployment.yaml --record=true</span></span>
<span class="line"><span>3         kubectl create --filename=pc-deployment.yaml --record=true</span></span>
<span class="line"><span># 可以发现有三次版本记录，说明完成过两次升级</span></span>
<span class="line"><span></span></span>
<span class="line"><span># 版本回滚</span></span>
<span class="line"><span># 这里直接使用--to-revision=1回滚到了1版本， 如果省略这个选项，就是回退到上个版本，就是2版本</span></span>
<span class="line"><span>[root@k8s-master01 ~]# kubectl rollout undo deployment pc-deployment --to-revision=1 -n dev</span></span>
<span class="line"><span>deployment.apps/pc-deployment rolled back</span></span>
<span class="line"><span></span></span>
<span class="line"><span># 查看发现，通过nginx镜像版本可以发现到了第一版</span></span>
<span class="line"><span>[root@k8s-master01 ~]# kubectl get deploy -n dev -o wide</span></span>
<span class="line"><span>NAME            READY   UP-TO-DATE   AVAILABLE   AGE   CONTAINERS   IMAGES         </span></span>
<span class="line"><span>pc-deployment   4/4     4            4           74m   nginx        nginx:1.17.1   </span></span>
<span class="line"><span></span></span>
<span class="line"><span># 查看rs，发现第一个rs中有4个pod运行，后面两个版本的rs中pod为运行</span></span>
<span class="line"><span># 其实deployment之所以可是实现版本的回滚，就是通过记录下历史rs来实现的，</span></span>
<span class="line"><span># 一旦想回滚到哪个版本，只需要将当前版本pod数量降为0，然后将回滚版本的pod提升为目标数量就可以了</span></span>
<span class="line"><span>[root@k8s-master01 ~]# kubectl get rs -n dev</span></span>
<span class="line"><span>NAME                       DESIRED   CURRENT   READY   AGE</span></span>
<span class="line"><span>pc-deployment-6696798b78   4         4         4       78m</span></span>
<span class="line"><span>pc-deployment-966bf7f44    0         0         0       37m</span></span>
<span class="line"><span>pc-deployment-c848d767     0         0         0       71m</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>金丝雀发布</strong></p><p>Deployment控制器支持控制更新过程中的控制，如“暂停(pause)”或“继续(resume)”更新操作。</p><p>比如有一批新的Pod资源创建完成后立即暂停更新过程，此时，仅存在一部分新版本的应用，主体部分还是旧的版本。然后，再筛选一小部分的用户请求路由到新版本的Pod应用，继续观察能否稳定地按期望的方式运行。确定没问题之后再继续完成余下的Pod资源滚动更新，否则立即回滚更新操作。这就是所谓的金丝雀发布。</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span># 更新deployment的版本，并配置暂停deployment</span></span>
<span class="line"><span>[root@k8s-master01 ~]#  sudo kubectl set image deploy pc-deployment nginx=nginx:1.17.4 -n dev &amp;&amp;  sudo kubectl rollout pause deployment pc-deployment  -n dev</span></span>
<span class="line"><span>deployment.apps/pc-deployment image updated</span></span>
<span class="line"><span>deployment.apps/pc-deployment paused</span></span>
<span class="line"><span></span></span>
<span class="line"><span>#观察更新状态</span></span>
<span class="line"><span>[root@k8s-master01 ~]# sudo kubectl rollout status deploy pc-deployment -n dev</span></span>
<span class="line"><span>Waiting for deployment &quot;pc-deployment&quot; rollout to finish: 2 out of 4 new replicas have been updated...</span></span>
<span class="line"><span></span></span>
<span class="line"><span># 监控更新的过程，可以看到已经新增了一个资源，但是并未按照预期的状态去删除一个旧的资源，就是因为使用了pause暂停命令</span></span>
<span class="line"><span></span></span>
<span class="line"><span>[root@k8s-master01 ~]# kubectl get rs -n dev -o wide</span></span>
<span class="line"><span>NAME                       DESIRED   CURRENT   READY   AGE     CONTAINERS   IMAGES         </span></span>
<span class="line"><span>pc-deployment-5d89bdfbf9   3         3         3       19m     nginx        nginx:1.17.1   </span></span>
<span class="line"><span>pc-deployment-675d469f8b   0         0         0       14m     nginx        nginx:1.17.2   </span></span>
<span class="line"><span>pc-deployment-6c9f56fcfb   2         2         2       3m16s   nginx        nginx:1.17.4   </span></span>
<span class="line"><span>[root@k8s-master01 ~]# kubectl get pods -n dev</span></span>
<span class="line"><span>NAME                             READY   STATUS    RESTARTS   AGE</span></span>
<span class="line"><span>pc-deployment-5d89bdfbf9-rj8sq   1/1     Running   0          7m33s</span></span>
<span class="line"><span>pc-deployment-5d89bdfbf9-ttwgg   1/1     Running   0          7m35s</span></span>
<span class="line"><span>pc-deployment-5d89bdfbf9-v4wvc   1/1     Running   0          7m34s</span></span>
<span class="line"><span>pc-deployment-6c9f56fcfb-996rt   1/1     Running   0          3m31s</span></span>
<span class="line"><span>pc-deployment-6c9f56fcfb-j2gtj   1/1     Running   0          3m31s</span></span>
<span class="line"><span></span></span>
<span class="line"><span># 确保更新的pod没问题了，继续更新</span></span>
<span class="line"><span>[root@k8s-master01 ~]# kubectl rollout resume deploy pc-deployment -n dev</span></span>
<span class="line"><span>deployment.apps/pc-deployment resumed</span></span>
<span class="line"><span></span></span>
<span class="line"><span># 查看最后的更新情况</span></span>
<span class="line"><span>[root@k8s-master01 ~]# kubectl get rs -n dev -o wide</span></span>
<span class="line"><span>NAME                       DESIRED   CURRENT   READY   AGE     CONTAINERS   IMAGES         </span></span>
<span class="line"><span>pc-deployment-5d89bdfbf9   0         0         0       21m     nginx        nginx:1.17.1   </span></span>
<span class="line"><span>pc-deployment-675d469f8b   0         0         0       16m     nginx        nginx:1.17.2   </span></span>
<span class="line"><span>pc-deployment-6c9f56fcfb   4         4         4       5m11s   nginx        nginx:1.17.4   </span></span>
<span class="line"><span></span></span>
<span class="line"><span>[root@k8s-master01 ~]# kubectl get pods -n dev</span></span>
<span class="line"><span>NAME                             READY   STATUS    RESTARTS   AGE</span></span>
<span class="line"><span>pc-deployment-6c9f56fcfb-7bfwh   1/1     Running   0          37s</span></span>
<span class="line"><span>pc-deployment-6c9f56fcfb-996rt   1/1     Running   0          5m27s</span></span>
<span class="line"><span>pc-deployment-6c9f56fcfb-j2gtj   1/1     Running   0          5m27s</span></span>
<span class="line"><span>pc-deployment-6c9f56fcfb-rf84v   1/1     Running   0          37s</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>删除Deployment</strong></p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span># 删除deployment，其下的rs和pod也将被删除</span></span>
<span class="line"><span>kubectl delete -f pc-deployment.yaml</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_6-4-horizontal-pod-autoscaler-hpa" tabindex="-1"><a class="header-anchor" href="#_6-4-horizontal-pod-autoscaler-hpa"><span>6.4 Horizontal Pod Autoscaler(HPA)</span></a></h2><p>在前面的课程中，我们已经可以实现通过手工执行kubectl scale命令实现Pod扩容或缩容，但是这显然不符合Kubernetes的定位目标--自动化、智能化。 Kubernetes期望可以实现通过监测Pod的使用情况，实现pod数量的自动调整，于是就产生了Horizontal Pod Autoscaler（HPA）这种控制器。<br> HPA可以获取每个Pod利用率，然后和HPA中定义的指标进行对比，同时计算出需要伸缩的具体值，最后实现Pod的数量的调整。其实HPA与之前的Deployment一样，也属于一种Kubernetes资源对象，它通过追踪分析RC控制的所有目标Pod的负载变化情况，来确定是否需要针对性地调整目标Pod的副本数，这是HPA的实现原理。</p><p>接下来，我们来做一个实验<br><strong>1 安装metrics-server</strong><br> metrics-server可以用来收集集群中的资源使用情况</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span># 安装git</span></span>
<span class="line"><span>[root@k8s-master01 ~]# yum install git -y</span></span>
<span class="line"><span># 获取metrics-server, 注意使用的版本</span></span>
<span class="line"><span>[root@k8s-master01 ~]# git clone -b v0.3.6 https://github.com/kubernetes-incubator/metrics-server</span></span>
<span class="line"><span># 修改deployment, 注意修改的是镜像和初始化参数</span></span>
<span class="line"><span>[root@k8s-master01 ~]# cd /root/metrics-server/deploy/1.8+/</span></span>
<span class="line"><span>[root@k8s-master01 1.8+]# vim metrics-server-deployment.yaml</span></span>
<span class="line"><span>按图中添加下面选项</span></span>
<span class="line"><span>hostNetwork: true</span></span>
<span class="line"><span>image: registry.cn-hangzhou.aliyuncs.com/google_containers/metrics-server-amd64:v0.3.6</span></span>
<span class="line"><span>args:</span></span>
<span class="line"><span>- --kubelet-insecure-tls</span></span>
<span class="line"><span>- --kubelet-preferred-address-types=InternalIP,Hostname,InternalDNS,ExternalDNS,ExternalIP</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span># 安装metrics-server</span></span>
<span class="line"><span>[root@k8s-master01 1.8+]# kubectl apply -f ./</span></span>
<span class="line"><span></span></span>
<span class="line"><span># 查看pod运行情况</span></span>
<span class="line"><span>[root@k8s-master01 1.8+]# kubectl get pod -n kube-system</span></span>
<span class="line"><span>metrics-server-6b976979db-2xwbj   1/1     Running   0          90s</span></span>
<span class="line"><span></span></span>
<span class="line"><span># 使用kubectl top node 查看资源使用情况</span></span>
<span class="line"><span>[root@k8s-master01 1.8+]# kubectl top node</span></span>
<span class="line"><span>NAME           CPU(cores)   CPU%   MEMORY(bytes)   MEMORY%</span></span>
<span class="line"><span>k8s-master01   289m         14%    1582Mi          54%       </span></span>
<span class="line"><span>k8s-node01     81m          4%     1195Mi          40%       </span></span>
<span class="line"><span>k8s-node02     72m          3%     1211Mi          41%  </span></span>
<span class="line"><span>[root@k8s-master01 1.8+]# kubectl top pod -n kube-system</span></span>
<span class="line"><span>NAME                              CPU(cores)   MEMORY(bytes)</span></span>
<span class="line"><span>coredns-6955765f44-7ptsb          3m           9Mi</span></span>
<span class="line"><span>coredns-6955765f44-vcwr5          3m           8Mi</span></span>
<span class="line"><span>etcd-master                       14m          145Mi</span></span>
<span class="line"><span>...</span></span>
<span class="line"><span># 至此,metrics-server安装完成</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>2 准备deployment和servie</strong></p><p>创建pc-hpa-pod.yaml文件，内容如下：</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>apiVersion: apps/v1</span></span>
<span class="line"><span>kind: Deployment</span></span>
<span class="line"><span>metadata:</span></span>
<span class="line"><span>  name: nginx</span></span>
<span class="line"><span>  namespace: dev</span></span>
<span class="line"><span>spec:</span></span>
<span class="line"><span>  strategy: # 策略</span></span>
<span class="line"><span>    type: RollingUpdate # 滚动更新策略</span></span>
<span class="line"><span>  replicas: 1</span></span>
<span class="line"><span>  selector:</span></span>
<span class="line"><span>    matchLabels:</span></span>
<span class="line"><span>      app: nginx-pod</span></span>
<span class="line"><span>  template:</span></span>
<span class="line"><span>    metadata:</span></span>
<span class="line"><span>      labels:</span></span>
<span class="line"><span>        app: nginx-pod</span></span>
<span class="line"><span>    spec:</span></span>
<span class="line"><span>      containers:</span></span>
<span class="line"><span>      - name: nginx</span></span>
<span class="line"><span>        image: nginx:1.17.1</span></span>
<span class="line"><span>        resources: # 资源配额</span></span>
<span class="line"><span>          limits:  # 限制资源（上限）</span></span>
<span class="line"><span>            cpu: &quot;1&quot; # CPU限制，单位是core数</span></span>
<span class="line"><span>          requests: # 请求资源（下限）</span></span>
<span class="line"><span>            cpu: &quot;100m&quot;  # CPU限制，单位是core数</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span># 创建service</span></span>
<span class="line"><span>[root@k8s-master01 1.8+]# kubectl expose deployment nginx --type=NodePort --port=80 -n dev</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span># 查看</span></span>
<span class="line"><span>[root@k8s-master01 1.8+]# kubectl get deployment,pod,svc -n dev</span></span>
<span class="line"><span>NAME                    READY   UP-TO-DATE   AVAILABLE   AGE</span></span>
<span class="line"><span>deployment.apps/nginx   1/1     1            1           47s</span></span>
<span class="line"><span></span></span>
<span class="line"><span>NAME                         READY   STATUS    RESTARTS   AGE</span></span>
<span class="line"><span>pod/nginx-7df9756ccc-bh8dr   1/1     Running   0          47s</span></span>
<span class="line"><span></span></span>
<span class="line"><span>NAME            TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE</span></span>
<span class="line"><span>service/nginx   NodePort   10.101.18.29   &lt;none&gt;        80:31830/TCP   35s</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>3 部署HPA</strong></p><p>创建pc-hpa.yaml文件，内容如下：</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>apiVersion: autoscaling/v1</span></span>
<span class="line"><span>kind: HorizontalPodAutoscaler</span></span>
<span class="line"><span>metadata:</span></span>
<span class="line"><span>  name: pc-hpa</span></span>
<span class="line"><span>  namespace: dev</span></span>
<span class="line"><span>spec:</span></span>
<span class="line"><span>  minReplicas: 1  #最小pod数量</span></span>
<span class="line"><span>  maxReplicas: 10 #最大pod数量</span></span>
<span class="line"><span>  targetCPUUtilizationPercentage: 3 # CPU使用率指标</span></span>
<span class="line"><span>  scaleTargetRef:   # 指定要控制的nginx信息</span></span>
<span class="line"><span>    apiVersion: apps/v1</span></span>
<span class="line"><span>    kind: Deployment</span></span>
<span class="line"><span>    name: nginx</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span># 创建hpa</span></span>
<span class="line"><span>[root@k8s-master01 1.8+]# kubectl create -f pc-hpa.yaml</span></span>
<span class="line"><span>horizontalpodautoscaler.autoscaling/pc-hpa created</span></span>
<span class="line"><span></span></span>
<span class="line"><span># 查看hpa</span></span>
<span class="line"><span>[root@k8s-master01 1.8+]# kubectl get hpa -n dev</span></span>
<span class="line"><span>NAME     REFERENCE          TARGETS   MINPODS   MAXPODS   REPLICAS   AGE</span></span>
<span class="line"><span>pc-hpa   Deployment/nginx   0%/3%     1         10        1          62s</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>4 测试</strong></p><p>使用压测工具对service地址192.168.5.4:31830进行压测，然后通过控制台查看hpa和pod的变化<br> hpa变化</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>[root@k8s-master01 ~]# kubectl get hpa -n dev -w</span></span>
<span class="line"><span>NAME   REFERENCE      TARGETS  MINPODS  MAXPODS  REPLICAS  AGE</span></span>
<span class="line"><span>pc-hpa  Deployment/nginx  0%/3%   1     10     1      4m11s</span></span>
<span class="line"><span>pc-hpa  Deployment/nginx  0%/3%   1     10     1      5m19s</span></span>
<span class="line"><span>pc-hpa  Deployment/nginx  22%/3%   1     10     1      6m50s</span></span>
<span class="line"><span>pc-hpa  Deployment/nginx  22%/3%   1     10     4      7m5s</span></span>
<span class="line"><span>pc-hpa  Deployment/nginx  22%/3%   1     10     8      7m21s</span></span>
<span class="line"><span>pc-hpa  Deployment/nginx  6%/3%   1     10     8      7m51s</span></span>
<span class="line"><span>pc-hpa  Deployment/nginx  0%/3%   1     10     8      9m6s</span></span>
<span class="line"><span>pc-hpa  Deployment/nginx  0%/3%   1     10     8      13m</span></span>
<span class="line"><span>pc-hpa  Deployment/nginx  0%/3%   1     10     1      14m</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>deployment变化</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>[root@k8s-master01 ~]# kubectl get deployment -n dev -w</span></span>
<span class="line"><span>NAME    READY   UP-TO-DATE   AVAILABLE   AGE</span></span>
<span class="line"><span>nginx   1/1     1            1           11m</span></span>
<span class="line"><span>nginx   1/4     1            1           13m</span></span>
<span class="line"><span>nginx   1/4     1            1           13m</span></span>
<span class="line"><span>nginx   1/4     1            1           13m</span></span>
<span class="line"><span>nginx   1/4     4            1           13m</span></span>
<span class="line"><span>nginx   1/8     4            1           14m</span></span>
<span class="line"><span>nginx   1/8     4            1           14m</span></span>
<span class="line"><span>nginx   1/8     4            1           14m</span></span>
<span class="line"><span>nginx   1/8     8            1           14m</span></span>
<span class="line"><span>nginx   2/8     8            2           14m</span></span>
<span class="line"><span>nginx   3/8     8            3           14m</span></span>
<span class="line"><span>nginx   4/8     8            4           14m</span></span>
<span class="line"><span>nginx   5/8     8            5           14m</span></span>
<span class="line"><span>nginx   6/8     8            6           14m</span></span>
<span class="line"><span>nginx   7/8     8            7           14m</span></span>
<span class="line"><span>nginx   8/8     8            8           15m</span></span>
<span class="line"><span>nginx   8/1     8            8           20m</span></span>
<span class="line"><span>nginx   8/1     8            8           20m</span></span>
<span class="line"><span>nginx   1/1     1            1           20m</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>pod变化</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>[root@k8s-master01 ~]# kubectl get pods -n dev -w</span></span>
<span class="line"><span>NAME                     READY   STATUS    RESTARTS   AGE</span></span>
<span class="line"><span>nginx-7df9756ccc-bh8dr   1/1     Running   0          11m</span></span>
<span class="line"><span>nginx-7df9756ccc-cpgrv   0/1     Pending   0          0s</span></span>
<span class="line"><span>nginx-7df9756ccc-8zhwk   0/1     Pending   0          0s</span></span>
<span class="line"><span>nginx-7df9756ccc-rr9bn   0/1     Pending   0          0s</span></span>
<span class="line"><span>nginx-7df9756ccc-cpgrv   0/1     ContainerCreating   0          0s</span></span>
<span class="line"><span>nginx-7df9756ccc-8zhwk   0/1     ContainerCreating   0          0s</span></span>
<span class="line"><span>nginx-7df9756ccc-rr9bn   0/1     ContainerCreating   0          0s</span></span>
<span class="line"><span>nginx-7df9756ccc-m9gsj   0/1     Pending             0          0s</span></span>
<span class="line"><span>nginx-7df9756ccc-g56qb   0/1     Pending             0          0s</span></span>
<span class="line"><span>nginx-7df9756ccc-sl9c6   0/1     Pending             0          0s</span></span>
<span class="line"><span>nginx-7df9756ccc-fgst7   0/1     Pending             0          0s</span></span>
<span class="line"><span>nginx-7df9756ccc-g56qb   0/1     ContainerCreating   0          0s</span></span>
<span class="line"><span>nginx-7df9756ccc-m9gsj   0/1     ContainerCreating   0          0s</span></span>
<span class="line"><span>nginx-7df9756ccc-sl9c6   0/1     ContainerCreating   0          0s</span></span>
<span class="line"><span>nginx-7df9756ccc-fgst7   0/1     ContainerCreating   0          0s</span></span>
<span class="line"><span>nginx-7df9756ccc-8zhwk   1/1     Running             0          19s</span></span>
<span class="line"><span>nginx-7df9756ccc-rr9bn   1/1     Running             0          30s</span></span>
<span class="line"><span>nginx-7df9756ccc-m9gsj   1/1     Running             0          21s</span></span>
<span class="line"><span>nginx-7df9756ccc-cpgrv   1/1     Running             0          47s</span></span>
<span class="line"><span>nginx-7df9756ccc-sl9c6   1/1     Running             0          33s</span></span>
<span class="line"><span>nginx-7df9756ccc-g56qb   1/1     Running             0          48s</span></span>
<span class="line"><span>nginx-7df9756ccc-fgst7   1/1     Running             0          66s</span></span>
<span class="line"><span>nginx-7df9756ccc-fgst7   1/1     Terminating         0          6m50s</span></span>
<span class="line"><span>nginx-7df9756ccc-8zhwk   1/1     Terminating         0          7m5s</span></span>
<span class="line"><span>nginx-7df9756ccc-cpgrv   1/1     Terminating         0          7m5s</span></span>
<span class="line"><span>nginx-7df9756ccc-g56qb   1/1     Terminating         0          6m50s</span></span>
<span class="line"><span>nginx-7df9756ccc-rr9bn   1/1     Terminating         0          7m5s</span></span>
<span class="line"><span>nginx-7df9756ccc-m9gsj   1/1     Terminating         0          6m50s</span></span>
<span class="line"><span>nginx-7df9756ccc-sl9c6   1/1     Terminating         0          6m50s</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_6-5-daemonset-ds" tabindex="-1"><a class="header-anchor" href="#_6-5-daemonset-ds"><span>6.5 DaemonSet(DS)</span></a></h2><p>DaemonSet类型的控制器可以保证在集群中的每一台（或指定）节点上都运行一个副本。一般适用于日志收集、节点监控等场景。也就是说，如果一个Pod提供的功能是节点级别的（每个节点都需要且只需要一个），那么这类Pod就适合使用DaemonSet类型的控制器创建。</p><p>DaemonSet控制器的特点：</p><ul><li><p>每当向集群中添加一个节点时，指定的 Pod 副本也将添加到该节点上</p></li><li><p>当节点从集群中移除时，Pod 也就被垃圾回收了</p></li></ul><p>下面先来看下DaemonSet的资源清单文件</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>apiVersion: apps/v1 # 版本号</span></span>
<span class="line"><span>kind: DaemonSet # 类型       </span></span>
<span class="line"><span>metadata: # 元数据</span></span>
<span class="line"><span>  name: # rs名称 </span></span>
<span class="line"><span>  namespace: # 所属命名空间 </span></span>
<span class="line"><span>  labels: #标签</span></span>
<span class="line"><span>    controller: daemonset</span></span>
<span class="line"><span>spec: # 详情描述</span></span>
<span class="line"><span>  revisionHistoryLimit: 3 # 保留历史版本</span></span>
<span class="line"><span>  updateStrategy: # 更新策略</span></span>
<span class="line"><span>    type: RollingUpdate # 滚动更新策略</span></span>
<span class="line"><span>    rollingUpdate: # 滚动更新</span></span>
<span class="line"><span>      maxUnavailable: 1 # 最大不可用状态的 Pod 的最大值，可以为百分比，也可以为整数</span></span>
<span class="line"><span>  selector: # 选择器，通过它指定该控制器管理哪些pod</span></span>
<span class="line"><span>    matchLabels:      # Labels匹配规则</span></span>
<span class="line"><span>      app: nginx-pod</span></span>
<span class="line"><span>    matchExpressions: # Expressions匹配规则</span></span>
<span class="line"><span>      - {key: app, operator: In, values: [nginx-pod]}</span></span>
<span class="line"><span>  template: # 模板，当副本数量不足时，会根据下面的模板创建pod副本</span></span>
<span class="line"><span>    metadata:</span></span>
<span class="line"><span>      labels:</span></span>
<span class="line"><span>        app: nginx-pod</span></span>
<span class="line"><span>    spec:</span></span>
<span class="line"><span>      containers:</span></span>
<span class="line"><span>      - name: nginx</span></span>
<span class="line"><span>        image: nginx:1.17.1</span></span>
<span class="line"><span>        ports:</span></span>
<span class="line"><span>        - containerPort: 80</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>创建pc-daemonset.yaml，内容如下：</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>apiVersion: apps/v1</span></span>
<span class="line"><span>kind: DaemonSet      </span></span>
<span class="line"><span>metadata:</span></span>
<span class="line"><span>  name: pc-daemonset</span></span>
<span class="line"><span>  namespace: dev</span></span>
<span class="line"><span>spec: </span></span>
<span class="line"><span>  selector:</span></span>
<span class="line"><span>    matchLabels:</span></span>
<span class="line"><span>      app: nginx-pod</span></span>
<span class="line"><span>  template:</span></span>
<span class="line"><span>    metadata:</span></span>
<span class="line"><span>      labels:</span></span>
<span class="line"><span>        app: nginx-pod</span></span>
<span class="line"><span>    spec:</span></span>
<span class="line"><span>      containers:</span></span>
<span class="line"><span>      - name: nginx</span></span>
<span class="line"><span>        image: nginx:1.17.1</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span># 创建daemonset</span></span>
<span class="line"><span>[root@k8s-master01 ~]# kubectl create -f  pc-daemonset.yaml</span></span>
<span class="line"><span>daemonset.apps/pc-daemonset created</span></span>
<span class="line"><span></span></span>
<span class="line"><span># 查看daemonset</span></span>
<span class="line"><span>[root@k8s-master01 ~]#  kubectl get ds -n dev -o wide</span></span>
<span class="line"><span>NAME        DESIRED  CURRENT  READY  UP-TO-DATE  AVAILABLE   AGE   CONTAINERS   IMAGES         </span></span>
<span class="line"><span>pc-daemonset   2        2        2      2           2        24s   nginx        nginx:1.17.1   </span></span>
<span class="line"><span></span></span>
<span class="line"><span># 查看pod,发现在每个Node上都运行一个pod</span></span>
<span class="line"><span>[root@k8s-master01 ~]#  kubectl get pods -n dev -o wide</span></span>
<span class="line"><span>NAME                 READY   STATUS    RESTARTS   AGE   IP            NODE    </span></span>
<span class="line"><span>pc-daemonset-9bck8   1/1     Running   0          37s   10.244.1.43   node1     </span></span>
<span class="line"><span>pc-daemonset-k224w   1/1     Running   0          37s   10.244.2.74   node2      </span></span>
<span class="line"><span></span></span>
<span class="line"><span># 删除daemonset</span></span>
<span class="line"><span>[root@k8s-master01 ~]# kubectl delete -f pc-daemonset.yaml</span></span>
<span class="line"><span>daemonset.apps &quot;pc-daemonset&quot; deleted</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_6-6-job" tabindex="-1"><a class="header-anchor" href="#_6-6-job"><span>6.6 Job</span></a></h2><p>Job，主要用于负责**批量处理(一次要处理指定数量任务)<strong>短暂的</strong>一次性(每个任务仅运行一次就结束)**任务。Job特点如下：</p><ul><li><p>当Job创建的pod执行成功结束时，Job将记录成功结束的pod数量</p></li><li><p>当成功结束的pod达到指定的数量时，Job将完成执行</p></li></ul><p>Job的资源清单文件：</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span># pc-job.yaml</span></span>
<span class="line"><span>apiVersion: batch/v1 # 版本号</span></span>
<span class="line"><span>kind: Job # 类型       </span></span>
<span class="line"><span>metadata: # 元数据</span></span>
<span class="line"><span>  name: # rs名称 </span></span>
<span class="line"><span>  namespace: # 所属命名空间 </span></span>
<span class="line"><span>  labels: #标签</span></span>
<span class="line"><span>    controller: job</span></span>
<span class="line"><span>spec: # 详情描述</span></span>
<span class="line"><span>  completions: 1 # 指定job需要成功运行Pods的次数。默认值: 1</span></span>
<span class="line"><span>  parallelism: 1 # 指定job在任一时刻应该并发运行Pods的数量。默认值: 1</span></span>
<span class="line"><span>  activeDeadlineSeconds: 30 # 指定job可运行的时间期限，超过时间还未结束，系统将会尝试进行终止。</span></span>
<span class="line"><span>  backoffLimit: 6 # 指定job失败后进行重试的次数。默认是6</span></span>
<span class="line"><span>  manualSelector: true # 是否可以使用selector选择器选择pod，默认是false</span></span>
<span class="line"><span>  selector: # 选择器，通过它指定该控制器管理哪些pod</span></span>
<span class="line"><span>    matchLabels:      # Labels匹配规则</span></span>
<span class="line"><span>      app: counter-pod</span></span>
<span class="line"><span>    matchExpressions: # Expressions匹配规则</span></span>
<span class="line"><span>      - {key: app, operator: In, values: [counter-pod]}</span></span>
<span class="line"><span>  template: # 模板，当副本数量不足时，会根据下面的模板创建pod副本</span></span>
<span class="line"><span>    metadata:</span></span>
<span class="line"><span>      labels:</span></span>
<span class="line"><span>        app: counter-pod</span></span>
<span class="line"><span>    spec:</span></span>
<span class="line"><span>      restartPolicy: Never # 重启策略只能设置为Never或者OnFailure</span></span>
<span class="line"><span>      containers:</span></span>
<span class="line"><span>      - name: counter</span></span>
<span class="line"><span>        image: busybox:1.30</span></span>
<span class="line"><span>        command: [&quot;bin/sh&quot;,&quot;-c&quot;,&quot;for i in 9 8 7 6 5 4 3 2 1; do echo $i;sleep 2;done&quot;]</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>关于重启策略设置的说明：</span></span>
<span class="line"><span>    如果指定为OnFailure，则job会在pod出现故障时重启容器，而不是创建pod，failed次数不变</span></span>
<span class="line"><span>    如果指定为Never，则job会在pod出现故障时创建新的pod，并且故障pod不会消失，也不会重启，failed次数加1</span></span>
<span class="line"><span>    如果指定为Always的话，就意味着一直重启，意味着job任务会重复去执行了，当然不对，所以不能设置为Always</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>创建pc-job.yaml，内容如下：</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>apiVersion: batch/v1</span></span>
<span class="line"><span>kind: Job      </span></span>
<span class="line"><span>metadata:</span></span>
<span class="line"><span>  name: pc-job</span></span>
<span class="line"><span>  namespace: dev</span></span>
<span class="line"><span>spec:</span></span>
<span class="line"><span>  manualSelector: true</span></span>
<span class="line"><span>  selector:</span></span>
<span class="line"><span>    matchLabels:</span></span>
<span class="line"><span>      app: counter-pod</span></span>
<span class="line"><span>  template:</span></span>
<span class="line"><span>    metadata:</span></span>
<span class="line"><span>      labels:</span></span>
<span class="line"><span>        app: counter-pod</span></span>
<span class="line"><span>    spec:</span></span>
<span class="line"><span>      restartPolicy: Never</span></span>
<span class="line"><span>      containers:</span></span>
<span class="line"><span>      - name: counter</span></span>
<span class="line"><span>        image: busybox:1.30</span></span>
<span class="line"><span>        command: [&quot;bin/sh&quot;,&quot;-c&quot;,&quot;for i in 9 8 7 6 5 4 3 2 1; do echo $i;sleep 3;done&quot;]</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span># 创建job</span></span>
<span class="line"><span>[root@k8s-master01 ~]# kubectl create -f pc-job.yaml</span></span>
<span class="line"><span>job.batch/pc-job created</span></span>
<span class="line"><span></span></span>
<span class="line"><span># 查看job</span></span>
<span class="line"><span>[root@k8s-master01 ~]# kubectl get job -n dev -o wide  -w</span></span>
<span class="line"><span>NAME     COMPLETIONS   DURATION   AGE   CONTAINERS   IMAGES         SELECTOR</span></span>
<span class="line"><span>pc-job   0/1           21s        21s   counter      busybox:1.30   app=counter-pod</span></span>
<span class="line"><span>pc-job   1/1           31s        79s   counter      busybox:1.30   app=counter-pod</span></span>
<span class="line"><span></span></span>
<span class="line"><span># 通过观察pod状态可以看到，pod在运行完毕任务后，就会变成Completed状态</span></span>
<span class="line"><span>[root@k8s-master01 ~]# kubectl get pods -n dev -w</span></span>
<span class="line"><span>NAME           READY   STATUS     RESTARTS      AGE</span></span>
<span class="line"><span>pc-job-rxg96   1/1     Running     0            29s</span></span>
<span class="line"><span>pc-job-rxg96   0/1     Completed   0            33s</span></span>
<span class="line"><span></span></span>
<span class="line"><span># 接下来，调整下pod运行的总数量和并行数量 即：在spec下设置下面两个选项</span></span>
<span class="line"><span>#  completions: 6 # 指定job需要成功运行Pods的次数为6</span></span>
<span class="line"><span>#  parallelism: 3 # 指定job并发运行Pods的数量为3</span></span>
<span class="line"><span>#  然后重新运行job，观察效果，此时会发现，job会每次运行3个pod，总共执行了6个pod</span></span>
<span class="line"><span>[root@k8s-master01 ~]# kubectl get pods -n dev -w</span></span>
<span class="line"><span>NAME           READY   STATUS    RESTARTS   AGE</span></span>
<span class="line"><span>pc-job-684ft   1/1     Running   0          5s</span></span>
<span class="line"><span>pc-job-jhj49   1/1     Running   0          5s</span></span>
<span class="line"><span>pc-job-pfcvh   1/1     Running   0          5s</span></span>
<span class="line"><span>pc-job-684ft   0/1     Completed   0          11s</span></span>
<span class="line"><span>pc-job-v7rhr   0/1     Pending     0          0s</span></span>
<span class="line"><span>pc-job-v7rhr   0/1     Pending     0          0s</span></span>
<span class="line"><span>pc-job-v7rhr   0/1     ContainerCreating   0          0s</span></span>
<span class="line"><span>pc-job-jhj49   0/1     Completed           0          11s</span></span>
<span class="line"><span>pc-job-fhwf7   0/1     Pending             0          0s</span></span>
<span class="line"><span>pc-job-fhwf7   0/1     Pending             0          0s</span></span>
<span class="line"><span>pc-job-pfcvh   0/1     Completed           0          11s</span></span>
<span class="line"><span>pc-job-5vg2j   0/1     Pending             0          0s</span></span>
<span class="line"><span>pc-job-fhwf7   0/1     ContainerCreating   0          0s</span></span>
<span class="line"><span>pc-job-5vg2j   0/1     Pending             0          0s</span></span>
<span class="line"><span>pc-job-5vg2j   0/1     ContainerCreating   0          0s</span></span>
<span class="line"><span>pc-job-fhwf7   1/1     Running             0          2s</span></span>
<span class="line"><span>pc-job-v7rhr   1/1     Running             0          2s</span></span>
<span class="line"><span>pc-job-5vg2j   1/1     Running             0          3s</span></span>
<span class="line"><span>pc-job-fhwf7   0/1     Completed           0          12s</span></span>
<span class="line"><span>pc-job-v7rhr   0/1     Completed           0          12s</span></span>
<span class="line"><span>pc-job-5vg2j   0/1     Completed           0          12s</span></span>
<span class="line"><span></span></span>
<span class="line"><span># 删除job</span></span>
<span class="line"><span>[root@k8s-master01 ~]# kubectl delete -f pc-job.yaml</span></span>
<span class="line"><span>job.batch &quot;pc-job&quot; deleted</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_6-7-cronjob-cj" tabindex="-1"><a class="header-anchor" href="#_6-7-cronjob-cj"><span>6.7 CronJob(CJ)</span></a></h2><p>CronJob控制器以Job控制器资源为其管控对象，并借助它管理pod资源对象，Job控制器定义的作业任务在其控制器资源创建之后便会立即执行，但CronJob可以以类似于Linux操作系统的周期性任务作业计划的方式控制其运行<strong>时间点</strong>及<strong>重复运行</strong>的方式。也就是说，<strong>CronJob可以在特定的时间点(反复的)去运行job任务</strong>。</p><p>CronJob的资源清单文件：</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>apiVersion: batch/v1beta1 # 版本号</span></span>
<span class="line"><span>kind: CronJob # 类型       </span></span>
<span class="line"><span>metadata: # 元数据</span></span>
<span class="line"><span>  name: # rs名称 </span></span>
<span class="line"><span>  namespace: # 所属命名空间 </span></span>
<span class="line"><span>  labels: #标签</span></span>
<span class="line"><span>    controller: cronjob</span></span>
<span class="line"><span>spec: # 详情描述</span></span>
<span class="line"><span>  schedule: # cron格式的作业调度运行时间点,用于控制任务在什么时间执行</span></span>
<span class="line"><span>  concurrencyPolicy: # 并发执行策略，用于定义前一次作业运行尚未完成时是否以及如何运行后一次的作业</span></span>
<span class="line"><span>  failedJobHistoryLimit: # 为失败的任务执行保留的历史记录数，默认为1</span></span>
<span class="line"><span>  successfulJobHistoryLimit: # 为成功的任务执行保留的历史记录数，默认为3</span></span>
<span class="line"><span>  startingDeadlineSeconds: # 启动作业错误的超时时长</span></span>
<span class="line"><span>  jobTemplate: # job控制器模板，用于为cronjob控制器生成job对象;下面其实就是job的定义</span></span>
<span class="line"><span>    metadata:</span></span>
<span class="line"><span>    spec:</span></span>
<span class="line"><span>      completions: 1</span></span>
<span class="line"><span>      parallelism: 1</span></span>
<span class="line"><span>      activeDeadlineSeconds: 30</span></span>
<span class="line"><span>      backoffLimit: 6</span></span>
<span class="line"><span>      manualSelector: true</span></span>
<span class="line"><span>      selector:</span></span>
<span class="line"><span>        matchLabels:</span></span>
<span class="line"><span>          app: counter-pod</span></span>
<span class="line"><span>        matchExpressions: 规则</span></span>
<span class="line"><span>          - {key: app, operator: In, values: [counter-pod]}</span></span>
<span class="line"><span>      template:</span></span>
<span class="line"><span>        metadata:</span></span>
<span class="line"><span>          labels:</span></span>
<span class="line"><span>            app: counter-pod</span></span>
<span class="line"><span>        spec:</span></span>
<span class="line"><span>          restartPolicy: Never </span></span>
<span class="line"><span>          containers:</span></span>
<span class="line"><span>          - name: counter</span></span>
<span class="line"><span>            image: busybox:1.30</span></span>
<span class="line"><span>            command: [&quot;bin/sh&quot;,&quot;-c&quot;,&quot;for i in 9 8 7 6 5 4 3 2 1; do echo $i;sleep 20;done&quot;]</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><a href="https://www.jianshu.com/p/e9ce1a7e1ed1" target="_blank" rel="noopener noreferrer">Cron表达式的详细用法 - 简书 (jianshu.com)</a></p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>需要重点解释的几个选项：</span></span>
<span class="line"><span>schedule: cron表达式，用于指定任务的执行时间</span></span>
<span class="line"><span>    */1    *      *    *     *</span></span>
<span class="line"><span>    &lt;分钟&gt; &lt;小时&gt; &lt;日&gt; &lt;月份&gt; &lt;星期&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    分钟 值从 0 到 59.</span></span>
<span class="line"><span>    小时 值从 0 到 23.</span></span>
<span class="line"><span>    日 值从 1 到 31.</span></span>
<span class="line"><span>    月 值从 1 到 12.</span></span>
<span class="line"><span>    星期 值从 0 到 6, 0 代表星期日</span></span>
<span class="line"><span>    多个时间可以用逗号隔开； 范围可以用连字符给出；*可以作为通配符； /表示每...</span></span>
<span class="line"><span>concurrencyPolicy:</span></span>
<span class="line"><span>    Allow:   允许Jobs并发运行(默认)</span></span>
<span class="line"><span>    Forbid:  禁止并发运行，如果上一次运行尚未完成，则跳过下一次运行</span></span>
<span class="line"><span>    Replace: 替换，取消当前正在运行的作业并用新作业替换它</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span># pc-cronjob.yaml</span></span>
<span class="line"><span>apiVersion: batch/v1beta1</span></span>
<span class="line"><span>kind: CronJob</span></span>
<span class="line"><span>metadata:</span></span>
<span class="line"><span>  name: pc-cronjob</span></span>
<span class="line"><span>  namespace: dev</span></span>
<span class="line"><span>  labels:</span></span>
<span class="line"><span>    controller: cronjob</span></span>
<span class="line"><span>spec:</span></span>
<span class="line"><span>  schedule: &quot;*/1 * * * *&quot;</span></span>
<span class="line"><span>  jobTemplate:</span></span>
<span class="line"><span>    metadata:</span></span>
<span class="line"><span>    spec:</span></span>
<span class="line"><span>      template:</span></span>
<span class="line"><span>        spec:</span></span>
<span class="line"><span>          restartPolicy: Never</span></span>
<span class="line"><span>          containers:</span></span>
<span class="line"><span>          - name: counter</span></span>
<span class="line"><span>            image: busybox:1.30</span></span>
<span class="line"><span>            command: [&quot;bin/sh&quot;,&quot;-c&quot;,&quot;for i in 9 8 7 6 5 4 3 2 1; do echo $i;sleep 3;done&quot;]</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span># 创建cronjob</span></span>
<span class="line"><span>kubectl create -f pc-cronjob.yaml</span></span>
<span class="line"><span># 查看cronjob</span></span>
<span class="line"><span>kubectl get cronjobs -n dev</span></span>
<span class="line"><span># 查看job</span></span>
<span class="line"><span>kubectl get jobs -n dev</span></span>
<span class="line"><span># 查看pod</span></span>
<span class="line"><span>kubectl get pods -n dev</span></span>
<span class="line"><span># 删除cronjob</span></span>
<span class="line"><span>kubectl  delete -f pc-cronjob.yaml</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h1 id="_7-service详解" tabindex="-1"><a class="header-anchor" href="#_7-service详解"><span>7. Service详解</span></a></h1><h2 id="_7-1-service介绍" tabindex="-1"><a class="header-anchor" href="#_7-1-service介绍"><span>7.1 Service介绍</span></a></h2><p>在kubernetes中，pod是应用程序的载体，我们可以通过pod的ip来访问应用程序，但是pod的ip地址不是固定的，这也就意味着不方便直接采用pod的ip对服务进行访问。为了解决这个问题，kubernetes提供了Service资源，Service会对提供同一个服务的多个pod进行聚合，并且提供一个统一的入口地址。通过访问Service的入口地址就能访问到后面的pod服务。</p><p>Service在很多情况下只是一个概念，真正起作用的其实是kube-proxy服务进程，每个Node节点上都运行着一个kube-proxy服务进程。当创建Service的时候会通过api-server向etcd写入创建的service的信息，而kube-proxy会基于监听的机制发现这种Service的变动，然后<strong>它会将最新的Service信息转换成对应的访问规则</strong>。</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span># 10.97.97.97:80 是service提供的访问入口</span></span>
<span class="line"><span># 当访问这个入口的时候，可以发现后面有三个pod的服务在等待调用，</span></span>
<span class="line"><span># kube-proxy会基于rr（轮询）的策略，将请求分发到其中一个pod上去</span></span>
<span class="line"><span># 这个规则会同时在集群内的所有节点上都生成，所以在任何一个节点上访问都可以。</span></span>
<span class="line"><span>[root@node1 ~]# ipvsadm -Ln</span></span>
<span class="line"><span>IP Virtual Server version 1.2.1 (size=4096)</span></span>
<span class="line"><span>Prot LocalAddress:Port Scheduler Flags</span></span>
<span class="line"><span>  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn</span></span>
<span class="line"><span>TCP  10.97.97.97:80 rr</span></span>
<span class="line"><span>  -&gt; 10.244.1.39:80               Masq    1      0          0</span></span>
<span class="line"><span>  -&gt; 10.244.1.40:80               Masq    1      0          0</span></span>
<span class="line"><span>  -&gt; 10.244.2.33:80               Masq    1      0          0</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>kube-proxy目前支持三种工作模式:</p><h3 id="userspace-模式" tabindex="-1"><a class="header-anchor" href="#userspace-模式"><span><strong>userspace 模式</strong></span></a></h3><p>userspace模式下，kube-proxy会为每一个Service创建一个监听端口，发向Cluster<br> IP的请求被Iptables规则重定向到kube-proxy监听的端口上，kube-proxy根据LB算法选择一个提供服务的Pod并和其建立链接，以将请求转发到Pod上。</p><p>该模式下，kube-proxy充当了一个四层负责均衡器的角色。由于kube-proxy运行在userspace中，在进行转发处理时会增加内核和用户空间之间的数据拷贝，虽然比较稳定，但是效率比较低。</p><h3 id="iptables-模式" tabindex="-1"><a class="header-anchor" href="#iptables-模式"><span><strong>iptables 模式</strong></span></a></h3><p>iptables模式下，kube-proxy为service后端的每个Pod创建对应的iptables规则，直接将发向Cluster<br> IP的请求重定向到一个Pod IP。<br> 该模式下kube-proxy不承担四层负责均衡器的角色，只负责创建iptables规则。该模式的优点是较userspace模式效率更高，但不能提供灵活的LB策略，当后端Pod不可用时也无法进行重试。</p><h3 id="ipvs-模式" tabindex="-1"><a class="header-anchor" href="#ipvs-模式"><span><strong>ipvs 模式</strong></span></a></h3><p>ipvs模式和iptables类似，kube-proxy监控Pod的变化并创建相应的ipvs规则。ipvs相对iptables转发效率更高。除此以外，ipvs支持更多的LB算法。</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span># 此模式必须安装ipvs内核模块，否则会降级为iptables</span></span>
<span class="line"><span># 开启ipvs</span></span>
<span class="line"><span>[root@k8s-master01 ~]# kubectl edit cm kube-proxy -n kube-system</span></span>
<span class="line"><span># 修改mode: &quot;ipvs&quot;</span></span>
<span class="line"><span>[root@k8s-master01 ~]# kubectl delete pod -l k8s-app=kube-proxy -n kube-system</span></span>
<span class="line"><span>[root@node1 ~]# ipvsadm -Ln</span></span>
<span class="line"><span>IP Virtual Server version 1.2.1 (size=4096)</span></span>
<span class="line"><span>Prot LocalAddress:Port Scheduler Flags</span></span>
<span class="line"><span>  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn</span></span>
<span class="line"><span>TCP  10.97.97.97:80 rr</span></span>
<span class="line"><span>  -&gt; 10.244.1.39:80               Masq    1      0          0</span></span>
<span class="line"><span>  -&gt; 10.244.1.40:80               Masq    1      0          0</span></span>
<span class="line"><span>  -&gt; 10.244.2.33:80               Masq    1      0          0</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_7-2-service类型" tabindex="-1"><a class="header-anchor" href="#_7-2-service类型"><span>7.2 Service类型</span></a></h2><p>Service的资源清单文件：</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>kind: Service  # 资源类型</span></span>
<span class="line"><span>apiVersion: v1  # 资源版本</span></span>
<span class="line"><span>metadata: # 元数据</span></span>
<span class="line"><span>  name: service # 资源名称</span></span>
<span class="line"><span>  namespace: dev # 命名空间</span></span>
<span class="line"><span>spec: # 描述</span></span>
<span class="line"><span>  selector: # 标签选择器，用于确定当前service代理哪些pod</span></span>
<span class="line"><span>    app: nginx</span></span>
<span class="line"><span>  type: # Service类型，指定service的访问方式</span></span>
<span class="line"><span>  clusterIP:  # 虚拟服务的ip地址</span></span>
<span class="line"><span>  sessionAffinity: # session亲和性，支持ClientIP、None两个选项</span></span>
<span class="line"><span>  ports: # 端口信息</span></span>
<span class="line"><span>    - protocol: TCP </span></span>
<span class="line"><span>      port: 3017  # service端口</span></span>
<span class="line"><span>      targetPort: 5003 # pod端口</span></span>
<span class="line"><span>      nodePort: 31122 # 主机端口</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><p><strong>ClusterIP</strong>：默认值，它是Kubernetes系统自动分配的虚拟IP，只能在集群内部访问</p></li><li><p><strong>NodePort</strong>：将Service通过指定的Node上的端口暴露给外部，通过此方法，就可以在集群外部访问服务</p></li><li><p><strong>LoadBalancer</strong>：使用外接负载均衡器完成到服务的负载分发，注意此模式需要外部云环境支持</p></li><li><p><strong>ExternalName</strong>： 把集群外部的服务引入集群内部，直接使用</p></li></ul><h2 id="_7-3-service使用" tabindex="-1"><a class="header-anchor" href="#_7-3-service使用"><span>7.3 Service使用</span></a></h2><h3 id="_7-3-1-实验环境准备" tabindex="-1"><a class="header-anchor" href="#_7-3-1-实验环境准备"><span>7.3.1 实验环境准备</span></a></h3><p>在使用service之前，首先利用Deployment创建出3个pod，注意要为pod设置app=nginx-pod的标签</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span># pc-deployment.yaml</span></span>
<span class="line"><span>apiVersion: apps/v1</span></span>
<span class="line"><span>kind: Deployment      </span></span>
<span class="line"><span>metadata:</span></span>
<span class="line"><span>  name: pc-deployment</span></span>
<span class="line"><span>  namespace: dev</span></span>
<span class="line"><span>spec: </span></span>
<span class="line"><span>  replicas: 3</span></span>
<span class="line"><span>  selector:</span></span>
<span class="line"><span>    matchLabels:</span></span>
<span class="line"><span>      app: nginx-pod</span></span>
<span class="line"><span>  template:</span></span>
<span class="line"><span>    metadata:</span></span>
<span class="line"><span>      labels:</span></span>
<span class="line"><span>        app: nginx-pod</span></span>
<span class="line"><span>    spec:</span></span>
<span class="line"><span>      containers:</span></span>
<span class="line"><span>      - name: nginx</span></span>
<span class="line"><span>        image: nginx:1.17.1</span></span>
<span class="line"><span>        ports:</span></span>
<span class="line"><span>        - containerPort: 80</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>[root@k8s-master01 ~]# kubectl create -f pc-deployment.yaml</span></span>
<span class="line"><span>deployment.apps/pc-deployment created</span></span>
<span class="line"><span></span></span>
<span class="line"><span># 查看pod详情</span></span>
<span class="line"><span>[root@k8s-master01 ~]# kubectl get pods -n dev -o wide --show-labels</span></span>
<span class="line"><span>NAME                             READY   STATUS     IP            NODE     LABELS</span></span>
<span class="line"><span>pc-deployment-66cb59b984-8p84h   1/1     Running    10.244.1.39   node1    app=nginx-pod</span></span>
<span class="line"><span>pc-deployment-66cb59b984-vx8vx   1/1     Running    10.244.2.33   node2    app=nginx-pod</span></span>
<span class="line"><span>pc-deployment-66cb59b984-wnncx   1/1     Running    10.244.1.40   node1    app=nginx-pod</span></span>
<span class="line"><span></span></span>
<span class="line"><span># 为了方便后面的测试，修改下三台nginx的index.html页面（三台修改的IP地址不一致）</span></span>
<span class="line"><span>sudo kubectl exec -it pc-deployment-5ffc5bf56c-sg76p -n dev /bin/sh</span></span>
<span class="line"><span> echo &quot;1&quot; &gt; /usr/share/nginx/html/index.html</span></span>
<span class="line"><span> exit</span></span>
<span class="line"><span>sudo kubectl exec -it pc-deployment-5ffc5bf56c-hzp79 -n dev /bin/sh</span></span>
<span class="line"><span> echo &quot;2&quot; &gt; /usr/share/nginx/html/index.html</span></span>
<span class="line"><span>  exit</span></span>
<span class="line"><span>sudo kubectl exec -it pc-deployment-5ffc5bf56c-46rht -n dev /bin/sh</span></span>
<span class="line"><span> echo &quot;3&quot; &gt; /usr/share/nginx/html/index.html</span></span>
<span class="line"><span>  exit</span></span>
<span class="line"><span>#修改完毕之后，访问测试</span></span>
<span class="line"><span>[root@k8s-master01 ~]# curl 10.244.1.39</span></span>
<span class="line"><span>10.244.1.39</span></span>
<span class="line"><span>[root@k8s-master01 ~]# curl 10.244.2.33</span></span>
<span class="line"><span>10.244.2.33</span></span>
<span class="line"><span>[root@k8s-master01 ~]# curl 10.244.1.40</span></span>
<span class="line"><span>10.244.1.40</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_7-3-2-clusterip类型的service" tabindex="-1"><a class="header-anchor" href="#_7-3-2-clusterip类型的service"><span>7.3.2 ClusterIP类型的Service</span></a></h3><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span># pc-service-clusterip.yaml</span></span>
<span class="line"><span>apiVersion: v1</span></span>
<span class="line"><span>kind: Service</span></span>
<span class="line"><span>metadata:</span></span>
<span class="line"><span>  name: service-clusterip</span></span>
<span class="line"><span>  namespace: dev</span></span>
<span class="line"><span>spec:</span></span>
<span class="line"><span>  selector:</span></span>
<span class="line"><span>    app: nginx-pod</span></span>
<span class="line"><span>  clusterIP: 10.96.97.97 # service的ip地址，如果不写，默认会生成一个</span></span>
<span class="line"><span>  type: ClusterIP</span></span>
<span class="line"><span>  ports:</span></span>
<span class="line"><span>  - port: 80  # Service端口       </span></span>
<span class="line"><span>    targetPort: 80 # pod端口</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span># 创建service</span></span>
<span class="line"><span>[root@k8s-master01 ~]# kubectl create -f pc-service-clusterip.yaml</span></span>
<span class="line"><span>service/service-clusterip created</span></span>
<span class="line"><span></span></span>
<span class="line"><span># 查看service</span></span>
<span class="line"><span>[root@k8s-master01 ~]# kubectl get svc -n dev -o wide</span></span>
<span class="line"><span>NAME                TYPE        CLUSTER-IP    EXTERNAL-IP   PORT(S)   AGE   SELECTOR</span></span>
<span class="line"><span>service-clusterip   ClusterIP   10.96.97.97   &lt;none&gt;        80/TCP    13s   app=nginx-pod</span></span>
<span class="line"><span></span></span>
<span class="line"><span># 查看service的详细信息</span></span>
<span class="line"><span># 在这里有一个Endpoints列表，里面就是当前service可以负载到的服务入口</span></span>
<span class="line"><span>[root@k8s-master01 ~]# kubectl describe svc service-clusterip -n dev</span></span>
<span class="line"><span>Name:              service-clusterip</span></span>
<span class="line"><span>Namespace:         dev</span></span>
<span class="line"><span>Labels:            &lt;none&gt;</span></span>
<span class="line"><span>Annotations:       &lt;none&gt;</span></span>
<span class="line"><span>Selector:          app=nginx-pod</span></span>
<span class="line"><span>Type:              ClusterIP</span></span>
<span class="line"><span>IP:                10.97.97.97</span></span>
<span class="line"><span>Port:              &lt;unset&gt;  80/TCP</span></span>
<span class="line"><span>TargetPort:        80/TCP</span></span>
<span class="line"><span>Endpoints:         10.244.1.39:80,10.244.1.40:80,10.244.2.33:80</span></span>
<span class="line"><span>Session Affinity:  None</span></span>
<span class="line"><span>Events:            &lt;none&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span># 查看ipvs的映射规则</span></span>
<span class="line"><span>[root@k8s-master01 ~]# ipvsadm -Ln</span></span>
<span class="line"><span>TCP  10.97.97.97:80 rr</span></span>
<span class="line"><span>  -&gt; 10.244.1.39:80               Masq    1      0          0</span></span>
<span class="line"><span>  -&gt; 10.244.1.40:80               Masq    1      0          0</span></span>
<span class="line"><span>  -&gt; 10.244.2.33:80               Masq    1      0          0</span></span>
<span class="line"><span></span></span>
<span class="line"><span># 访问10.97.97.97:80观察效果</span></span>
<span class="line"><span>[root@k8s-master01 ~]# curl 10.97.97.97:80</span></span>
<span class="line"><span>10.244.2.33</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>Endpoint</strong></p><p>Endpoint是kubernetes中的一个资源对象，存储在etcd中，用来记录一个service对应的所有pod的访问地址，它是根据service配置文件中selector描述产生的。</p><p>一个Service由一组Pod组成，这些Pod通过Endpoints暴露出来，<strong>Endpoints是实现实际服务的端点集合</strong>。换句话说，service和pod之间的联系是通过endpoints实现的。</p><p><strong>负载分发策略</strong></p><p>对Service的访问被分发到了后端的Pod上去，目前kubernetes提供了两种负载分发策略：</p><ul><li><p>如果不定义，默认使用kube-proxy的策略，比如随机、轮询</p></li><li><p>基于客户端地址的会话保持模式，即来自同一个客户端发起的所有请求都会转发到固定的一个Pod上<br> 此模式可以使在spec中添加sessionAffinity:ClientIP选项</p></li></ul><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>sudo kubectl get endpoints -n dev -o wide</span></span>
<span class="line"><span></span></span>
<span class="line"><span># 查看ipvs的映射规则【rr 轮询】</span></span>
<span class="line"><span>[root@k8s-master01 ~]# ipvsadm -Ln</span></span>
<span class="line"><span>TCP  10.97.97.97:80 rr</span></span>
<span class="line"><span>  -&gt; 10.244.1.39:80               Masq    1      0          0</span></span>
<span class="line"><span>  -&gt; 10.244.1.40:80               Masq    1      0          0</span></span>
<span class="line"><span>  -&gt; 10.244.2.33:80               Masq    1      0          0</span></span>
<span class="line"><span></span></span>
<span class="line"><span># 循环访问测试</span></span>
<span class="line"><span>[root@k8s-master01 ~]# while true;do curl 10.96.97.97:80; sleep 1; done;</span></span>
<span class="line"><span>10.244.1.40</span></span>
<span class="line"><span>10.244.1.39</span></span>
<span class="line"><span>10.244.2.33</span></span>
<span class="line"><span>10.244.1.40</span></span>
<span class="line"><span>10.244.1.39</span></span>
<span class="line"><span>10.244.2.33</span></span>
<span class="line"><span></span></span>
<span class="line"><span># 修改分发策略----sessionAffinity:ClientIP</span></span>
<span class="line"><span># 查看ipvs规则【persistent 代表持久】</span></span>
<span class="line"><span>[root@k8s-master01 ~]# ipvsadm -Ln</span></span>
<span class="line"><span>TCP  10.97.97.97:80 rr persistent 10800</span></span>
<span class="line"><span>  -&gt; 10.244.1.39:80               Masq    1      0          0</span></span>
<span class="line"><span>  -&gt; 10.244.1.40:80               Masq    1      0          0</span></span>
<span class="line"><span>  -&gt; 10.244.2.33:80               Masq    1      0          0</span></span>
<span class="line"><span></span></span>
<span class="line"><span># 循环访问测试</span></span>
<span class="line"><span>[root@k8s-master01 ~]# while true;do curl 192.168.150.136:30002; sleep 1; done;</span></span>
<span class="line"><span>10.244.2.33</span></span>
<span class="line"><span>10.244.2.33</span></span>
<span class="line"><span>10.244.2.33</span></span>
<span class="line"><span>  </span></span>
<span class="line"><span># 删除service</span></span>
<span class="line"><span>[root@k8s-master01 ~]# kubectl delete -f service-clusterip.yaml</span></span>
<span class="line"><span>service &quot;service-clusterip&quot; deleted</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_7-3-3-headliness类型的service" tabindex="-1"><a class="header-anchor" href="#_7-3-3-headliness类型的service"><span>7.3.3 HeadLiness类型的Service</span></a></h3><p>在某些场景中，开发人员可能不想使用Service提供的负载均衡功能，而希望自己来控制负载均衡策略，针对这种情况，kubernetes提供了HeadLiness Service，这类Service不会分配Cluster IP，如果想要访问service，<strong>只能通过service的域名进行查询</strong>。</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span># service-headliness.yaml</span></span>
<span class="line"><span>apiVersion: v1</span></span>
<span class="line"><span>kind: Service</span></span>
<span class="line"><span>metadata:</span></span>
<span class="line"><span>  name: service-headliness</span></span>
<span class="line"><span>  namespace: dev</span></span>
<span class="line"><span>spec:</span></span>
<span class="line"><span>  selector:</span></span>
<span class="line"><span>    app: nginx-pod</span></span>
<span class="line"><span>  clusterIP: None # 将clusterIP设置为None，即可创建headliness Service</span></span>
<span class="line"><span>  type: ClusterIP</span></span>
<span class="line"><span>  ports:</span></span>
<span class="line"><span>  - port: 80    </span></span>
<span class="line"><span>    targetPort: 80</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span># 创建service</span></span>
<span class="line"><span>[root@k8s-master01 ~]# kubectl create -f service-headliness.yaml</span></span>
<span class="line"><span>service/service-headliness created</span></span>
<span class="line"><span></span></span>
<span class="line"><span># 获取service， 发现CLUSTER-IP未分配</span></span>
<span class="line"><span>[root@k8s-master01 ~]# kubectl get svc service-headliness -n dev -o wide</span></span>
<span class="line"><span>NAME                 TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE   SELECTOR</span></span>
<span class="line"><span>service-headliness   ClusterIP   None         &lt;none&gt;        80/TCP    11s   app=nginx-pod</span></span>
<span class="line"><span></span></span>
<span class="line"><span># 查看service详情</span></span>
<span class="line"><span>[root@k8s-master01 ~]# kubectl describe svc service-headliness  -n dev</span></span>
<span class="line"><span>Name:              service-headliness</span></span>
<span class="line"><span>Namespace:         dev</span></span>
<span class="line"><span>Labels:            &lt;none&gt;</span></span>
<span class="line"><span>Annotations:       &lt;none&gt;</span></span>
<span class="line"><span>Selector:          app=nginx-pod</span></span>
<span class="line"><span>Type:              ClusterIP</span></span>
<span class="line"><span>IP:                None</span></span>
<span class="line"><span>Port:              &lt;unset&gt;  80/TCP</span></span>
<span class="line"><span>TargetPort:        80/TCP</span></span>
<span class="line"><span>Endpoints:         10.244.1.39:80,10.244.1.40:80,10.244.2.33:80</span></span>
<span class="line"><span>Session Affinity:  None</span></span>
<span class="line"><span>Events:            &lt;none&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span># 查看域名的解析情况</span></span>
<span class="line"><span>[root@k8s-master01 ~]# kubectl exec -it pc-deployment-66cb59b984-8p84h -n dev /bin/sh</span></span>
<span class="line"><span>/ # cat /etc/resolv.conf</span></span>
<span class="line"><span>nameserver 10.96.0.10</span></span>
<span class="line"><span>search dev.svc.cluster.local svc.cluster.local cluster.local</span></span>
<span class="line"><span></span></span>
<span class="line"><span>[root@k8s-master01 ~]# dig @10.96.0.10 service-headliness.dev.svc.cluster.local</span></span>
<span class="line"><span>service-headliness.dev.svc.cluster.local. 30 IN A 10.244.1.40</span></span>
<span class="line"><span>service-headliness.dev.svc.cluster.local. 30 IN A 10.244.1.39</span></span>
<span class="line"><span>service-headliness.dev.svc.cluster.local. 30 IN A 10.244.2.33</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_7-3-4-nodeport类型的service" tabindex="-1"><a class="header-anchor" href="#_7-3-4-nodeport类型的service"><span>7.3.4 NodePort类型的Service</span></a></h3><p>在之前的样例中，创建的Service的ip地址只有集群内部才可以访问，如果希望将Service暴露给集群外部使用，那么就要使用到另外一种类型的Service，称为NodePort类型。NodePort的工作原理其实就是<strong>将service的端口映射到Node的一个端口上</strong>，然后就可以通过NodeIp:NodePort来访问service了。</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span># pc-service-nodeport.yaml</span></span>
<span class="line"><span>apiVersion: v1</span></span>
<span class="line"><span>kind: Service</span></span>
<span class="line"><span>metadata:</span></span>
<span class="line"><span>  name: service-nodeport</span></span>
<span class="line"><span>  namespace: dev</span></span>
<span class="line"><span>spec:</span></span>
<span class="line"><span>  selector:</span></span>
<span class="line"><span>    app: nginx-pod</span></span>
<span class="line"><span>  type: NodePort # service类型</span></span>
<span class="line"><span>  ports:</span></span>
<span class="line"><span>  - port: 80</span></span>
<span class="line"><span>    nodePort: 30002 # 指定绑定的node的端口(默认的取值范围是：30000-32767), 如果不指定，会默认分配</span></span>
<span class="line"><span>    targetPort: 80</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span># 创建service</span></span>
<span class="line"><span>[root@k8s-master01 ~]# kubectl create -f pc-service-nodeport.yaml</span></span>
<span class="line"><span>service/service-nodeport created</span></span>
<span class="line"><span></span></span>
<span class="line"><span># 查看service</span></span>
<span class="line"><span>[root@k8s-master01 ~]# kubectl get svc -n dev -o wide</span></span>
<span class="line"><span>NAME               TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)       SELECTOR</span></span>
<span class="line"><span>service-nodeport   NodePort   10.105.64.191   &lt;none&gt;        80:30002/TCP  app=nginx-pod</span></span>
<span class="line"><span></span></span>
<span class="line"><span># 接下来可以通过电脑主机的浏览器去访问集群中任意一个nodeip的30002端口，即可访问到pod</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_7-3-5-loadbalancer类型的service" tabindex="-1"><a class="header-anchor" href="#_7-3-5-loadbalancer类型的service"><span>7.3.5 LoadBalancer类型的Service</span></a></h3><p>LoadBalancer和NodePort很相似，目的都是向外部暴露一个端口，区别在于LoadBalancer会在集群的外部再来做一个负载均衡设备，而这个设备需要外部环境支持的，外部服务发送到这个设备上的请求，会被设备负载之后转发到集群中。</p><h3 id="_7-3-6-externalname类型的service" tabindex="-1"><a class="header-anchor" href="#_7-3-6-externalname类型的service"><span>7.3.6 ExternalName类型的Service</span></a></h3><p>ExternalName类型的Service用于引入集群外部的服务，它通过externalName属性指定外部一个服务的地址，然后在集群内部访问此service就可以访问到外部的服务了。</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>apiVersion: v1</span></span>
<span class="line"><span>kind: Service</span></span>
<span class="line"><span>metadata:</span></span>
<span class="line"><span>  name: service-externalname</span></span>
<span class="line"><span>  namespace: dev</span></span>
<span class="line"><span>spec:</span></span>
<span class="line"><span>  type: ExternalName # service类型</span></span>
<span class="line"><span>  externalName: www.baidu.com  #改成ip地址也可以</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span># 创建service</span></span>
<span class="line"><span>[root@k8s-master01 ~]# kubectl  create -f service-externalname.yaml</span></span>
<span class="line"><span>service/service-externalname created</span></span>
<span class="line"><span></span></span>
<span class="line"><span># 域名解析</span></span>
<span class="line"><span>[root@k8s-master01 ~]# dig @10.96.0.10 service-externalname.dev.svc.cluster.local</span></span>
<span class="line"><span>service-externalname.dev.svc.cluster.local. 30 IN CNAME www.baidu.com.</span></span>
<span class="line"><span>www.baidu.com.          30      IN      CNAME   www.a.shifen.com.</span></span>
<span class="line"><span>www.a.shifen.com.       30      IN      A       39.156.66.18</span></span>
<span class="line"><span>www.a.shifen.com.       30      IN      A       39.156.66.14</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_7-4-ingress介绍" tabindex="-1"><a class="header-anchor" href="#_7-4-ingress介绍"><span>7.4 Ingress介绍</span></a></h2><p>在前面课程中已经提到，Service对集群之外暴露服务的主要方式有两种：NotePort和LoadBalancer，但是这两种方式，都有一定的缺点：</p><ul><li><p>NodePort方式的缺点是会占用很多集群机器的端口，那么当集群服务变多的时候，这个缺点就愈发明显</p></li><li><p>LB方式的缺点是每个service需要一个LB，浪费、麻烦，并且需要kubernetes之外设备的支持</p></li></ul><p>基于这种现状，kubernetes提供了Ingress资源对象，Ingress只需要一个NodePort或者一个LB就可以满足暴露多个Service的需求。工作机制大致如下图表示：</p><p>实际上，Ingress相当于一个7层的负载均衡器，是kubernetes对反向代理的一个抽象，它的工作原理类似于Nginx，可以理解成在<strong>Ingress里建立诸多映射规则，Ingress Controller通过监听这些配置规则并转化成Nginx的反向代理配置 , 然后对外部提供服务</strong>。在这里有两个核心概念：</p><ul><li><p>ingress：kubernetes中的一个对象，作用是定义请求如何转发到service的规则</p></li><li><p>ingress controller：具体实现反向代理及负载均衡的程序，对ingress定义的规则进行解析，根据配置的规则来实现请求转发，实现方式有很多，比如Nginx, Contour, Haproxy等等</p></li></ul><p>Ingress（以Nginx为例）的工作原理如下：</p><ol><li><p>用户编写Ingress规则，说明哪个域名对应kubernetes集群中的哪个Service</p></li><li><p>Ingress控制器动态感知Ingress服务规则的变化，然后生成一段对应的Nginx反向代理配置</p></li><li><p>Ingress控制器会将生成的Nginx配置写入到一个运行着的Nginx服务中，并动态更新</p></li><li><p>到此为止，其实真正在工作的就是一个Nginx了，内部配置了用户定义的请求转发规则</p></li></ol><h2 id="_7-5-ingress使用" tabindex="-1"><a class="header-anchor" href="#_7-5-ingress使用"><span>7.5 Ingress使用</span></a></h2><h3 id="_7-5-1-环境准备" tabindex="-1"><a class="header-anchor" href="#_7-5-1-环境准备"><span>7.5.1 环境准备</span></a></h3><h4 id="搭建ingress环境" tabindex="-1"><a class="header-anchor" href="#搭建ingress环境"><span><strong>搭建ingress环境</strong></span></a></h4><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>kubectl apply -f ingress-control.yaml</span></span>
<span class="line"><span>kubectl get pod -n ingress-nginx</span></span>
<span class="line"><span># 查看service</span></span>
<span class="line"><span>kubectl get svc -n ingress-nginx</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="准备service和pod" tabindex="-1"><a class="header-anchor" href="#准备service和pod"><span><strong>准备service和pod</strong></span></a></h4><p>为了后面的实验比较方便，创建如下图所示的模型</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span># tomcat-nginx.yaml</span></span>
<span class="line"><span>apiVersion: apps/v1</span></span>
<span class="line"><span>kind: Deployment</span></span>
<span class="line"><span>metadata:</span></span>
<span class="line"><span>  name: nginx-deployment</span></span>
<span class="line"><span>  namespace: dev</span></span>
<span class="line"><span>spec:</span></span>
<span class="line"><span>  replicas: 3</span></span>
<span class="line"><span>  selector:</span></span>
<span class="line"><span>    matchLabels:</span></span>
<span class="line"><span>      app: nginx-pod</span></span>
<span class="line"><span>  template:</span></span>
<span class="line"><span>    metadata:</span></span>
<span class="line"><span>      labels:</span></span>
<span class="line"><span>        app: nginx-pod</span></span>
<span class="line"><span>    spec:</span></span>
<span class="line"><span>      containers:</span></span>
<span class="line"><span>      - name: nginx</span></span>
<span class="line"><span>        image: nginx:1.17.1</span></span>
<span class="line"><span>        ports:</span></span>
<span class="line"><span>        - containerPort: 80</span></span>
<span class="line"><span></span></span>
<span class="line"><span>---</span></span>
<span class="line"><span></span></span>
<span class="line"><span>apiVersion: apps/v1</span></span>
<span class="line"><span>kind: Deployment</span></span>
<span class="line"><span>metadata:</span></span>
<span class="line"><span>  name: tomcat-deployment</span></span>
<span class="line"><span>  namespace: dev</span></span>
<span class="line"><span>spec:</span></span>
<span class="line"><span>  replicas: 3</span></span>
<span class="line"><span>  selector:</span></span>
<span class="line"><span>    matchLabels:</span></span>
<span class="line"><span>      app: tomcat-pod</span></span>
<span class="line"><span>  template:</span></span>
<span class="line"><span>    metadata:</span></span>
<span class="line"><span>      labels:</span></span>
<span class="line"><span>        app: tomcat-pod</span></span>
<span class="line"><span>    spec:</span></span>
<span class="line"><span>      containers:</span></span>
<span class="line"><span>      - name: tomcat</span></span>
<span class="line"><span>        image: tomcat:8.5-jre10-slim</span></span>
<span class="line"><span>        ports:</span></span>
<span class="line"><span>        - containerPort: 8080</span></span>
<span class="line"><span></span></span>
<span class="line"><span>---</span></span>
<span class="line"><span></span></span>
<span class="line"><span>apiVersion: v1</span></span>
<span class="line"><span>kind: Service</span></span>
<span class="line"><span>metadata:</span></span>
<span class="line"><span>  name: nginx-service</span></span>
<span class="line"><span>  namespace: dev</span></span>
<span class="line"><span>spec:</span></span>
<span class="line"><span>  selector:</span></span>
<span class="line"><span>    app: nginx-pod</span></span>
<span class="line"><span>  clusterIP: None</span></span>
<span class="line"><span>  type: ClusterIP</span></span>
<span class="line"><span>  ports:</span></span>
<span class="line"><span>  - port: 80</span></span>
<span class="line"><span>    targetPort: 80</span></span>
<span class="line"><span></span></span>
<span class="line"><span>---</span></span>
<span class="line"><span></span></span>
<span class="line"><span>apiVersion: v1</span></span>
<span class="line"><span>kind: Service</span></span>
<span class="line"><span>metadata:</span></span>
<span class="line"><span>  name: tomcat-service</span></span>
<span class="line"><span>  namespace: dev</span></span>
<span class="line"><span>spec:</span></span>
<span class="line"><span>  selector:</span></span>
<span class="line"><span>    app: tomcat-pod</span></span>
<span class="line"><span>  clusterIP: None</span></span>
<span class="line"><span>  type: ClusterIP</span></span>
<span class="line"><span>  ports:</span></span>
<span class="line"><span>  - port: 8080</span></span>
<span class="line"><span>    targetPort: 8080</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_7-5-2-http代理" tabindex="-1"><a class="header-anchor" href="#_7-5-2-http代理"><span>7.5.2 Http代理</span></a></h3><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span># pc-ingress-http.yaml</span></span>
<span class="line"><span># kubectl explain Ingress.spec.rules.http.paths.backend.service</span></span>
<span class="line"><span>apiVersion: networking.k8s.io/v1</span></span>
<span class="line"><span>kind: Ingress</span></span>
<span class="line"><span>metadata:</span></span>
<span class="line"><span>  name: ingress-http</span></span>
<span class="line"><span>  namespace: dev</span></span>
<span class="line"><span>spec:</span></span>
<span class="line"><span>  rules:</span></span>
<span class="line"><span>  - host: nginx.itheima.com</span></span>
<span class="line"><span>    http:</span></span>
<span class="line"><span>      paths:</span></span>
<span class="line"><span>      - path: /</span></span>
<span class="line"><span>        pathType: Prefix</span></span>
<span class="line"><span>        backend:</span></span>
<span class="line"><span>          service:</span></span>
<span class="line"><span>            name: nginx-service</span></span>
<span class="line"><span>            port: </span></span>
<span class="line"><span>              number: 80</span></span>
<span class="line"><span>  - host: tomcat.itheima.com</span></span>
<span class="line"><span>    http:</span></span>
<span class="line"><span>      paths:</span></span>
<span class="line"><span>      - path: /</span></span>
<span class="line"><span>        pathType: Prefix</span></span>
<span class="line"><span>        backend:</span></span>
<span class="line"><span>          service:</span></span>
<span class="line"><span>            name: tomcat-service</span></span>
<span class="line"><span>            port: </span></span>
<span class="line"><span>              number: 8080</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span># 创建</span></span>
<span class="line"><span>kubectl apply -f pc-ingress-http.yaml</span></span>
<span class="line"><span># 查看</span></span>
<span class="line"><span>sudo kubectl get ing ingress-http -n dev</span></span>
<span class="line"><span># 查看详情</span></span>
<span class="line"><span>sudo kubectl describe ing ingress-http  -n dev</span></span>
<span class="line"><span># 注意看上面的Address栏</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_7-5-3-https代理" tabindex="-1"><a class="header-anchor" href="#_7-5-3-https代理"><span>7.5.3 Https代理</span></a></h3><h4 id="创建证书" tabindex="-1"><a class="header-anchor" href="#创建证书"><span>创建证书</span></a></h4><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span># 生成证书</span></span>
<span class="line"><span>openssl req -x509 -sha256 -nodes -days 365 -newkey rsa:2048 -keyout tls.key -out tls.crt -subj &quot;/C=CN/ST=BJ/L=BJ/O=nginx/CN=itheima.com&quot;</span></span>
<span class="line"><span></span></span>
<span class="line"><span># 创建密钥</span></span>
<span class="line"><span>kubectl create secret tls tls-secret --key tls.key --cert tls.crt</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span># ingress-https.yaml</span></span>
<span class="line"><span>apiVersion: extensions/v1beta1</span></span>
<span class="line"><span>kind: Ingress</span></span>
<span class="line"><span>metadata:</span></span>
<span class="line"><span>  name: ingress-https</span></span>
<span class="line"><span>  namespace: dev</span></span>
<span class="line"><span>spec:</span></span>
<span class="line"><span>  tls:</span></span>
<span class="line"><span>    - hosts:</span></span>
<span class="line"><span>      - nginx.itheima.com</span></span>
<span class="line"><span>      - tomcat.itheima.com</span></span>
<span class="line"><span>      secretName: tls-secret # 指定秘钥</span></span>
<span class="line"><span>  rules:</span></span>
<span class="line"><span>  - host: nginx.itheima.com</span></span>
<span class="line"><span>    http:</span></span>
<span class="line"><span>      paths:</span></span>
<span class="line"><span>      - path: /</span></span>
<span class="line"><span>        backend:</span></span>
<span class="line"><span>          serviceName: nginx-service</span></span>
<span class="line"><span>          servicePort: 80</span></span>
<span class="line"><span>  - host: tomcat.itheima.com</span></span>
<span class="line"><span>    http:</span></span>
<span class="line"><span>      paths:</span></span>
<span class="line"><span>      - path: /</span></span>
<span class="line"><span>        backend:</span></span>
<span class="line"><span>          serviceName: tomcat-service</span></span>
<span class="line"><span>          servicePort: 8080</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span># 创建</span></span>
<span class="line"><span>kubectl create -f ingress-https.yaml</span></span>
<span class="line"><span># 查看</span></span>
<span class="line"><span>kubectl get ing ingress-https -n dev</span></span>
<span class="line"><span># 查看详情</span></span>
<span class="line"><span>kubectl describe ing ingress-https -n dev</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h1 id="_8-数据存储" tabindex="-1"><a class="header-anchor" href="#_8-数据存储"><span>8. 数据存储</span></a></h1><p>为了持久化保存容器的数据，kubernetes引入了Volume的概念。</p><p>Volume是Pod中能够被多个容器访问的共享目录，它被定义在Pod上，然后被一个Pod里的多个容器挂载到具体的文件目录下，kubernetes通过Volume实现同一个Pod中不同容器之间的数据共享以及数据的持久化存储。Volume的生命容器不与Pod中单个容器的生命周期相关，当容器终止或者重启时，Volume中的数据也不会丢失。</p><p>kubernetes的Volume支持多种类型，比较常见的有下面几个：</p><ul><li><p>简单存储：EmptyDir、HostPath、NFS</p></li><li><p>高级存储：PV、PVC</p></li><li><p>配置存储：ConfigMap、Secret</p></li></ul><h2 id="_8-1-基本存储" tabindex="-1"><a class="header-anchor" href="#_8-1-基本存储"><span>8.1 基本存储</span></a></h2><h3 id="_8-1-1-emptydir" tabindex="-1"><a class="header-anchor" href="#_8-1-1-emptydir"><span>8.1.1 EmptyDir</span></a></h3><p>EmptyDir是最基础的Volume类型，一个EmptyDir就是Host上的一个空目录。</p><p>EmptyDir是在Pod被分配到Node时创建的，它的初始内容为空，并且无须指定宿主机上对应的目录文件，因为kubernetes会自动分配一个目录，当Pod销毁时， EmptyDir中的数据也会被永久删除。 EmptyDir用途如下：</p><ul><li><p><strong>临时空间，例如用于某些应用程序运行时所需的临时目录，且无须永久保留</strong></p></li><li><p><strong>一个容器需要从另一个容器中获取数据的目录（多容器共享目录）</strong></p></li></ul><p>接下来，通过一个容器之间文件共享的案例来使用一下EmptyDir。</p><p>在一个Pod中准备两个容器nginx和busybox，然后声明一个Volume分别挂在到两个容器的目录中，然后nginx容器负责向Volume中写日志，busybox中通过命令将日志内容读到控制台。</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span># volume-emptydir.yaml</span></span>
<span class="line"><span>apiVersion: v1</span></span>
<span class="line"><span>kind: Pod</span></span>
<span class="line"><span>metadata:</span></span>
<span class="line"><span>  name: volume-emptydir</span></span>
<span class="line"><span>  namespace: dev</span></span>
<span class="line"><span>spec:</span></span>
<span class="line"><span>  containers:</span></span>
<span class="line"><span>  - name: nginx</span></span>
<span class="line"><span>    image: nginx:1.17.1</span></span>
<span class="line"><span>    ports:</span></span>
<span class="line"><span>    - containerPort: 80</span></span>
<span class="line"><span>    volumeMounts:  # 将logs-volume挂在到nginx容器中，对应的目录为 /var/log/nginx</span></span>
<span class="line"><span>    - name: logs-volume</span></span>
<span class="line"><span>      mountPath: /var/log/nginx</span></span>
<span class="line"><span>  - name: busybox</span></span>
<span class="line"><span>    image: busybox:1.30</span></span>
<span class="line"><span>    command: [&quot;/bin/sh&quot;,&quot;-c&quot;,&quot;tail -f /logs/access.log&quot;] # 初始命令，动态读取指定文件中内容</span></span>
<span class="line"><span>    volumeMounts:  # 将logs-volume 挂在到busybox容器中，对应的目录为 /logs</span></span>
<span class="line"><span>    - name: logs-volume</span></span>
<span class="line"><span>      mountPath: /logs</span></span>
<span class="line"><span>  volumes: # 声明volume， name为logs-volume，类型为emptyDir</span></span>
<span class="line"><span>  - name: logs-volume</span></span>
<span class="line"><span>    emptyDir: {}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span># 创建Pod</span></span>
<span class="line"><span>kubectl create -f volume-emptydir.yaml</span></span>
<span class="line"><span># 查看pod</span></span>
<span class="line"><span>kubectl get pods volume-emptydir -n dev -o wide</span></span>
<span class="line"><span># 通过podIp访问nginx</span></span>
<span class="line"><span>curl 10.42.2.9</span></span>
<span class="line"><span># 通过kubectl logs命令查看指定容器的标准输出</span></span>
<span class="line"><span>kubectl logs -f volume-emptydir -n dev -c busybox</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_8-1-2-hostpath" tabindex="-1"><a class="header-anchor" href="#_8-1-2-hostpath"><span>8.1.2 HostPath</span></a></h3><p>HostPath就是将Node主机中一个实际目录挂在到Pod中，以供容器使用，这样的设计就可以保证Pod销毁了，但是数据依据可以存在于Node主机上。</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span># volume-hostpath.yaml</span></span>
<span class="line"><span>apiVersion: v1</span></span>
<span class="line"><span>kind: Pod</span></span>
<span class="line"><span>metadata:</span></span>
<span class="line"><span>  name: volume-hostpath</span></span>
<span class="line"><span>  namespace: dev</span></span>
<span class="line"><span>spec:</span></span>
<span class="line"><span>  containers:</span></span>
<span class="line"><span>  - name: nginx</span></span>
<span class="line"><span>    image: nginx:1.17.1</span></span>
<span class="line"><span>    ports:</span></span>
<span class="line"><span>    - containerPort: 80</span></span>
<span class="line"><span>    volumeMounts:</span></span>
<span class="line"><span>    - name: logs-volume</span></span>
<span class="line"><span>      mountPath: /var/log/nginx</span></span>
<span class="line"><span>  - name: busybox</span></span>
<span class="line"><span>    image: busybox:1.30</span></span>
<span class="line"><span>    command: [&quot;/bin/sh&quot;,&quot;-c&quot;,&quot;tail -f /logs/access.log&quot;]</span></span>
<span class="line"><span>    volumeMounts:</span></span>
<span class="line"><span>    - name: logs-volume</span></span>
<span class="line"><span>      mountPath: /logs</span></span>
<span class="line"><span>  volumes:</span></span>
<span class="line"><span>  - name: volume</span></span>
<span class="line"><span>    persistentVolumeClaim:</span></span>
<span class="line"><span>      claimName: pvc1</span></span>
<span class="line"><span>      readOnly: false</span></span>
<span class="line"><span>  - name: logs-volume</span></span>
<span class="line"><span>    hostPath: </span></span>
<span class="line"><span>      path: /root/logs</span></span>
<span class="line"><span>      type: DirectoryOrCreate  # 目录存在就使用，不存在就先创建后使用</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span># sudo kubectl apply -f volume-hostpath.yaml</span></span>
<span class="line"><span>关于type的值的一点说明：</span></span>
<span class="line"><span>    DirectoryOrCreate 目录存在就使用，不存在就先创建后使用</span></span>
<span class="line"><span>    Directory   目录必须存在</span></span>
<span class="line"><span>    FileOrCreate  文件存在就使用，不存在就先创建后使用</span></span>
<span class="line"><span>    File 文件必须存在 </span></span>
<span class="line"><span>    Socket  unix套接字必须存在</span></span>
<span class="line"><span>    CharDevice  字符设备必须存在</span></span>
<span class="line"><span>    BlockDevice 块设备必须存在</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_8-1-3-nfs" tabindex="-1"><a class="header-anchor" href="#_8-1-3-nfs"><span>8.1.3 NFS</span></a></h3><p>HostPath可以解决数据持久化的问题，但是一旦Node节点故障了，Pod如果转移到了别的节点，又会出现问题了，此时需要准备单独的网络存储系统，比较常用的用NFS、CIFS。</p><p>NFS是一个网络文件存储系统，可以搭建一台NFS服务器，然后将Pod中的存储直接连接到NFS系统上，这样的话，无论Pod在节点上怎么转移，只要Node跟NFS的对接没问题，数据就可以成功访问。</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>nfs安装见 Linux环境配置</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span># volume-nfs.yaml</span></span>
<span class="line"><span>apiVersion: v1</span></span>
<span class="line"><span>kind: Pod</span></span>
<span class="line"><span>metadata:</span></span>
<span class="line"><span>  name: volume-nfs</span></span>
<span class="line"><span>  namespace: dev</span></span>
<span class="line"><span>spec:</span></span>
<span class="line"><span>  containers:</span></span>
<span class="line"><span>  - name: nginx</span></span>
<span class="line"><span>    image: nginx:1.17.1</span></span>
<span class="line"><span>    ports:</span></span>
<span class="line"><span>    - containerPort: 80</span></span>
<span class="line"><span>    volumeMounts:</span></span>
<span class="line"><span>    - name: logs-volume</span></span>
<span class="line"><span>      mountPath: /var/log/nginx</span></span>
<span class="line"><span>  - name: busybox</span></span>
<span class="line"><span>    image: busybox:1.30</span></span>
<span class="line"><span>    command: [&quot;/bin/sh&quot;,&quot;-c&quot;,&quot;tail -f /logs/access.log&quot;] </span></span>
<span class="line"><span>    volumeMounts:</span></span>
<span class="line"><span>    - name: logs-volume</span></span>
<span class="line"><span>      mountPath: /logs</span></span>
<span class="line"><span>  volumes:</span></span>
<span class="line"><span>  - name: logs-volume</span></span>
<span class="line"><span>    nfs:</span></span>
<span class="line"><span>      server: 192.168.5.6  #nfs服务器地址</span></span>
<span class="line"><span>      path: /root/data/nfs #共享文件路径</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span># 查看主节点挂载目录</span></span>
<span class="line"><span>showmount -e</span></span>
<span class="line"><span># 创建pod</span></span>
<span class="line"><span>kubectl create -f volume-nfs.yaml</span></span>
<span class="line"><span># 查看pod</span></span>
<span class="line"><span>kubectl get pods volume-nfs -n dev</span></span>
<span class="line"><span># 查看nfs服务器上的共享目录，发现已经有文件了</span></span>
<span class="line"><span>ls /root/data/</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_8-2-高级存储" tabindex="-1"><a class="header-anchor" href="#_8-2-高级存储"><span>8.2 高级存储</span></a></h2><p>PV（Persistent Volume）是持久化卷的意思，是对底层的共享存储的一种抽象。一般情况下PV由kubernetes管理员进行创建和配置，它与底层具体的共享存储技术有关，并通过插件完成与共享存储的对接。</p><p>PVC（Persistent Volume Claim）是持久卷声明的意思，是用户对于存储需求的一种声明。换句话说，PVC其实就是用户向kubernetes系统发出的一种资源需求申请。</p><p>使用了PV和PVC之后，工作可以得到进一步的细分：</p><ul><li><p>存储：存储工程师维护</p></li><li><p>PV： kubernetes管理员维护</p></li><li><p>PVC：kubernetes用户维护</p></li></ul><h3 id="_8-2-1-pv" tabindex="-1"><a class="header-anchor" href="#_8-2-1-pv"><span>8.2.1 PV</span></a></h3><p>PV是存储资源的抽象，下面是资源清单文件:</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>apiVersion: v1  </span></span>
<span class="line"><span>kind: PersistentVolume</span></span>
<span class="line"><span>metadata:</span></span>
<span class="line"><span>  name: pv2</span></span>
<span class="line"><span>spec:</span></span>
<span class="line"><span>  nfs: # 存储类型，与底层真正存储对应</span></span>
<span class="line"><span>  capacity:  # 存储能力，目前只支持存储空间的设置</span></span>
<span class="line"><span>    storage: 2Gi</span></span>
<span class="line"><span>  accessModes:  # 访问模式</span></span>
<span class="line"><span>  storageClassName: # 存储类别</span></span>
<span class="line"><span>  persistentVolumeReclaimPolicy: # 回收策略</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>PV 的关键配置参数说明：</p><ul><li><p><strong>存储类型</strong><br> 底层实际存储的类型，kubernetes支持多种存储类型，每种存储类型的配置都有所差异</p></li><li><p><strong>存储能力（capacity）</strong></p></li></ul><p>目前只支持存储空间的设置( storage=1Gi )，不过未来可能会加入IOPS、吞吐量等指标的配置</p><ul><li><p><strong>访问模式（accessModes）</strong><br> 用于描述用户应用对存储资源的访问权限，访问权限包括下面几种方式：</p><ul><li><p>ReadWriteOnce（RWO）：读写权限，但是只能被单个节点挂载</p></li><li><p>ReadOnlyMany（ROX）： 只读权限，可以被多个节点挂载</p></li><li><p>ReadWriteMany（RWX）：读写权限，可以被多个节点挂载</p></li></ul></li></ul><p>需要注意的是，底层不同的存储类型可能支持的访问模式不同</p><ul><li>**回收策略（persistentVolumeReclaimPolicy）**当PV不再被使用了之后，对其的处理方式。目前支持三种策略： <ul><li>Retain （保留） 保留数据，需要管理员手工清理数据</li><li>Recycle（回收） 清除 PV 中的数据，效果相当于执行 rm -rf /thevolume/*</li><li>Delete （删除） 与 PV 相连的后端存储完成 volume 的删除操作，当然这常见于云服务商的存储服务</li></ul></li><li>需要注意的是，底层不同的存储类型可能支持的回收策略不同</li><li><strong>存储类别</strong>PV可以通过storageClassName参数指定一个存储类别 <ul><li>具有特定类别的PV只能与请求了该类别的PVC进行绑定</li><li>未设定类别的PV则只能与不请求任何类别的PVC进行绑定</li></ul></li><li>**状态（status）**一个 PV 的生命周期中，可能会处于4中不同的阶段： <ul><li>Available（可用）： 表示可用状态，还未被任何 PVC 绑定</li><li>Bound（已绑定）： 表示 PV 已经被 PVC 绑定</li><li>Released（已释放）： 表示 PVC 被删除，但是资源还未被集群重新声明</li><li>Failed（失败）： 表示该 PV 的自动回收失败</li></ul></li></ul><p><strong>实验</strong><br> 使用NFS作为存储，来演示PV的使用，创建3个PV，对应NFS中的3个暴露的路径。</p><ol><li>准备NFS环境</li></ol><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span># 创建目录</span></span>
<span class="line"><span>mkdir /nfs/test/{pv1,pv2,pv3} -pv</span></span>
<span class="line"><span></span></span>
<span class="line"><span># 暴露服务</span></span>
<span class="line"><span>cat &gt;  /etc/exports &lt;&lt;EOF  # 覆盖写！</span></span>
<span class="line"><span>/nfs/test/pv1     192.168.150.0/24(rw,no_root_squash)</span></span>
<span class="line"><span>/nfs/test/pv2     192.168.150.0/24(rw,no_root_squash)</span></span>
<span class="line"><span>/nfs/test/pv3     192.168.150.0/24(rw,no_root_squash)</span></span>
<span class="line"><span>/nfs/data  *(rw,async,no_root_squash)</span></span>
<span class="line"><span>EOF</span></span>
<span class="line"><span>systemctl restart nfs</span></span>
<span class="line"><span>service nfs status</span></span>
<span class="line"><span>echo &quot;/nfs/data/ 192.168.150.0/24(insecure,rw,sync,no_root_squash)&quot;  &gt;&gt; /etc/exports  #追加写</span></span>
<span class="line"><span></span></span>
<span class="line"><span>systemctl status rpcbind</span></span>
<span class="line"><span>systemctl status nfs</span></span>
<span class="line"><span></span></span>
<span class="line"><span>umount /nfs/data</span></span>
<span class="line"><span>mount -t nfs 192.168.150.135:/nfs/data /nfs/data</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol><li>创建</li></ol><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span># pv-test001.yaml</span></span>
<span class="line"><span>apiVersion: v1</span></span>
<span class="line"><span>kind: PersistentVolume</span></span>
<span class="line"><span>metadata:</span></span>
<span class="line"><span>  name:  pv1</span></span>
<span class="line"><span>  labels:</span></span>
<span class="line"><span>    number: pv1</span></span>
<span class="line"><span>spec:</span></span>
<span class="line"><span>  capacity: </span></span>
<span class="line"><span>    storage: 1Gi</span></span>
<span class="line"><span>  accessModes:</span></span>
<span class="line"><span>  - ReadWriteMany</span></span>
<span class="line"><span>  nfs:</span></span>
<span class="line"><span>    path: /nfs/test/pv1</span></span>
<span class="line"><span>    server: 192.168.150.135</span></span>
<span class="line"><span></span></span>
<span class="line"><span>---</span></span>
<span class="line"><span></span></span>
<span class="line"><span>apiVersion: v1</span></span>
<span class="line"><span>kind: PersistentVolume</span></span>
<span class="line"><span>metadata:</span></span>
<span class="line"><span>  name:  pv2</span></span>
<span class="line"><span>  labels:</span></span>
<span class="line"><span>    number: pv2</span></span>
<span class="line"><span>spec:</span></span>
<span class="line"><span>  capacity: </span></span>
<span class="line"><span>    storage: 2Gi</span></span>
<span class="line"><span>  accessModes:</span></span>
<span class="line"><span>  - ReadWriteMany</span></span>
<span class="line"><span>  nfs:</span></span>
<span class="line"><span>    path: /nfs/test/pv2</span></span>
<span class="line"><span>    server: 192.168.150.135</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>---</span></span>
<span class="line"><span></span></span>
<span class="line"><span>apiVersion: v1</span></span>
<span class="line"><span>kind: PersistentVolume</span></span>
<span class="line"><span>metadata:</span></span>
<span class="line"><span>  name:  pv3</span></span>
<span class="line"><span>  labels:</span></span>
<span class="line"><span>    number: pv3</span></span>
<span class="line"><span>spec:</span></span>
<span class="line"><span>  capacity: </span></span>
<span class="line"><span>    storage: 3Gi</span></span>
<span class="line"><span>  accessModes:</span></span>
<span class="line"><span>  - ReadWriteMany</span></span>
<span class="line"><span>  nfs:</span></span>
<span class="line"><span>    path: /nfs/test/pv3</span></span>
<span class="line"><span>    server: 192.168.150.135</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span># 创建 pv</span></span>
<span class="line"><span>sudo kubectl apply -f pv-test001.yaml</span></span>
<span class="line"><span># 查看pv</span></span>
<span class="line"><span>kubectl get pv -o wide</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_8-2-2-pvc" tabindex="-1"><a class="header-anchor" href="#_8-2-2-pvc"><span>8.2.2 PVC</span></a></h3><p>PVC是资源的申请，用来声明对存储空间、访问模式、存储类别需求信息。下面是资源清单文件:</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>apiVersion: v1</span></span>
<span class="line"><span>kind: PersistentVolumeClaim</span></span>
<span class="line"><span>metadata:</span></span>
<span class="line"><span>  name: pvc</span></span>
<span class="line"><span>  namespace: dev</span></span>
<span class="line"><span>spec:</span></span>
<span class="line"><span>  accessModes: # 访问模式</span></span>
<span class="line"><span>  selector: # 采用标签对PV选择</span></span>
<span class="line"><span>  storageClassName: # 存储类别</span></span>
<span class="line"><span>  resources: # 请求空间</span></span>
<span class="line"><span>    requests:</span></span>
<span class="line"><span>      storage: 5Gi</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>PVC 的关键配置参数说明：</p><ul><li><strong>访问模式（accessModes）</strong></li></ul><p>用于描述用户应用对存储资源的访问权限</p><ul><li><p><strong>选择条件（selector）</strong><br> 通过Label Selector的设置，可使PVC对于系统中己存在的PV进行筛选</p></li><li><p><strong>存储类别（storageClassName）</strong><br> PVC在定义时可以设定需要的后端存储的类别，只有设置了该class的pv才能被系统选出</p></li><li><p><strong>资源请求（Resources ）</strong><br> 描述对存储资源的请求</p></li></ul><p><strong>实验</strong></p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span># pvc-test001.yaml</span></span>
<span class="line"><span>apiVersion: v1</span></span>
<span class="line"><span>kind: PersistentVolumeClaim</span></span>
<span class="line"><span>metadata:</span></span>
<span class="line"><span>  name: pvc1</span></span>
<span class="line"><span>  namespace: dev</span></span>
<span class="line"><span>spec:</span></span>
<span class="line"><span>  accessModes: </span></span>
<span class="line"><span>  - ReadWriteMany</span></span>
<span class="line"><span>  resources:</span></span>
<span class="line"><span>    requests:</span></span>
<span class="line"><span>      storage: 1Gi </span></span>
<span class="line"><span>---</span></span>
<span class="line"><span>apiVersion: v1</span></span>
<span class="line"><span>kind: PersistentVolumeClaim</span></span>
<span class="line"><span>metadata:</span></span>
<span class="line"><span>  name: pvc2</span></span>
<span class="line"><span>  namespace: dev</span></span>
<span class="line"><span>spec:</span></span>
<span class="line"><span>  accessModes: </span></span>
<span class="line"><span>  - ReadWriteMany</span></span>
<span class="line"><span>  resources:</span></span>
<span class="line"><span>    requests:</span></span>
<span class="line"><span>      storage: 1Gi</span></span>
<span class="line"><span>---</span></span>
<span class="line"><span>apiVersion: v1</span></span>
<span class="line"><span>kind: PersistentVolumeClaim</span></span>
<span class="line"><span>metadata:</span></span>
<span class="line"><span>  name: pvc3</span></span>
<span class="line"><span>  namespace: dev</span></span>
<span class="line"><span>spec:</span></span>
<span class="line"><span>  accessModes: </span></span>
<span class="line"><span>  - ReadWriteMany</span></span>
<span class="line"><span>  resources:</span></span>
<span class="line"><span>    requests:</span></span>
<span class="line"><span>      storage: 1Gi</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span># 创建pvc</span></span>
<span class="line"><span>sudo kubectl apply -f pvc-test001.yaml</span></span>
<span class="line"><span># 查看pvc</span></span>
<span class="line"><span>sudo kubectl get pvc  -n dev -o wide</span></span>
<span class="line"><span># 查看pv</span></span>
<span class="line"><span>sudo kubectl get pv -o wide</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span># pods-test001.yaml  使用pvc</span></span>
<span class="line"><span>apiVersion: v1</span></span>
<span class="line"><span>kind: Pod</span></span>
<span class="line"><span>metadata:</span></span>
<span class="line"><span>  name: pod1</span></span>
<span class="line"><span>  namespace: dev</span></span>
<span class="line"><span>spec:</span></span>
<span class="line"><span>  containers:</span></span>
<span class="line"><span>  - name: busybox</span></span>
<span class="line"><span>    image: busybox:1.30</span></span>
<span class="line"><span>    command: [&quot;/bin/sh&quot;,&quot;-c&quot;,&quot;while true;do echo pod1 &gt;&gt; /root/out.txt; sleep 1; done;&quot;]</span></span>
<span class="line"><span>    volumeMounts:</span></span>
<span class="line"><span>    - name: volume</span></span>
<span class="line"><span>      mountPath: /root</span></span>
<span class="line"><span>  volumes:</span></span>
<span class="line"><span>    - name: volume</span></span>
<span class="line"><span>      persistentVolumeClaim:</span></span>
<span class="line"><span>        claimName: pvc1</span></span>
<span class="line"><span>        readOnly: false</span></span>
<span class="line"><span>---</span></span>
<span class="line"><span>apiVersion: v1</span></span>
<span class="line"><span>kind: Pod</span></span>
<span class="line"><span>metadata:</span></span>
<span class="line"><span>  name: pod2</span></span>
<span class="line"><span>  namespace: dev</span></span>
<span class="line"><span>spec:</span></span>
<span class="line"><span>  containers:</span></span>
<span class="line"><span>  - name: busybox</span></span>
<span class="line"><span>    image: busybox:1.30</span></span>
<span class="line"><span>    command: [&quot;/bin/sh&quot;,&quot;-c&quot;,&quot;while true;do echo pod2 &gt;&gt; /root/out.txt; sleep 1; done;&quot;]</span></span>
<span class="line"><span>    volumeMounts:</span></span>
<span class="line"><span>    - name: volume</span></span>
<span class="line"><span>      mountPath: /root</span></span>
<span class="line"><span>  volumes:</span></span>
<span class="line"><span>    - name: volume</span></span>
<span class="line"><span>      persistentVolumeClaim:</span></span>
<span class="line"><span>        claimName: pvc2</span></span>
<span class="line"><span>        readOnly: false</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>kubectl exec -it pod1 -n dev -- /bin/bash </span></span>
<span class="line"><span></span></span>
<span class="line"><span># 创建pod</span></span>
<span class="line"><span>sudo kubectl apply -f pods-test001.yaml</span></span>
<span class="line"><span># 查看pod</span></span>
<span class="line"><span>kubectl get pods -n dev -o wide</span></span>
<span class="line"><span># 查看pvc</span></span>
<span class="line"><span>kubectl get pvc -n dev -o yaml</span></span>
<span class="line"><span># 查看pv挂载路径</span></span>
<span class="line"><span>sudo kubectl get pv pvc-9c9e200c-259a-4652-8a35-ab19927447b4  -o yaml | grep path</span></span>
<span class="line"><span># 查看所有 path</span></span>
<span class="line"><span>sudo kubectl get pv -o yaml | grep path | grep &lt;pvc-name&gt;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_8-2-3-生命周期" tabindex="-1"><a class="header-anchor" href="#_8-2-3-生命周期"><span>8.2.3 生命周期</span></a></h3><h2 id="_8-3-配置存储" tabindex="-1"><a class="header-anchor" href="#_8-3-配置存储"><span>8.3 配置存储</span></a></h2><h3 id="_8-3-1-configmap" tabindex="-1"><a class="header-anchor" href="#_8-3-1-configmap"><span>8.3.1 ConfigMap</span></a></h3><p>ConfigMap是一种比较特殊的存储卷，它的主要作用是用来存储配置信息的。</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span># pc-configmap.yaml</span></span>
<span class="line"><span>apiVersion: v1</span></span>
<span class="line"><span>kind: ConfigMap</span></span>
<span class="line"><span>metadata:</span></span>
<span class="line"><span>  name: configmap</span></span>
<span class="line"><span>  namespace: dev</span></span>
<span class="line"><span>data:</span></span>
<span class="line"><span>  info: |</span></span>
<span class="line"><span>    username:admin</span></span>
<span class="line"><span>    password:123456</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span># 创建configmap</span></span>
<span class="line"><span>sudo kubectl create -f pc-configmap.yaml</span></span>
<span class="line"><span># 查看configmap详情</span></span>
<span class="line"><span>sudo kubectl describe cm configmap -n dev</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span># pod-configmap.yaml</span></span>
<span class="line"><span>apiVersion: v1</span></span>
<span class="line"><span>kind: Pod</span></span>
<span class="line"><span>metadata:</span></span>
<span class="line"><span>  name: pod-configmap</span></span>
<span class="line"><span>  namespace: dev</span></span>
<span class="line"><span>spec:</span></span>
<span class="line"><span>  containers:</span></span>
<span class="line"><span>  - name: nginx</span></span>
<span class="line"><span>    image: nginx:1.17.1</span></span>
<span class="line"><span>    volumeMounts: # 将configmap挂载到目录</span></span>
<span class="line"><span>    - name: config</span></span>
<span class="line"><span>      mountPath: /configmap/config</span></span>
<span class="line"><span>  volumes: # 引用configmap</span></span>
<span class="line"><span>  - name: config</span></span>
<span class="line"><span>    configMap:</span></span>
<span class="line"><span>      name: configmap</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span># 创建pod</span></span>
<span class="line"><span>sudo kubectl create -f pod-configmap.yaml</span></span>
<span class="line"><span># 查看pod</span></span>
<span class="line"><span>kubectl get pod pod-configmap -n dev</span></span>
<span class="line"><span>#进入容器</span></span>
<span class="line"><span>sudo kubectl exec -it pod-configmap -n dev /bin/sh</span></span>
<span class="line"><span>cd /configmap/config/</span></span>
<span class="line"><span>ls</span></span>
<span class="line"><span>cat info</span></span>
<span class="line"><span># info</span></span>
<span class="line"><span>username:admin</span></span>
<span class="line"><span>password:123456</span></span>
<span class="line"><span># 可以看到映射已经成功，每个configmap都映射成了一个目录</span></span>
<span class="line"><span># key---&gt;文件     value----&gt;文件中的内容</span></span>
<span class="line"><span># 此时如果更新configmap的内容, 容器中的值也会动态更新</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_8-3-2-secret" tabindex="-1"><a class="header-anchor" href="#_8-3-2-secret"><span>8.3.2 Secret</span></a></h3><p>在kubernetes中，还存在一种和ConfigMap非常类似的对象，称为Secret对象。它主要用于存储敏感信息，例如密码、秘钥、证书等等。</p><ol><li>首先使用base64对数据进行编码</li></ol><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>echo -n &#39;admin&#39; | base64 #准备username</span></span>
<span class="line"><span># YWRtaW4=</span></span>
<span class="line"><span>echo -n &#39;123456&#39; | base64 #准备password</span></span>
<span class="line"><span># MTIzNDU2</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol><li>接下来编写secret.yaml，并创建Secret</li></ol><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>apiVersion: v1</span></span>
<span class="line"><span>kind: Secret</span></span>
<span class="line"><span>metadata:</span></span>
<span class="line"><span>  name: secret</span></span>
<span class="line"><span>  namespace: dev</span></span>
<span class="line"><span>type: Opaque</span></span>
<span class="line"><span>data:</span></span>
<span class="line"><span>  username: YWRtaW4=</span></span>
<span class="line"><span>  password: MTIzNDU2</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span># 创建secret</span></span>
<span class="line"><span>kubectl create -f secret.yaml</span></span>
<span class="line"><span># 查看secret详情</span></span>
<span class="line"><span>kubectl describe secret secret -n dev</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol><li>创建pod-secret.yaml，将上面创建的secret挂载进去：</li></ol><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>apiVersion: v1</span></span>
<span class="line"><span>kind: Pod</span></span>
<span class="line"><span>metadata:</span></span>
<span class="line"><span>  name: pod-secret</span></span>
<span class="line"><span>  namespace: dev</span></span>
<span class="line"><span>spec:</span></span>
<span class="line"><span>  containers:</span></span>
<span class="line"><span>  - name: nginx</span></span>
<span class="line"><span>    image: nginx:1.17.1</span></span>
<span class="line"><span>    volumeMounts: # 将secret挂载到目录</span></span>
<span class="line"><span>    - name: config</span></span>
<span class="line"><span>      mountPath: /secret/config</span></span>
<span class="line"><span>  volumes:</span></span>
<span class="line"><span>  - name: config</span></span>
<span class="line"><span>    secret:</span></span>
<span class="line"><span>      secretName: secret</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span># 创建pod</span></span>
<span class="line"><span>kubectl create -f pod-secret.yaml</span></span>
<span class="line"><span># 查看pod</span></span>
<span class="line"><span>kubectl get pod pod-secret -n dev</span></span>
<span class="line"><span># 进入容器，查看secret信息，发现已经自动解码了</span></span>
<span class="line"><span>kubectl exec -it pod-secret /bin/sh -n dev</span></span>
<span class="line"><span>ls /secret/config/</span></span>
<span class="line"><span># password  username</span></span>
<span class="line"><span>more /secret/config/username</span></span>
<span class="line"><span># admin</span></span>
<span class="line"><span>more /secret/config/password</span></span>
<span class="line"><span># 123456</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>至此，已经实现了利用secret实现了信息的编码。</p><h1 id="_9-安全认证" tabindex="-1"><a class="header-anchor" href="#_9-安全认证"><span>9. 安全认证</span></a></h1><h2 id="_9-1-访问控制概述" tabindex="-1"><a class="header-anchor" href="#_9-1-访问控制概述"><span>9.1 访问控制概述</span></a></h2><p>Kubernetes作为一个分布式集群的管理工具，保证集群的安全性是其一个重要的任务。所谓的安全性其实就是保证对Kubernetes的各种<strong>客户端</strong>进行<strong>认证和鉴权</strong>操作。</p><p><strong>客户端</strong></p><p>在Kubernetes集群中，客户端通常有两类：</p><ul><li><p><strong>User Account</strong>：一般是独立于kubernetes之外的其他服务管理的用户账号。</p></li><li><p><strong>Service Account</strong>：kubernetes管理的账号，用于为Pod中的服务进程在访问Kubernetes时提供身份标识。</p></li></ul><p><strong>认证、授权与准入控制</strong></p><p>ApiServer是访问及管理资源对象的唯一入口。任何一个请求访问ApiServer，都要经过下面三个流程：</p><ul><li><p>Authentication（认证）：身份鉴别，只有正确的账号才能够通过认证</p></li><li><p>Authorization（授权）： 判断用户是否有权限对访问的资源执行特定的动作</p></li><li><p>Admission Control（准入控制）：用于补充授权机制以实现更加精细的访问控制功能。</p></li></ul><h2 id="_9-2-证管理" tabindex="-1"><a class="header-anchor" href="#_9-2-证管理"><span>9.2 证管理</span></a></h2><p>Kubernetes集群安全的最关键点在于如何识别并认证客户端身份，它提供了3种客户端身份认证方式：</p><ul><li>HTTP Base认证：通过用户名+密码的方式认证</li></ul><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>这种认证方式是把“用户名:密码”用BASE64算法进行编码后的字符串放在HTTP请求中的Header Authorization域里发送给服务端。服务端收到后进行解码，获取用户名及密码，然后进行用户身份认证的过程。</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>HTTP Token认证：通过一个Token来识别合法用户</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>这种认证方式是用一个很长的难以被模仿的字符串--Token来表明客户身份的一种方式。每个Token对应一个用户名，当客户端发起API调用请求时，需要在HTTP Header里放入Token，API Server接到Token后会跟服务器中保存的token进行比对，然后进行用户身份认证的过程。</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>HTTPS证书认证：基于CA根证书签名的双向数字证书认证方式</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>这种认证方式是安全性最高的一种方式，但是同时也是操作起来最麻烦的一种方式。</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><strong>HTTPS认证大体分为3个过程：</strong></p><ol><li>证书申请和下发</li></ol><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>HTTPS通信双方的服务器向CA机构申请证书，CA机构下发根证书、服务端证书及私钥给申请者</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>客户端和服务端的双向认证</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>1&gt; 客户端向服务器端发起请求，服务端下发自己的证书给客户端，</span></span>
<span class="line"><span>     客户端接收到证书后，通过私钥解密证书，在证书中获得服务端的公钥，</span></span>
<span class="line"><span>     客户端利用服务器端的公钥认证证书中的信息，如果一致，则认可这个服务器</span></span>
<span class="line"><span>  2&gt; 客户端发送自己的证书给服务器端，服务端接收到证书后，通过私钥解密证书，</span></span>
<span class="line"><span>     在证书中获得客户端的公钥，并用该公钥认证证书信息，确认客户端是否合法</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>服务器端和客户端进行通信</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>服务器端和客户端协商好加密方案后，客户端会产生一个随机的秘钥并加密，然后发送到服务器端。</span></span>
<span class="line"><span>  服务器端接收这个秘钥后，双方接下来通信的所有内容都通过该随机秘钥加密</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>注意: Kubernetes允许同时配置多种认证方式，只要其中任意一个方式认证通过即可</p><h2 id="_9-3-授权管理" tabindex="-1"><a class="header-anchor" href="#_9-3-授权管理"><span>9.3 授权管理</span></a></h2><p>授权发生在认证成功之后，通过认证就可以知道请求用户是谁， 然后Kubernetes会根据事先定义的授权策略来决定用户是否有权限访问，这个过程就称为授权。</p><p>每个发送到ApiServer的请求都带上了用户和资源的信息：比如发送请求的用户、请求的路径、请求的动作等，授权就是根据这些信息和授权策略进行比较，如果符合策略，则认为授权通过，否则会返回错误。</p><p>API Server目前支持以下几种授权策略：</p><ul><li><p><strong>AlwaysDeny</strong>：表示拒绝所有请求，一般用于测试</p></li><li><p><strong>AlwaysAllow</strong>：允许接收所有请求，相当于集群不需要授权流程（Kubernetes默认的策略）</p></li><li><p><strong>ABAC</strong>：基于属性的访问控制，表示使用用户配置的授权规则对用户请求进行匹配和控制</p></li><li><p><strong>Webhook</strong>：通过调用外部REST服务对用户进行授权</p></li><li><p><strong>Node</strong>：是一种专用模式，用于对kubelet发出的请求进行访问控制</p></li><li><p><strong>RBAC</strong>：基于角色的访问控制（kubeadm安装方式下的默认选项）</p></li></ul><p>RBAC(Role-Based Access Control) 基于角色的访问控制，主要是在描述一件事情：<strong>给哪些对象授予了哪些权限</strong></p><p>其中涉及到了下面几个概念：</p><ul><li><p>对象：User、Groups、ServiceAccount</p></li><li><p>角色：代表着一组定义在资源上的可操作动作(权限)的集合</p></li><li><p>绑定：将定义好的角色跟用户绑定在一起</p></li></ul><p>RBAC引入了4个顶级资源对象：</p><ul><li><p>Role、ClusterRole：角色，用于指定一组权限</p></li><li><p>RoleBinding、ClusterRoleBinding：角色绑定，用于将角色（权限）赋予给对象</p></li></ul><p><strong>Role、ClusterRole</strong></p><p>一个角色就是一组权限的集合，这里的权限都是许可形式的（白名单）。</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span># Role只能对命名空间内的资源进行授权，需要指定nameapce</span></span>
<span class="line"><span>kind: Role</span></span>
<span class="line"><span>apiVersion: rbac.authorization.k8s.io/v1beta1</span></span>
<span class="line"><span>metadata:</span></span>
<span class="line"><span>  namespace: dev</span></span>
<span class="line"><span>  name: authorization-role</span></span>
<span class="line"><span>rules:</span></span>
<span class="line"><span>- apiGroups: [&quot;&quot;]  # 支持的API组列表,&quot;&quot; 空字符串，表示核心API群</span></span>
<span class="line"><span>  resources: [&quot;pods&quot;] # 支持的资源对象列表</span></span>
<span class="line"><span>  verbs: [&quot;get&quot;, &quot;watch&quot;, &quot;list&quot;] # 允许的对资源对象的操作方法列表</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span># ClusterRole可以对集群范围内资源、跨namespaces的范围资源、非资源类型进行授权</span></span>
<span class="line"><span>kind: ClusterRole</span></span>
<span class="line"><span>apiVersion: rbac.authorization.k8s.io/v1beta1</span></span>
<span class="line"><span>metadata:</span></span>
<span class="line"><span> name: authorization-clusterrole</span></span>
<span class="line"><span>rules:</span></span>
<span class="line"><span>- apiGroups: [&quot;&quot;]</span></span>
<span class="line"><span>  resources: [&quot;pods&quot;]</span></span>
<span class="line"><span>  verbs: [&quot;get&quot;, &quot;watch&quot;, &quot;list&quot;]</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>需要详细说明的是，rules中的参数：</p><ul><li>apiGroups: 支持的API组列表</li></ul><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>&quot;&quot;,&quot;apps&quot;, &quot;autoscaling&quot;, &quot;batch&quot;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>resources：支持的资源对象列表</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>&quot;services&quot;, &quot;endpoints&quot;, &quot;pods&quot;,&quot;secrets&quot;,&quot;configmaps&quot;,&quot;crontabs&quot;,&quot;deployments&quot;,&quot;jobs&quot;,</span></span>
<span class="line"><span>&quot;nodes&quot;,&quot;rolebindings&quot;,&quot;clusterroles&quot;,&quot;daemonsets&quot;,&quot;replicasets&quot;,&quot;statefulsets&quot;,</span></span>
<span class="line"><span>&quot;horizontalpodautoscalers&quot;,&quot;replicationcontrollers&quot;,&quot;cronjobs&quot;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>verbs：对资源对象的操作方法列表</li></ul><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>&quot;get&quot;, &quot;list&quot;, &quot;watch&quot;, &quot;create&quot;, &quot;update&quot;, &quot;patch&quot;, &quot;delete&quot;, &quot;exec&quot;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><strong>RoleBinding、ClusterRoleBinding</strong></p><p>角色绑定用来把一个角色绑定到一个目标对象上，绑定目标可以是User、Group或者ServiceAccount。</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span># RoleBinding可以将同一namespace中的subject绑定到某个Role下，则此subject即具有该Role定义的权限</span></span>
<span class="line"><span>kind: RoleBinding</span></span>
<span class="line"><span>apiVersion: rbac.authorization.k8s.io/v1beta1</span></span>
<span class="line"><span>metadata:</span></span>
<span class="line"><span>  name: authorization-role-binding</span></span>
<span class="line"><span>  namespace: dev</span></span>
<span class="line"><span>subjects:</span></span>
<span class="line"><span>- kind: User</span></span>
<span class="line"><span>  name: heima</span></span>
<span class="line"><span>  apiGroup: rbac.authorization.k8s.io</span></span>
<span class="line"><span>roleRef:</span></span>
<span class="line"><span>  kind: Role</span></span>
<span class="line"><span>  name: authorization-role</span></span>
<span class="line"><span>  apiGroup: rbac.authorization.k8s.io</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span># ClusterRoleBinding在整个集群级别和所有namespaces将特定的subject与ClusterRole绑定，授予权限</span></span>
<span class="line"><span>kind: ClusterRoleBinding</span></span>
<span class="line"><span>apiVersion: rbac.authorization.k8s.io/v1beta1</span></span>
<span class="line"><span>metadata:</span></span>
<span class="line"><span> name: authorization-clusterrole-binding</span></span>
<span class="line"><span>subjects:</span></span>
<span class="line"><span>- kind: User</span></span>
<span class="line"><span>  name: heima</span></span>
<span class="line"><span>  apiGroup: rbac.authorization.k8s.io</span></span>
<span class="line"><span>roleRef:</span></span>
<span class="line"><span>  kind: ClusterRole</span></span>
<span class="line"><span>  name: authorization-clusterrole</span></span>
<span class="line"><span>  apiGroup: rbac.authorization.k8s.io</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>RoleBinding引用ClusterRole进行授权</strong></p><p>RoleBinding可以引用ClusterRole，对属于同一命名空间内ClusterRole定义的资源主体进行授权。</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>一种很常用的做法就是，集群管理员为集群范围预定义好一组角色（ClusterRole），然后在多个命名空间中重复使用这些ClusterRole。这样可以大幅提高授权管理工作效率，也使得各个命名空间下的基础性授权规则与使用体验保持一致。</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span># 虽然authorization-clusterrole是一个集群角色，但是因为使用了RoleBinding</span></span>
<span class="line"><span># 所以heima只能读取dev命名空间中的资源</span></span>
<span class="line"><span>kind: RoleBinding</span></span>
<span class="line"><span>apiVersion: rbac.authorization.k8s.io/v1beta1</span></span>
<span class="line"><span>metadata:</span></span>
<span class="line"><span>  name: authorization-role-binding-ns</span></span>
<span class="line"><span>  namespace: dev</span></span>
<span class="line"><span>subjects:</span></span>
<span class="line"><span>- kind: User</span></span>
<span class="line"><span>  name: heima</span></span>
<span class="line"><span>  apiGroup: rbac.authorization.k8s.io</span></span>
<span class="line"><span>roleRef:</span></span>
<span class="line"><span>  kind: ClusterRole</span></span>
<span class="line"><span>  name: authorization-clusterrole</span></span>
<span class="line"><span>  apiGroup: rbac.authorization.k8s.io</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>实战：创建一个只能管理dev空间下Pods资源的账号</strong></p><ol><li>创建账号</li></ol><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span># 1) 创建证书</span></span>
<span class="line"><span>[root@k8s-master01 pki]# cd /etc/kubernetes/pki/</span></span>
<span class="line"><span>[root@k8s-master01 pki]# (umask 077;openssl genrsa -out devman.key 2048)</span></span>
<span class="line"><span></span></span>
<span class="line"><span># 2) 用apiserver的证书去签署</span></span>
<span class="line"><span># 2-1) 签名申请，申请的用户是devman,组是devgroup</span></span>
<span class="line"><span>[root@k8s-master01 pki]# openssl req -new -key devman.key -out devman.csr -subj &quot;/CN=devman/O=devgroup&quot;     </span></span>
<span class="line"><span># 2-2) 签署证书</span></span>
<span class="line"><span>[root@k8s-master01 pki]# openssl x509 -req -in devman.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out devman.crt -days 3650</span></span>
<span class="line"><span></span></span>
<span class="line"><span># 3) 设置集群、用户、上下文信息</span></span>
<span class="line"><span>[root@k8s-master01 pki]# kubectl config set-cluster kubernetes --embed-certs=true --certificate-authority=/etc/kubernetes/pki/ca.crt --server=https://192.168.109.100:6443</span></span>
<span class="line"><span></span></span>
<span class="line"><span>[root@k8s-master01 pki]# kubectl config set-credentials devman --embed-certs=true --client-certificate=/etc/kubernetes/pki/devman.crt --client-key=/etc/kubernetes/pki/devman.key</span></span>
<span class="line"><span></span></span>
<span class="line"><span>[root@k8s-master01 pki]# kubectl config set-context devman@kubernetes --cluster=kubernetes --user=devman</span></span>
<span class="line"><span></span></span>
<span class="line"><span># 切换账户到devman</span></span>
<span class="line"><span>[root@k8s-master01 pki]# kubectl config use-context devman@kubernetes</span></span>
<span class="line"><span>Switched to context &quot;devman@kubernetes&quot;.</span></span>
<span class="line"><span></span></span>
<span class="line"><span># 查看dev下pod，发现没有权限</span></span>
<span class="line"><span>[root@k8s-master01 pki]# kubectl get pods -n dev</span></span>
<span class="line"><span>Error from server (Forbidden): pods is forbidden: User &quot;devman&quot; cannot list resource &quot;pods&quot; in API group &quot;&quot; in the namespace &quot;dev&quot;</span></span>
<span class="line"><span></span></span>
<span class="line"><span># 切换到admin账户</span></span>
<span class="line"><span>[root@k8s-master01 pki]# kubectl config use-context kubernetes-admin@kubernetes</span></span>
<span class="line"><span>Switched to context &quot;kubernetes-admin@kubernetes&quot;.</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>2） 创建Role和RoleBinding，为devman用户授权</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>kind: Role</span></span>
<span class="line"><span>apiVersion: rbac.authorization.k8s.io/v1beta1</span></span>
<span class="line"><span>metadata:</span></span>
<span class="line"><span>  namespace: dev</span></span>
<span class="line"><span>  name: dev-role</span></span>
<span class="line"><span>rules:</span></span>
<span class="line"><span>- apiGroups: [&quot;&quot;]</span></span>
<span class="line"><span>  resources: [&quot;pods&quot;]</span></span>
<span class="line"><span>  verbs: [&quot;get&quot;, &quot;watch&quot;, &quot;list&quot;]</span></span>
<span class="line"><span>  </span></span>
<span class="line"><span>---</span></span>
<span class="line"><span></span></span>
<span class="line"><span>kind: RoleBinding</span></span>
<span class="line"><span>apiVersion: rbac.authorization.k8s.io/v1beta1</span></span>
<span class="line"><span>metadata:</span></span>
<span class="line"><span>  name: authorization-role-binding</span></span>
<span class="line"><span>  namespace: dev</span></span>
<span class="line"><span>subjects:</span></span>
<span class="line"><span>- kind: User</span></span>
<span class="line"><span>  name: devman</span></span>
<span class="line"><span>  apiGroup: rbac.authorization.k8s.io</span></span>
<span class="line"><span>roleRef:</span></span>
<span class="line"><span>  kind: Role</span></span>
<span class="line"><span>  name: dev-role</span></span>
<span class="line"><span>  apiGroup: rbac.authorization.k8s.io</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>[root@k8s-master01 pki]# kubectl create -f dev-role.yaml</span></span>
<span class="line"><span>role.rbac.authorization.k8s.io/dev-role created</span></span>
<span class="line"><span>rolebinding.rbac.authorization.k8s.io/authorization-role-binding created</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol><li>切换账户，再次验证</li></ol><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span># 切换账户到devman</span></span>
<span class="line"><span>[root@k8s-master01 pki]# kubectl config use-context devman@kubernetes</span></span>
<span class="line"><span>Switched to context &quot;devman@kubernetes&quot;.</span></span>
<span class="line"><span></span></span>
<span class="line"><span># 再次查看</span></span>
<span class="line"><span>[root@k8s-master01 pki]# kubectl get pods -n dev</span></span>
<span class="line"><span>NAME                                 READY   STATUS             RESTARTS   AGE</span></span>
<span class="line"><span>nginx-deployment-66cb59b984-8wp2k    1/1     Running            0          4d1h</span></span>
<span class="line"><span>nginx-deployment-66cb59b984-dc46j    1/1     Running            0          4d1h</span></span>
<span class="line"><span>nginx-deployment-66cb59b984-thfck    1/1     Running            0          4d1h</span></span>
<span class="line"><span></span></span>
<span class="line"><span># 为了不影响后面的学习,切回admin账户</span></span>
<span class="line"><span>[root@k8s-master01 pki]# kubectl config use-context kubernetes-admin@kubernetes</span></span>
<span class="line"><span>Switched to context &quot;kubernetes-admin@kubernetes&quot;.</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_9-4-准入控制" tabindex="-1"><a class="header-anchor" href="#_9-4-准入控制"><span>9.4 准入控制</span></a></h2><p>通过了前面的认证和授权之后，还需要经过准入控制处理通过之后，apiserver才会处理这个请求。</p><p>准入控制是一个可配置的控制器列表，可以通过在Api-Server上通过命令行设置选择执行哪些准入控制器：</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>--admission-control=NamespaceLifecycle,LimitRanger,ServiceAccount,PersistentVolumeLabel,</span></span>
<span class="line"><span>                      DefaultStorageClass,ResourceQuota,DefaultTolerationSeconds</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>只有当所有的准入控制器都检查通过之后，apiserver才执行该请求，否则返回拒绝。</p><p>当前可配置的Admission Control准入控制如下：</p><ul><li><p>AlwaysAdmit：允许所有请求</p></li><li><p>AlwaysDeny：禁止所有请求，一般用于测试</p></li><li><p>AlwaysPullImages：在启动容器之前总去下载镜像</p></li><li><p>DenyExecOnPrivileged：它会拦截所有想在Privileged Container上执行命令的请求</p></li><li><p>ImagePolicyWebhook：这个插件将允许后端的一个Webhook程序来完成admission controller的功能。</p></li><li><p>Service Account：实现ServiceAccount实现了自动化</p></li><li><p>SecurityContextDeny：这个插件将使用SecurityContext的Pod中的定义全部失效</p></li><li><p>ResourceQuota：用于资源配额管理目的，观察所有请求，确保在namespace上的配额不会超标</p></li><li><p>LimitRanger：用于资源限制管理，作用于namespace上，确保对Pod进行资源限制</p></li><li><p>InitialResources：为未设置资源请求与限制的Pod，根据其镜像的历史资源的使用情况进行设置</p></li><li><p>NamespaceLifecycle：如果尝试在一个不存在的namespace中创建资源对象，则该创建请求将被拒绝。当删除一个namespace时，系统将会删除该namespace中所有对象。</p></li><li><p>DefaultStorageClass：为了实现共享存储的动态供应，为未指定StorageClass或PV的PVC尝试匹配默认的StorageClass，尽可能减少用户在申请PVC时所需了解的后端存储细节</p></li><li><p>DefaultTolerationSeconds：这个插件为那些没有设置forgiveness<br> tolerations并具有notready:NoExecute和unreachable:NoExecute两种taints的Pod设置默认的“容忍”时间，为5min</p></li><li><p>PodSecurityPolicy：这个插件用于在创建或修改Pod时决定是否根据Pod的security context和可用的PodSecurityPolicy对Pod的安全策略进行控制</p></li></ul><h1 id="_10-dashboard" tabindex="-1"><a class="header-anchor" href="#_10-dashboard"><span>10. DashBoard</span></a></h1><p>之前在kubernetes中完成的所有操作都是通过命令行工具kubectl完成的。其实，为了提供更丰富的用户体验，kubernetes还开发了一个基于web的用户界面（Dashboard）。用户可以使用Dashboard部署容器化的应用，还可以监控应用的状态，执行故障排查以及管理kubernetes中各种资源。</p><h2 id="_10-1-部署dashboard" tabindex="-1"><a class="header-anchor" href="#_10-1-部署dashboard"><span>10.1 部署Dashboard</span></a></h2><ol><li>下载yaml，并运行Dashboard</li></ol><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span># 下载yaml</span></span>
<span class="line"><span>[root@k8s-master01 ~]# wget  https://raw.githubusercontent.com/kubernetes/dashboard/v2.0.0/aio/deploy/recommended.yaml</span></span>
<span class="line"><span></span></span>
<span class="line"><span># 修改kubernetes-dashboard的Service类型</span></span>
<span class="line"><span>kind: Service</span></span>
<span class="line"><span>apiVersion: v1</span></span>
<span class="line"><span>metadata:</span></span>
<span class="line"><span>  labels:</span></span>
<span class="line"><span>    k8s-app: kubernetes-dashboard</span></span>
<span class="line"><span>  name: kubernetes-dashboard</span></span>
<span class="line"><span>  namespace: kubernetes-dashboard</span></span>
<span class="line"><span>spec:</span></span>
<span class="line"><span>  type: NodePort  # 新增</span></span>
<span class="line"><span>  ports:</span></span>
<span class="line"><span>    - port: 443</span></span>
<span class="line"><span>      targetPort: 8443</span></span>
<span class="line"><span>      nodePort: 30009  # 新增</span></span>
<span class="line"><span>  selector:</span></span>
<span class="line"><span>    k8s-app: kubernetes-dashboard</span></span>
<span class="line"><span></span></span>
<span class="line"><span># 部署</span></span>
<span class="line"><span>[root@k8s-master01 ~]# kubectl create -f recommended.yaml</span></span>
<span class="line"><span></span></span>
<span class="line"><span># 查看namespace下的kubernetes-dashboard下的资源</span></span>
<span class="line"><span>[root@k8s-master01 ~]# kubectl get pod,svc -n kubernetes-dashboard</span></span>
<span class="line"><span>NAME                                            READY   STATUS    RESTARTS   AGE</span></span>
<span class="line"><span>pod/dashboard-metrics-scraper-c79c65bb7-zwfvw   1/1     Running   0          111s</span></span>
<span class="line"><span>pod/kubernetes-dashboard-56484d4c5-z95z5        1/1     Running   0          111s</span></span>
<span class="line"><span></span></span>
<span class="line"><span>NAME                               TYPE       CLUSTER-IP      EXTERNAL-IP  PORT(S)         AGE</span></span>
<span class="line"><span>service/dashboard-metrics-scraper  ClusterIP  10.96.89.218    &lt;none&gt;       8000/TCP        111s</span></span>
<span class="line"><span>service/kubernetes-dashboard       NodePort   10.104.178.171  &lt;none&gt;       443:30009/TCP   111s</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>2）创建访问账户，获取token</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span># 创建账号</span></span>
<span class="line"><span>[root@k8s-master01-1 ~]# kubectl create serviceaccount dashboard-admin -n kubernetes-dashboard</span></span>
<span class="line"><span></span></span>
<span class="line"><span># 授权</span></span>
<span class="line"><span>[root@k8s-master01-1 ~]# kubectl create clusterrolebinding dashboard-admin-rb --clusterrole=cluster-admin --serviceaccount=kubernetes-dashboard:dashboard-admin</span></span>
<span class="line"><span></span></span>
<span class="line"><span># 获取账号token</span></span>
<span class="line"><span>[root@k8s-master01 ~]#  kubectl get secrets -n kubernetes-dashboard | grep dashboard-admin</span></span>
<span class="line"><span>dashboard-admin-token-xbqhh        kubernetes.io/service-account-token   3      2m35s</span></span>
<span class="line"><span></span></span>
<span class="line"><span>[root@k8s-master01 ~]# kubectl describe secrets dashboard-admin-token-xbqhh -n kubernetes-dashboard</span></span>
<span class="line"><span>Name:         dashboard-admin-token-xbqhh</span></span>
<span class="line"><span>Namespace:    kubernetes-dashboard</span></span>
<span class="line"><span>Labels:       &lt;none&gt;</span></span>
<span class="line"><span>Annotations:  kubernetes.io/service-account.name: dashboard-admin</span></span>
<span class="line"><span>              kubernetes.io/service-account.uid: 95d84d80-be7a-4d10-a2e0-68f90222d039</span></span>
<span class="line"><span></span></span>
<span class="line"><span>Type:  kubernetes.io/service-account-token</span></span>
<span class="line"><span></span></span>
<span class="line"><span>Data</span></span>
<span class="line"><span>====</span></span>
<span class="line"><span>namespace:  20 bytes</span></span>
<span class="line"><span>token:      eyJhbGciOiJSUzI1NiIsImtpZCI6ImJrYkF4bW5XcDhWcmNGUGJtek5NODFuSXl1aWptMmU2M3o4LTY5a2FKS2cifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlcm5ldGVzLWRhc2hib2FyZCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJkYXNoYm9hcmQtYWRtaW4tdG9rZW4teGJxaGgiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC5uYW1lIjoiZGFzaGJvYXJkLWFkbWluIiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQudWlkIjoiOTVkODRkODAtYmU3YS00ZDEwLWEyZTAtNjhmOTAyMjJkMDM5Iiwic3ViIjoic3lzdGVtOnNlcnZpY2VhY2NvdW50Omt1YmVybmV0ZXMtZGFzaGJvYXJkOmRhc2hib2FyZC1hZG1pbiJ9.NAl7e8ZfWWdDoPxkqzJzTB46sK9E8iuJYnUI9vnBaY3Jts7T1g1msjsBnbxzQSYgAG--cV0WYxjndzJY_UWCwaGPrQrt_GunxmOK9AUnzURqm55GR2RXIZtjsWVP2EBatsDgHRmuUbQvTFOvdJB4x3nXcYLN2opAaMqg3rnU2rr-A8zCrIuX_eca12wIp_QiuP3SF-tzpdLpsyRfegTJZl6YnSGyaVkC9id-cxZRb307qdCfXPfCHR_2rt5FVfxARgg_C0e3eFHaaYQO7CitxsnIoIXpOFNAR8aUrmopJyODQIPqBWUehb7FhlU1DCduHnIIXVC_UICZ-MKYewBDLw</span></span>
<span class="line"><span>ca.crt:     1025 bytes</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>3）通过浏览器访问Dashboard的UI</p><p>在登录页面上输入上面的token</p><p>出现下面的页面代表成功</p><h2 id="_10-2-使用dashboard" tabindex="-1"><a class="header-anchor" href="#_10-2-使用dashboard"><span>10.2 使用DashBoard</span></a></h2><p>本章节以Deployment为例演示DashBoard的使用</p><p><strong>查看</strong></p><p>选择指定的命名空间dev，然后点击Deployments，查看dev空间下的所有deployment</p><p><strong>扩缩容</strong><br> 在Deployment上点击规模，然后指定目标副本数量，点击确定</p><p><strong>编辑</strong><br> 在Deployment上点击编辑，然后修改yaml文件，点击确定</p><p><strong>查看Pod</strong><br> 点击Pods, 查看pods列表</p><p><strong>操作Pod</strong><br> 选中某个Pod，可以对其执行日志（logs）、进入执行（exec）、编辑、删除操作</p><p>Dashboard提供了kubectl的绝大部分功能</p></div><!----><footer class="vp-page-meta"><div class="vp-meta-item edit-link"><a class="auto-link external-link vp-meta-label" href="https://github.com/justdoitMr//edit/master/themeHope/ContainerCloud/k8s/act_two_k8s基础学习.md" aria-label="在 GitHub 上编辑此页" rel="noopener noreferrer" target="_blank"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon edit-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="edit icon" name="edit"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></svg><!--]-->在 GitHub 上编辑此页<!----></a></div><div class="vp-meta-item git-info"><div class="update-time"><span class="vp-meta-label">上次编辑于: </span><!----></div><div class="contributors"><span class="vp-meta-label">贡献者: </span><!--[--><!--[--><span class="vp-meta-info" title="email: 2284609302@qq.com">不爱打代码的程序员</span><!--]--><!--]--></div></div></footer><nav class="vp-page-nav"><a class="route-link auto-link prev" href="/ContainerCloud/k8s/act_none_pod%E5%BC%82%E5%B8%B8%E7%8A%B6%E6%80%81%E6%8E%92%E6%9F%A5.html" aria-label="2、Pod异常状态排错"><div class="hint"><span class="arrow start"></span>上一页</div><div class="link"><span class="font-icon icon iconfont icon-file" style=""></span>2、Pod异常状态排错</div></a><!----></nav><!----><!----><!--]--></main><!--]--><footer class="vp-footer-wrapper"><div class="vp-footer">云原生</div><div class="vp-copyright">bugcode</div></footer></div><!--]--><!--[--><!----><!----><!--]--><!--]--></div>
    <script src="/assets/js/runtime~app.21e21f5e.js" defer></script><script src="/assets/js/9547.c8ff98a9.js" defer></script><script src="/assets/js/app.40c417f0.js" defer></script>
  </body>
</html>
